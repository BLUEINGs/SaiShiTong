(function(){"use strict";var e={1981:function(e,t,s){function i(e,t="YYYY-MM-DD"){if(!e)return"";if("string"===typeof e&&(e=new Date(e)),!(e instanceof Date))return"";const s=(e,t=2)=>String(e).padStart(t,"0"),i=e.getFullYear(),a=s(e.getMonth()+1),r=s(e.getDate()),n=s(e.getHours()),o=s(e.getMinutes()),l=s(e.getSeconds());return t.replace("YYYY",i).replace("MM",a).replace("DD",r).replace("HH",n).replace("mm",o).replace("ss",l)}s.d(t,{Y:function(){return i}})},3603:function(e,t,s){function i(e,t){e&&(localStorage.setItem("token",e[0]),localStorage.setItem("tokenExpire",e[1])),t&&localStorage.setItem("userInfo",JSON.stringify(t))}s.d(t,{YQ:function(){return i}})},5720:function(e,t,s){s.d(t,{A:function(){return n}});var i=s(4335),a=s(3603);const r=i.A.create({timeout:5e3});function n(e){return r(e)}r.interceptors.request.use((e=>{const t=localStorage.getItem("baseURL")||"http://8.140.62.7:8080";e.baseURL=t;const s=localStorage.getItem("token");if(s)e.headers["token"]=s;else{const t=localStorage.getItem("currentSmId");t&&(e.headers["SmId"]=t)}return e}),(e=>(console.error("请求错误:",e),Promise.reject(e)))),r.interceptors.response.use((e=>{const t=e.data;if(t.verify&&t.myInfo&&(0,a.YQ)(t[0],t[1]),0===t.code&&"NO_SM_ID"===t.message){const e=s(1052).Message;e({message:t.data,type:"warning",duration:5e3,showClose:!0});const i=window.location.pathname;return i.startsWith("/user-profile")||i.startsWith("/sport-meetings")||(window.location.href="/"),Promise.reject(new Error(t.data))}if(0===t.code&&"EXPIRED_LOGIN"===t.message){const e=s(1052).Message;return localStorage.removeItem("token"),localStorage.removeItem("tokenExpire"),e({message:t.data,type:"warning",duration:5e3,showClose:!0}),window.location.href=`/login?error=${encodeURIComponent(t.data)}`,Promise.reject(new Error(t.data))}if(0===t.code&&""===t.message){const e=s(1052).Message;return e({message:t.data,type:"error",duration:5e3,showClose:!0}),Promise.reject(new Error(t.data))}return t}),(e=>(console.error("响应错误:",e),Promise.reject(e))))},6208:function(e,t,s){s.d(t,{A:function(){return d}});var i=function(){var e=this,t=e._self._c;return e.visible?t("div",{staticClass:"dialog-wrapper",style:{zIndex:e.computedStyle.zIndex}},[e.useGlobalMask?t("div",{staticClass:"dialog-mask",on:{click:e.handleWrapperClick}}):e._e(),t("div",{ref:"dialogEl",staticClass:"dialog",class:{mobile:e.isMobile},style:e.computedStyle},[e.isMobile?t("div",{staticClass:"drag-handle",on:{mousedown:e.startDrag,touchstart:e.startDrag}},[t("div",{staticClass:"drag-indicator"})]):e._e(),t("div",{staticClass:"dialog-header"},[t("h3",{staticClass:"title"},[e._v(e._s(e.title))]),t("div",{staticClass:"header-actions"},[e.isMobile&&!e.hasFooterSlot?[t("button",{staticClass:"btn btn-confirm header-confirm",on:{click:e.handleConfirm}},[e._v(" "+e._s(e.confirmText)+" ")])]:t("button",{staticClass:"close-btn",on:{click:e.handleClose}},[e._v("×")])],2)]),t("div",{staticClass:"dialog-body",class:{"has-footer":!e.hasFooterSlot&&!e.isMobile&&!e.hideDefaultFooter}},[e._t("default"),e.hasFooterSlot?[t("div",{staticClass:"custom-footer"},[e._t("footer")],2)]:e._e()],2),e.isMobile||e.hasFooterSlot||e.hideDefaultFooter?e._e():t("div",{staticClass:"dialog-footer"},[t("button",{staticClass:"btn btn-cancel",on:{click:e.handleCancel}},[e._v(e._s(e.cancelText))]),t("button",{staticClass:"btn btn-confirm",on:{click:e.handleConfirm}},[t("span",{staticClass:"confirm-text"},[e._v(e._s(e.confirmText))]),t("i",{staticClass:"el-icon-circle-check"})])])])]):e._e()},a=[];let r=0;var n={name:"ResponsiveDialog",props:{visible:{type:Boolean,default:!1},title:{type:String,default:""},width:{type:String,default:"500px"},hideDefaultFooter:{type:Boolean,default:!1},cancelText:{type:String,default:"取消"},confirmText:{type:String,default:"确定"},closeOnClickMask:{type:Boolean,default:!0},zIndex:{type:Number,default:0},useGlobalMask:{type:Boolean,default:!0}},data(){return{isMobile:!1,dragStart:null,initialY:null,currentY:0,currentZIndex:0,dialogLevel:0}},computed:{hasFooterSlot(){return!!this.$slots.footer},dialogStyle(){return this.isMobile?{}:{width:this.width}},computedStyle(){const e=this.dialogStyle||{},t=1e3,s=this.zIndex||t+10*this.dialogLevel;return{...e,zIndex:s}}},methods:{handleClose(){this.$emit("update:visible",!1),this.$emit("close")},handleCancel(){this.$emit("cancel"),this.handleClose()},handleConfirm(){this.$emit("confirm")},handleWrapperClick(){this.closeOnClickMask&&this.handleClose()},checkDevice(){this.isMobile=window.innerWidth<=768},startDrag(e){if(!this.isMobile)return;const t=e.touches?e.touches[0]:e;this.dragStart=t.clientY,this.initialY=this.currentY,document.addEventListener("mousemove",this.onDrag),document.addEventListener("mouseup",this.stopDrag),document.addEventListener("touchmove",this.onDrag),document.addEventListener("touchend",this.stopDrag)},onDrag(e){if(!this.dragStart)return;const t=e.touches?e.touches[0]:e,s=t.clientY,i=s-this.dragStart;i>0&&(this.currentY=this.initialY+i,this.$refs.dialogEl.style.transform=`translateY(${this.currentY}px)`)},stopDrag(){this.currentY>100?this.handleClose():(this.currentY=0,this.$refs.dialogEl.style.transform=""),this.dragStart=null,this.initialY=null,document.removeEventListener("mousemove",this.onDrag),document.removeEventListener("mouseup",this.stopDrag),document.removeEventListener("touchmove",this.onDrag),document.removeEventListener("touchend",this.stopDrag)},updateZIndex(){this.$nextTick((()=>{this.$el&&this.visible&&this.$el.style.setProperty("--dialog-z-index",this.computedStyle.zIndex)}))}},watch:{visible(e){e?(r++,this.dialogLevel=r,document.body.style.overflow="hidden",this.updateZIndex()):(r--,0===r&&(document.body.style.overflow=""))},computedStyle:{deep:!0,handler(){this.visible&&this.updateZIndex()}}},mounted(){this.checkDevice(),window.addEventListener("resize",this.checkDevice)},beforeDestroy(){window.removeEventListener("resize",this.checkDevice),document.removeEventListener("mousemove",this.onDrag),document.removeEventListener("mouseup",this.stopDrag),document.removeEventListener("touchmove",this.onDrag),document.removeEventListener("touchend",this.stopDrag)}},o=n,l=s(1656),c=(0,l.A)(o,i,a,!1,null,"c8fc8150",null),d=c.exports},8778:function(e,t,s){var i=s(5471),a=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[e.mobileMenuVisible?t("div",{staticClass:"mobile-overlay",on:{click:e.closeMobileMenu}}):e._e(),e.$route.meta.noNav?[t("router-view")]:[e.shouldShowSideNav?[t("div",{staticClass:"layout-container",class:{collapsed:e.isCollapsed&&!e.isMobile,mobile:e.isMobile,"menu-visible":e.mobileMenuVisible}},[t("top-title",{attrs:{"should-show-side-nav":e.shouldShowSideNav},on:{"toggle-sidebar":e.toggleMobileMenu}}),t("div",{staticClass:"side-nav"},[e.isMobile?t("div",{staticClass:"collapse-btn",on:{click:e.closeMobileMenu}},[t("i",{staticClass:"el-icon-close"})]):t("div",{staticClass:"collapse-btn",on:{click:e.toggleCollapse}},[t("i",{class:e.isCollapsed?"el-icon-s-unfold":"el-icon-s-fold"})]),t("el-menu",{staticClass:"side-menu",attrs:{"default-active":e.$route.path,collapse:e.isCollapsed&&!e.isMobile},on:{select:e.handleMenuSelect}},[e._l(e.filteredRoutes,(function(s,i){return[s.divider?[t("el-divider",{key:"divider"+i})]:[t("router-link",{key:s.path,attrs:{to:s.path}},[t("el-menu-item",{attrs:{index:s.path}},[t("i",{class:s.icon}),t("span",{attrs:{slot:"title"},domProps:{innerHTML:e._s(s.title)},slot:"title"})])],1)]]})),t("el-menu-item",{attrs:{index:"logout"},on:{click:e.handleLogout}},[t("i",{staticClass:"el-icon-switch-button"}),t("span",{attrs:{slot:"title"},slot:"title"},[e._v("退出登录")])])],2)],1),t("div",{staticClass:"main-content"},[t("router-view")],1)],1)]:[t("top-title",{attrs:{"should-show-side-nav":e.shouldShowSideNav},on:{"toggle-sidebar":e.toggleMobileMenu}}),t("top-navbar"),t("div",{staticClass:"main-content-full"},[t("router-view")],1)]]],2)},r=[],n=(s(4114),s(8111),s(2489),s(3579),function(){var e=this,t=e._self._c;return t("div",[e.isMobile?t("div",{staticClass:"mobile-navbar"},[t("el-menu",{attrs:{"default-active":e.$route.path,mode:"horizontal"},on:{select:e.handleSelect}},[t("el-menu-item",{attrs:{index:"/"}},[t("i",{staticClass:"el-icon-house"}),t("span",[e._v("主页")])]),!e.userPowerDegree.includes(3)||e.userPowerDegree.includes(4)&&e.userPowerDegree.includes(1)?t("el-menu-item",{attrs:{index:"/department-management"}},[t("i",{staticClass:"el-icon-user-solid"}),t("span",[e._v("团体")])]):e._e(),!e.userPowerDegree.includes(3)||e.userPowerDegree.includes(4)&&e.userPowerDegree.includes(1)?t("el-menu-item",{attrs:{index:"/sports-management"}},[t("i",{staticClass:"el-icon-data-analysis"}),t("span",[e._v("项目")])]):e._e(),e.userPowerDegree.includes(3)?t("el-menu-item",{attrs:{index:"/judge-management"}},[t("i",{staticClass:"el-icon-stopwatch"}),t("span",[e._v("评分")])]):e._e(),t("el-menu-item",{attrs:{index:"/schedule-management"}},[t("i",{staticClass:"el-icon-date"}),t("span",[e._v("赛程")])]),t("el-menu-item",{attrs:{index:"/user-profile"}},[t("i",{staticClass:"el-icon-user"}),t("span",[e._v("我的")])])],1)],1):t("div",{staticClass:"top-navbar"},[t("div",{staticClass:"nav-content"},[t("el-menu",{attrs:{"default-active":e.$route.path,mode:"horizontal"},on:{select:e.handleSelect}},[t("el-menu-item",{attrs:{index:"/"}},[t("i",{staticClass:"el-icon-house"}),t("span",[e._v("主页")])]),t("el-menu-item",{attrs:{index:"/user-profile"}},[t("i",{staticClass:"el-icon-user"}),t("span",[e._v("我的")])]),t("el-menu-item",{attrs:{index:"/sport-meetings"}},[t("i",{staticClass:"el-icon-medal"}),t("span",[e._v("运动会广场")])]),t("el-menu-item",{attrs:{index:"/department-management"}},[t("i",{staticClass:"el-icon-user-solid"}),t("span",[e._v("团体")])]),t("el-menu-item",{attrs:{index:"/sports-management"}},[t("i",{staticClass:"el-icon-data-analysis"}),t("span",[e._v("项目")])]),e.userPowerDegree.includes(3)?t("el-menu-item",{attrs:{index:"/judge-management"}},[t("i",{staticClass:"el-icon-stopwatch"}),t("span",[e._v("评分")])]):e._e(),t("el-menu-item",{attrs:{index:"/schedule-management"}},[t("i",{staticClass:"el-icon-date"}),t("span",[e._v("赛程")])])],1),t("div",{staticClass:"user-info"},[t("el-popover",{attrs:{placement:"bottom-end",width:"280",trigger:"hover","popper-class":"user-popover-card",transition:"el-fade-in-linear"},model:{value:e.showUserPopover,callback:function(t){e.showUserPopover=t},expression:"showUserPopover"}},[e.isLoggedIn?[t("div",{staticClass:"user-popover"},[t("div",{staticClass:"user-header"},[t("el-avatar",{attrs:{size:60,src:e.userAvatar}},[e._v(e._s(e.userInfo.name?.charAt(0)))]),t("div",{staticClass:"user-details"},[t("div",{staticClass:"user-name"},[e._v(e._s(e.userInfo.name))]),t("div",{staticClass:"user-roles"},e._l(e.userInfo.userType,(function(s){return t("el-tag",{key:s,attrs:{size:"small",effect:"plain"}},[e._v(" "+e._s(e.getRoleLabel(s))+" ")])})),1)])],1),t("div",{staticClass:"divider"}),t("div",{staticClass:"user-actions"},[t("div",{staticClass:"action-item",on:{click:function(t){return e.$router.push("/user-profile")}}},[t("i",{staticClass:"el-icon-user"}),e._v(" 个人中心 ")]),t("div",{staticClass:"action-item logout-btn",on:{click:e.handleLogout}},[t("i",{staticClass:"el-icon-switch-button"}),e._v(" 退出登录 ")])])])]:[t("div",{staticClass:"user-popover"},[t("div",{staticClass:"not-logged-in"},[t("i",{staticClass:"el-icon-user-solid"}),t("p",[e._v("未登录")]),t("el-button",{attrs:{type:"text"},on:{click:e.goToLogin}},[e._v("点击登录")])],1)])],t("div",{staticClass:"user-trigger",attrs:{slot:"reference"},slot:"reference"},[t("el-avatar",{attrs:{size:32,src:e.userAvatar}},[e._v(" "+e._s(e.isLoggedIn?e.userInfo.name?.charAt(0):"游")+" ")]),e.isLoggedIn?t("span",{staticClass:"username"},[e._v(e._s(e.userInfo.name))]):e._e()],1)],2)],1)],1)])])}),o=[],l={name:"TopNavbar",data(){return{showUserPopover:!1,userInfo:JSON.parse(localStorage.getItem("userInfo")||"{}"),userPowerDegree:JSON.parse(localStorage.getItem("userInfo")||"{}").powerDegree||[],isMobile:!1}},computed:{isLoggedIn(){return!!this.userInfo.uid},userAvatar(){return this.userInfo.head||""},canShowSidebar(){return this.userPowerDegree.includes(2)||this.userPowerDegree.includes(5)},currentPageTitle(){const e={"/":"主页","/user-profile":"我的信息","/sport-meetings":"运动会广场","/staff-settings":"此运动会","/department-management":"团体管理","/sports-management":"项目管理","/judge-management":"裁判评分","/registration-record":"报名记录","/schedule-management":"赛程安排","/system-settings":"系统设置"};return e[this.$route.path]||""}},mounted(){this.checkDevice(),window.addEventListener("resize",this.checkDevice)},beforeDestroy(){window.removeEventListener("resize",this.checkDevice)},methods:{handleSelect(e){e&&e!==this.$route.path&&this.$router.push(e).catch((e=>{"NavigationDuplicated"!==e.name&&console.error("路由错误:",e)}))},getRoleLabel(e){const t={2:"团体负责人",3:"裁判",4:"运动员",5:"运动会操办者"};return t[e]||"用户"},handleLogout(){localStorage.removeItem("token"),localStorage.removeItem("expiredTime"),localStorage.removeItem("userInfo"),this.$router.push("/login")},goToLogin(){this.$router.push("/login")},checkDevice(){this.isMobile=window.innerWidth<=768},toggleSidebar(){this.$emit("toggle-sidebar")}}},c=l,d=s(1656),u=(0,d.A)(c,n,o,!1,null,"ad96219e",null),p=u.exports,m=function(){var e=this,t=e._self._c;return e.isMobile?t("div",{staticClass:"top-title"},[e.shouldShowSideNav?t("el-button",{staticClass:"menu-btn",attrs:{icon:"el-icon-menu"},on:{click:e.toggleSidebar}}):e._e(),t("span",{staticClass:"page-title"},[e._v(e._s(e.currentTitle))])],1):e._e()},h=[],g={name:"TopTitle",props:{shouldShowSideNav:{type:Boolean,default:!1}},data(){return{isMobile:window.innerWidth<=768}},computed:{currentTitle(){const e={"/":"主页","/user-profile":"我的信息","/sport-meetings":"运动会广场","/staff-settings":"此运动会","/department-management":"团体管理","/ai-web":"智能裁判（测试）","/sports-management":"项目管理","/judge-management":"裁判评分","/registration-record":"报名记录","/schedule-management":"赛程安排","/system-settings":"系统设置"};return e[this.$route.path]||""}},mounted(){window.addEventListener("resize",this.handleResize)},beforeDestroy(){window.removeEventListener("resize",this.handleResize)},methods:{handleResize(){this.isMobile=window.innerWidth<=768},toggleSidebar(){this.$emit("toggle-sidebar")}}},f=g,v=(0,d.A)(f,m,h,!1,null,"b1ff6c4a",null),y=v.exports;const b=[{path:"/",icon:"el-icon-house",title:"主页"},{path:"/user-profile",icon:"el-icon-user",title:"我的信息"},{path:"/sport-meetings",icon:"el-icon-medal",title:"运动会广场"},{divider:!0},{path:"/staff-settings",icon:"el-icon-s-custom",title:"此运动会",requireAdmin:!0},{divider:!0},{path:"/department-management",icon:"el-icon-user-solid",title:"团体管理"},{path:"/sports-management",icon:"el-icon-data-analysis",title:"项目管理"},{path:"/judge-management",icon:"el-icon-stopwatch",title:"裁判评分",requireAdmin:!1,requireJudgeOrAdmin:!0},{path:"/ai-web",icon:"el-icon-video-camera",title:'智能裁判<sup style="font-size:10px;color:#ff7a18;">β</sup>'},{path:"/schedule-management",icon:"el-icon-date",title:"赛程安排"},{divider:!0},{path:"/system-settings",icon:"el-icon-setting",title:"系统设置"}];var w={name:"App",components:{TopNavbar:p,TopTitle:y},data(){return{isCollapsed:!1,isMobile:window.innerWidth<=768,userPowerDegree:[],mobileMenuVisible:!1}},computed:{shouldShowSideNav(){return this.userPowerDegree.includes(2)||this.userPowerDegree.includes(5)},filteredRoutes(){return b.filter((e=>!!e.divider||!(e.requireAdmin&&!this.userPowerDegree.includes(5))&&!(e.requireJudgeOrAdmin&&!this.userPowerDegree.some((e=>[3,5].includes(e))))))}},watch:{$route:{immediate:!0,handler(){this.updateUserPowerDegree()}},mobileMenuVisible(e){document.body.style.overflow=e?"hidden":""}},methods:{toggleCollapse(){this.isMobile||(this.isCollapsed=!this.isCollapsed)},handleCollapseClick(){this.isMobile?this.mobileMenuVisible=!1:this.isCollapsed=!this.isCollapsed},handleMenuSelect(e){e!==this.$route.path&&("logout"!==e?this.$router.push(e).catch((e=>{"NavigationDuplicated"!==e.name&&"NavigationAborted"!==e.name&&console.error("导航错误:",e)})):this.handleLogout())},handleLogout(){localStorage.removeItem("token"),localStorage.removeItem("expiredTime"),localStorage.removeItem("userInfo"),this.$router.push("/login")},handleResize(){const e=!this.isMobile;this.isMobile=window.innerWidth<=768,this.isMobile||e||(this.isCollapsed=window.innerWidth<=1200),this.isMobile&&(this.mobileMenuVisible=!1)},updateUserPowerDegree(){try{const e=JSON.parse(localStorage.getItem("userInfo")||"{}");"string"===typeof e.powerDegree?this.userPowerDegree=JSON.parse(e.powerDegree||"[]"):Array.isArray(e.powerDegree)?this.userPowerDegree=e.powerDegree:this.userPowerDegree=[]}catch(e){console.error("解析用户权限失败:",e),this.userPowerDegree=[]}},toggleMobileMenu(){this.mobileMenuVisible=!this.mobileMenuVisible},closeMobileMenu(){this.isMobile&&(this.mobileMenuVisible=!1)},checkTokenExpiration(){const e=localStorage.getItem("expiredTime");if(e){const t=Date.now();t>Number(e)&&(localStorage.removeItem("token"),localStorage.removeItem("expiredTime"),localStorage.removeItem("userInfo"),"/login"!==this.$route.path&&(this.$message.warning("当前登录信息已过期"),this.$router.push("/login")))}}},mounted(){window.addEventListener("resize",this.handleResize),this.handleResize(),window.addEventListener("storage",(e=>{"userInfo"===e.key&&this.updateUserPowerDegree()}))},beforeDestroy(){window.removeEventListener("resize",this.handleResize)},created(){this.checkTokenExpiration(),setInterval(this.checkTokenExpiration,6e4),this.$router.onError((e=>{console.error("路由错误:",e),"NavigationCancelled"===e.name&&(console.warn("导航被取消"),this.$message({type:"info",message:"页面切换被中断，请稍后重试"}))}))}},S=w,C=(0,d.A)(S,a,r,!1,null,null,null),T=C.exports,D=s(173),_=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"department-management"},[e.localEditMode||e.isAthlete?t("div",{staticClass:"action-bar"},[t("div",{staticClass:"floating-buttons"},[e.localEditMode?t("el-button",{attrs:{type:"primary",icon:"el-icon-plus"},on:{click:e.handleAddSchool}},[e._v(" 添加团体 ")]):e._e(),e.isAthlete?t("el-button",{attrs:{type:"success",icon:"el-icon-plus"},on:{click:e.showJoinDialog}},[e._v(" 加入团体 ")]):e._e(),e.localEditMode?t("el-button",{attrs:{type:"primary",icon:"el-icon-setting",circle:""},on:{click:e.showConfig}}):e._e()],1)]):e._e(),t("transition-group",{staticClass:"school-grid",class:{"has-active":e.activeSchoolId},attrs:{name:"card-list",tag:"div"}},[e._l(e.schools,(function(s){return t("school-card",{key:s.id,attrs:{"school-data":s,"is-active":e.activeSchoolId===s.id,"is-edit-mode":e.localEditMode,"max-players":e.configForm.maxPlayers,"max-events":e.configForm.maxEvents,"level-config":e.configForm.levelConfig,loading:e.loadingDetail,"sport-events":e.sportEvents},on:{toggle:e.handleToggleSchool,success:e.handleSchoolSuccess,refresh:e.fetchSchools}})})),e.localEditMode?t("div",{key:"add",staticClass:"school-card",attrs:{add:""}},[t("div",{staticClass:"card-header",on:{click:e.handleAddSchool}},[t("div",{staticClass:"school-info"},[t("div",{staticClass:"title-content"},[t("h3",[e._v("添加团体")])])]),t("div",{staticClass:"school-image add-placeholder"},[t("i",{staticClass:"el-icon-plus"})])]),t("div",{staticClass:"card-content"},[t("school-dialog",{attrs:{visible:e.schoolDialogVisible,"is-edit":!1,"school-data":e.currentSchool,"level-config":e.configForm.levelConfig},on:{"update:visible":function(t){e.schoolDialogVisible=t},success:e.handleSchoolSuccess}})],1)]):e._e()],2),t("responsive-dialog",{attrs:{title:"参数配置",visible:e.configDialogVisible,width:"600px"},on:{"update:visible":function(t){e.configDialogVisible=t},confirm:e.saveConfig,cancel:function(t){e.configDialogVisible=!1}}},[t("el-form",{attrs:{model:e.configForm,"label-width":"120px"}},[t("el-form-item",{attrs:{label:"团体运动员上限"}},[t("el-input-number",{attrs:{min:1,max:10},model:{value:e.configForm.maxPlayers,callback:function(t){e.$set(e.configForm,"maxPlayers",t)},expression:"configForm.maxPlayers"}})],1),t("el-form-item",{attrs:{label:"个人限报项目"}},[t("el-input-number",{attrs:{min:1,max:5},model:{value:e.configForm.maxEvents,callback:function(t){e.$set(e.configForm,"maxEvents",t)},expression:"configForm.maxEvents"}}),t("span",{staticClass:"hint"},[e._v("每名运动员最多可报项目数")])],1),t("el-divider",[e._v("编号级别配置")]),e._l(e.configForm.levelConfig,(function(s,i){return t("div",{key:i,staticClass:"level-config-item"},[t("div",{staticClass:"level-header",on:{click:e.handleLevelHeaderClick}},[t("div",{staticClass:"level-info",on:{click:function(e){e.stopPropagation()}}},[t("el-input",{attrs:{placeholder:"如：学院",size:"small"},model:{value:s.field,callback:function(t){e.$set(s,"field",t)},expression:"level.field"}}),t("el-radio-group",{attrs:{size:"small"},model:{value:s.isNumeric,callback:function(t){e.$set(s,"isNumeric",t)},expression:"level.isNumeric"}},[t("el-radio",{attrs:{label:!0}},[e._v("纯数字")]),t("el-radio",{attrs:{label:!1}},[e._v("自定义")])],1)],1),t("div",{staticClass:"level-actions"},[t("el-button",{attrs:{type:"text",icon:s.isExpanded?"el-icon-arrow-up":"el-icon-arrow-down"}}),0!==i?t("el-button",{attrs:{type:"danger",icon:"el-icon-delete",circle:"",size:"mini"},on:{click:function(t){return t.stopPropagation(),e.removeLevelConfig(i)}}}):e._e()],1)]),t("div",{directives:[{name:"show",rawName:"v-show",value:s.isExpanded,expression:"level.isExpanded"}],staticClass:"level-content"},[s.isNumeric?[t("el-form-item",{attrs:{label:"位数限制"}},[t("el-input-number",{attrs:{min:1,max:4},model:{value:s.digits,callback:function(t){e.$set(s,"digits",t)},expression:"level.digits"}})],1)]:[t("div",{staticClass:"value-pairs"},[e._l(s.valuePairs,(function(s,a){return t("div",{key:a,staticClass:"value-pair"},[t("el-input",{attrs:{placeholder:"显示值",size:"small"},model:{value:s.label,callback:function(t){e.$set(s,"label",t)},expression:"pair.label"}}),t("el-input",{attrs:{placeholder:"实际值",size:"small"},model:{value:s.value,callback:function(t){e.$set(s,"value",t)},expression:"pair.value"}}),t("el-button",{attrs:{type:"danger",icon:"el-icon-delete",circle:"",size:"mini"},on:{click:function(t){return e.removeValuePair(i,a)}}})],1)})),t("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(t){return e.addValuePair(i)}}},[e._v(" 添加选项 ")])],2)]],2)])})),t("div",{staticClass:"add-level"},[t("el-button",{attrs:{type:"primary",icon:"el-icon-plus"},on:{click:e.addLevelConfig}},[e._v("添加级别")])],1)],2)],1),t("school-dialog",{attrs:{visible:e.schoolDialogVisible,"is-edit":e.isSchoolEdit,"school-data":e.currentSchool,"level-config":e.configForm.levelConfig},on:{"update:visible":function(t){e.schoolDialogVisible=t},success:e.handleSchoolSuccess,"validate-team-number":e.validateTeamNumber}}),t("el-dialog",{attrs:{title:"加入运动会",visible:e.joinDialogVisible,width:"400px"},on:{"update:visible":function(t){e.joinDialogVisible=t}}},[t("el-form",{ref:"joinForm",attrs:{model:e.joinForm,rules:e.joinRules}},[t("el-form-item",{attrs:{label:"邀请码",prop:"inviteCode"}},[t("el-input",{attrs:{placeholder:"请输入邀请码"},model:{value:e.joinForm.inviteCode,callback:function(t){e.$set(e.joinForm,"inviteCode",t)},expression:"joinForm.inviteCode"}})],1),t("div",{staticClass:"dialog-footer"},[t("el-button",{on:{click:function(t){e.joinDialogVisible=!1}}},[e._v("取消")]),t("el-button",{attrs:{type:"primary"},on:{click:e.handleJoin}},[e._v("确定")])],1)],1)],1)],1)},E=[],k=(s(1148),s(116),s(7588),s(1701),s(8237),s(7642),s(8004),s(3853),s(5876),s(2475),s(5024),s(1698),s(4603),s(7566),s(8721),function(){var e=this,t=e._self._c;return t("div",{staticClass:"school-card-container"},[t("div",{staticClass:"school-card",class:{"is-active":e.isActive}},[t("div",{staticClass:"card-header",on:{click:function(t){return e.$emit("toggle",e.localSchoolData.id)}}},[t("div",{staticClass:"school-info"},[t("div",{staticClass:"title-content"},[t("h3",[e._v(e._s(e.schoolName))]),t("p",{staticClass:"slogan"},[e._v(e._s(e.schoolSlogan))])])]),e.isEditMode?t("div",{staticClass:"actions"},[t("el-tooltip",{attrs:{content:"邀请加入该团体",placement:"top"}},[t("el-button",{attrs:{icon:"el-icon-user",type:"success",circle:""},on:{click:function(t){return t.stopPropagation(),e.handleInviteSchool.apply(null,arguments)}}})],1),t("el-button",{attrs:{icon:"el-icon-edit",circle:""},on:{click:function(t){return t.stopPropagation(),e.showEditDialog.apply(null,arguments)}}}),t("el-button",{attrs:{type:"danger",icon:"el-icon-delete",circle:""},on:{click:function(t){return t.stopPropagation(),e.handleDelete.apply(null,arguments)}}})],1):e._e(),t("img",{staticClass:"school-image",attrs:{src:e.schoolImage}})]),t("div",{directives:[{name:"show",rawName:"v-show",value:e.isActive,expression:"isActive"}],staticClass:"card-content"},[e.isShowScoreDetails?t("div",{staticClass:"score-details-panel"},[t("div",{staticClass:"panel-header"},[t("h3",[e._v(e._s(e.scoreDetailsTitle))]),t("el-button",{staticClass:"close-btn",attrs:{icon:"el-icon-close",circle:""},on:{click:e.closeScoreDetails}})],1),t("div",{staticClass:"score-details-content"},[t("el-table",{attrs:{data:e.currentScoreDetails,border:""}},[t("el-table-column",{attrs:{prop:"eventName",label:"比赛项目"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.formatEventName(t.row))+" ")]}}])}),t("el-table-column",{attrs:{prop:"athleteName",label:"运动员"}}),t("el-table-column",{attrs:{label:"成绩"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.formatScore(t.row.score))+" ")]}}])}),t("el-table-column",{attrs:{prop:"degree",label:"得分"}})],1)],1)]):t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"inner-wrapper"},[t("el-tabs",{model:{value:e.activeTab,callback:function(t){e.activeTab=t},expression:"activeTab"}},[t("el-tab-pane",{attrs:{label:"运动员",name:"athletes"}},[t("div",{staticClass:"athletes-list"},[e._l(e.sortedPlayers,(function(s){return t("div",{key:s.pid,staticClass:"athlete-item",class:{"is-leader":e.isLeader(s),"is-current-user":e.isCurrentUser(s)}},[t("div",{staticClass:"athlete-info"},[t("el-avatar",{attrs:{size:40,src:s.head||null}},[e._v(" "+e._s(s.name.charAt(0))+" ")]),t("div",{staticClass:"details"},[t("div",{staticClass:"name"},[e._v(" "+e._s(s.name)+" "),s.number?t("el-tag",{attrs:{size:"mini",type:"info"}},[e._v(" #"+e._s(s.number)+" ")]):e._e(),e.isLeader(s)?t("el-tag",{attrs:{size:"mini",type:"danger"}},[e._v("负责人")]):e._e(),e.isCurrentUser(s)?t("el-tag",{attrs:{size:"mini",type:"warning"}},[e._v("我")]):e._e()],1),e.isLeader(s)?e._e():t("div",{staticClass:"meta"},[t("span",[e._v("项目: "+e._s(e.getAthleteEvents(s)))])])])],1),e.isEditMode||e.isCurrentUser(s)?t("div",{staticClass:"actions"},[null===s.uid?t("el-tooltip",{attrs:{content:`邀请${s.name}注册`,placement:"top"}},[t("el-button",{attrs:{type:"success",icon:"el-icon-user",circle:""},on:{click:function(t){return e.handleInvitePlayer(s)}}})],1):e._e(),t("el-button",{attrs:{type:"primary",icon:"el-icon-edit",circle:""},on:{click:function(t){return e.handleEditPlayer(s)}}}),e.isCurrentUser(s)?e._e():t("el-button",{attrs:{type:"danger",icon:"el-icon-delete",circle:""},on:{click:function(t){return e.handleDeletePlayer(s)}}})],1):e._e()])})),e.isEditMode&&e.canAddMore?t("div",{staticClass:"action-buttons"},[e.isAdmin?[t("div",{staticClass:"add-button add-athlete",on:{click:e.handleAddPlayer}},[t("i",{staticClass:"el-icon-plus"}),t("span",[e._v("添加运动员")])]),t("div",{staticClass:"add-button add-leader",on:{click:e.handleAddLeader}},[t("i",{staticClass:"el-icon-plus"}),t("span",[e._v("添加负责人")])])]:t("div",{staticClass:"add-button add-athlete",on:{click:e.handleAddPlayer}},[t("i",{staticClass:"el-icon-plus"}),t("span",[e._v("添加运动员")])])],2):e._e(),e.hasCurrentUserRecord?t("div",{staticClass:"quit-school",on:{click:e.handleQuitSchool}},[t("i",{staticClass:"el-icon-warning"}),e._v(" 退出当前团体 ")]):e._e()],2)]),t("el-tab-pane",{attrs:{label:"得分情况",name:"scores"}},[t("div",{staticClass:"score-stats"},[t("div",{staticClass:"degree-item"},[t("h4",[e._v("团体总分")]),t("div",{staticClass:"score"},[e._v(e._s(e.formatDegree(e.detail?.totalDegree))+"分")]),t("el-button",{attrs:{type:"text"},on:{click:function(t){return e.showScoreDetails("all")}}},[e._v(" 查看详情 ")])],1),t("div",{staticClass:"degree-item"},[t("h4",[e._v("男子总分")]),t("div",{staticClass:"score"},[e._v(e._s(e.formatDegree(e.detail?.maleDegree))+"分")]),t("el-button",{attrs:{type:"text"},on:{click:function(t){return e.showScoreDetails("male")}}},[e._v(" 查看详情 ")])],1),t("div",{staticClass:"degree-item"},[t("h4",[e._v("女子总分")]),t("div",{staticClass:"score"},[e._v(e._s(e.formatDegree(e.detail?.femaleDegree))+"分")]),t("el-button",{attrs:{type:"text"},on:{click:function(t){return e.showScoreDetails("female")}}},[e._v(" 查看详情 ")])],1)])])],1)],1)])]),t("player-dialog",{attrs:{visible:e.playerDialogVisible,"is-edit":e.isEditingPlayer,"player-data":e.currentPlayer,"school-id":e.localSchoolData.id,"school-name":e.schoolName,"sport-events":e.sportEvents,"max-events":e.maxPlayerEvents},on:{"update:visible":function(t){e.playerDialogVisible=t},success:e.handlePlayerSuccess}}),t("school-dialog",{attrs:{visible:e.dialogVisible,"is-edit":!0,"school-data":e.localSchoolData,"level-config":e.levelConfig},on:{"update:visible":function(t){e.dialogVisible=t},success:e.handleEditSuccess}}),t("confirm-dialog",{attrs:{visible:e.showDeleteConfirm,title:"警告",message:"确定要删除该团体吗?","show-checkbox":!0,"checkbox-label":"同时删除该团体下所有运动员的团体身份"},on:{"update:visible":function(t){e.showDeleteConfirm=t},confirm:e.confirmDelete,cancel:function(t){e.showDeleteConfirm=!1}}}),t("base-dialog",{attrs:{title:"邀请码",visible:e.inviteDialogVisible,width:"400px"},on:{"update:visible":function(t){e.inviteDialogVisible=t}}},[t("div",{staticClass:"invite-content"},[t("p",[e._v("（有效期为3天）")]),t("p",{staticClass:"invite-code",class:{"is-existing":e.isExistingCode}},[e._v(e._s(e.inviteCode))]),t("p",[e._v("已复制到剪贴板，快去邀请"+e._s(e.inviteGender?"他":"她")+"吧")])])])],1)}),x=[],I=function(){var e=this,t=e._self._c;return t("responsive-dialog",{attrs:{title:e.isEdit?"编辑团体":"新增团体",visible:e.dialogVisible,width:"500px"},on:{"update:visible":function(t){e.dialogVisible=t},confirm:e.submitForm,cancel:function(t){return e.$emit("update:visible",!1)}}},[t("div",{staticClass:"dialog-body"},[t("el-form",{ref:"schoolForm",attrs:{model:e.schoolForm,"label-width":"80px",rules:e.rules}},[t("el-form-item",{attrs:{label:"团体名称",prop:"name"}},[t("el-input",{attrs:{placeholder:"请输入团体名称"},model:{value:e.schoolForm.name,callback:function(t){e.$set(e.schoolForm,"name",t)},expression:"schoolForm.name"}})],1),t("el-form-item",{attrs:{label:"团体级别",prop:"teamNumber"}},[t("multi-level-input",{attrs:{levels:e.levelConfig},on:{validate:e.handleTeamNumberValidate},model:{value:e.schoolForm.teamNumber,callback:function(t){e.$set(e.schoolForm,"teamNumber",t)},expression:"schoolForm.teamNumber"}})],1),t("el-form-item",{attrs:{label:"团体口号"}},[t("el-input",{staticClass:"slogan-input",attrs:{type:"textarea",rows:3,placeholder:"请输入团体口号"},model:{value:e.schoolForm.slogan,callback:function(t){e.$set(e.schoolForm,"slogan",t)},expression:"schoolForm.slogan"}})],1),t("el-form-item",{attrs:{label:"团体图片"}},[t("image-uploader",{attrs:{imageUrl:e.schoolForm.image},on:{"update:imageUrl":e.updateSchoolImage,"update:file":e.updateSchoolFile}})],1)],1)],1)])},$=[],F=s(6208),P=s(9417),A=function(){var e=this,t=e._self._c;return t("div",{staticClass:"multi-level-input"},[t("div",{staticClass:"input-container"},e._l(e.levels,(function(s){return t("div",{key:s.field,staticClass:"input-group"},[t("span",{staticClass:"level-label"},[e._v(" "+e._s(s.field)+e._s(s.isNumeric?"（数字）":"")+" ")]),t("div",{staticClass:"input-wrapper",class:{"is-error":e.errors[s.field]}},[s.isNumeric?[t("input",{staticClass:"numeric-input",class:{"is-error":e.errors[s.field]},attrs:{type:"text",placeholder:`请输入${s.field}`},domProps:{value:e.localValues[s.field]},on:{input:t=>e.handleNumericInput(s.field,t.target.value),blur:function(t){return e.validateField(s.field)}}})]:[t("div",{staticClass:"custom-select",class:{"is-active":s.isOpen,"is-error":e.errors[s.field]}},[t("div",{staticClass:"select-trigger",on:{click:function(t){return e.toggleSelect(s)}}},[e.localValues[s.field]?t("span",[e._v(" "+e._s(e.getDisplayValue(s,e.localValues[s.field]))+" ")]):t("span",{staticClass:"placeholder"},[e._v(" 请选择"+e._s(s.field)+" ")]),t("i",{staticClass:"el-icon-arrow-down",class:{"is-reverse":s.isOpen}})]),t("transition",{attrs:{name:"dropdown"}},[t("div",{directives:[{name:"show",rawName:"v-show",value:s.isOpen,expression:"level.isOpen"}],staticClass:"select-dropdown",on:{click:function(e){e.stopPropagation()}}},[t("ul",{staticClass:"option-list"},e._l(e.getLevelOptions(s),(function(i){return t("li",{key:i.value,class:{"is-selected":e.localValues[s.field]===i.value},on:{click:function(t){return e.selectOption(s.field,i.value)}}},[e._v(" "+e._s(i.label)+" ")])})),0)])])],1)]],2),e.errors[s.field]?t("div",{staticClass:"error-message"},[e._v(e._s(e.errors[s.field]))]):e._e()])})),0)])},M=[],R={name:"MultiLevelInput",props:{value:{type:[String,Array],default:()=>[]},levels:{type:Array,required:!0}},data(){return{localValues:{},dropdownStates:new Map,errors:{},showError:!1}},methods:{handleValueChange(){const e=this.levels.map((e=>{const t=this.localValues[e.field];return void 0!==t?t:""})),t=e.some((e=>""!==e));this.$emit("input",t?e:[])},handleInputChange(e,t){this.localValues[e]=t,this.handleValueChange()},handleNumericInput(e,t){const s=t.replace(/[^\d]/g,""),i=this.levels.find((t=>t.field===e));if(i&&i.digits){if(s.length>i.digits){this.$set(this.errors,e,`${i.field}不能超过${i.digits}位数字`);const t=s.slice(0,i.digits);this.$set(this.localValues,e,t)}else this.$set(this.errors,e,""),this.$set(this.localValues,e,s);this.handleValueChange(),this.$emit("validate",!Object.values(this.errors).some((e=>e)))}},validateField(e){const t=this.levels.find((t=>t.field===e)),s=this.localValues[e];s?t.isNumeric&&s.length>t.digits?this.$set(this.errors,e,`${t.field}不能超过${t.digits}位数字`):this.$set(this.errors,e,""):t.isNumeric?this.$set(this.errors,e,`请输入${t.field}`):this.$set(this.errors,e,`请选择${t.field}`);const i=Object.values(this.errors).some((e=>e));this.$emit("validate",!i)},parseValueToLocal(e){const t=Array.isArray(e)?e:[];this.levels.forEach(((e,s)=>{this.$set(this.localValues,e.field,t[s]||"")}))},getLevelOptions(e){return!e.isNumeric&&e.valueRange&&Array.isArray(e.valueRange)&&Array.isArray(e.valueRange[0])?e.valueRange.map((([e,t])=>({label:e,value:t}))):[]},getMaxDigits(e){if(!e.valueRange||!Array.isArray(e.valueRange))return 9999;const t=e.valueRange.find((e=>"digits"===e[0]));return t?Math.pow(10,t[1])-1:9999},getDisplayValue(e,t){if(void 0===t||null===t||""===t)return"";if(!e.isNumeric&&e.valueRange){const s=e.valueRange.find((([,e])=>e===t));return s?s[0]:t}return t},toggleSelect(e){event.stopPropagation(),Object.prototype.hasOwnProperty.call(e,"isOpen")||this.$set(e,"isOpen",!1),this.$set(e,"isOpen",!e.isOpen),this.levels.forEach((t=>{t!==e&&Object.prototype.hasOwnProperty.call(t,"isOpen")&&this.$set(t,"isOpen",!1)}))},selectOption(e,t){this.$set(this.localValues,e,t),this.$set(this.errors,e,""),this.$nextTick((()=>{this.handleValueChange()}));const s=this.levels.find((t=>t.field===e));s&&this.$set(s,"isOpen",!1)},convertNumberToLabel(e,t){if(!e.valueRange)return t;if(e.isNumeric){const s=e.valueRange.find((e=>"digits"===e[0]));return s?String(t).padStart(s[1],"0"):t}const s=e.valueRange.find((e=>e[1]===t));return s?s[0]:t},closeOtherDropdowns(e){this.levels.forEach((t=>{t!==e&&this.$set(t,"isOpen",!1)}))}},mounted(){this.handleClickOutside=e=>{this.$el.contains(e.target)||this.levels.forEach((e=>{Object.prototype.hasOwnProperty.call(e,"isOpen")&&this.$set(e,"isOpen",!1)}))},document.addEventListener("click",this.handleClickOutside)},beforeDestroy(){document.removeEventListener("click",this.handleClickOutside)},watch:{value:{immediate:!0,handler(e){this.parseValueToLocal(e)}}}},N=R,L=(0,d.A)(N,A,M,!1,null,"15b5fe54",null),O=L.exports,V=s(5720),G={name:"SchoolDialog",components:{ResponsiveDialog:F.A,ImageUploader:P.A,MultiLevelInput:O},props:{visible:Boolean,isEdit:Boolean,schoolData:Object,levelConfig:{type:Array,required:!0}},data(){return{dialogVisible:!1,schoolForm:{id:null,name:"",slogan:"",image:"",teamNumber:[]},schoolFile:null,rules:{name:[{required:!0,message:"团体名称不能为空",trigger:"blur"}],teamNumber:[{required:!0,message:"请完整填写团体级别",trigger:"change",validator:(e,t,s)=>{if(!Array.isArray(t)||0===t.length)return void s(new Error("请填写团体级别"));const i=t.every((e=>""!==e&&void 0!==e));i?s():s(new Error("请完整填写所有级别"))}}]},isTeamNumberValid:!1}},watch:{visible(e){this.dialogVisible=e,e&&this.isEdit&&this.schoolData&&this.initEditForm()},dialogVisible(e){e||this.$emit("update:visible",!1)}},methods:{initEditForm(){console.log("初始化编辑表单,接收的数据:",this.schoolData);const e=Array.isArray(this.schoolData.teamNumber)?JSON.parse(JSON.stringify(this.schoolData.teamNumber)):[];if(this.schoolForm={id:this.schoolData.id,name:this.schoolData.name,slogan:this.schoolData.slogan,image:this.schoolData.image,teamNumber:e},Array.isArray(this.schoolData.teamNumber)){const e=this.schoolData.teamNumber.map(((e,t)=>{const s=this.levelConfig[t];return s&&s.isNumeric?String(e).padStart(s.digits,"0"):e}));this.schoolForm.teamNumber=e}console.log("处理后的表单数据:",this.schoolForm)},updateSchoolImage(e){this.schoolForm.image=e},updateSchoolFile(e){this.schoolFile=e},handleTeamNumberValidate(e){this.isTeamNumberValid=e},async submitForm(){try{await this.$refs.schoolForm.validate();const e=new FormData;e.append("name",this.schoolForm.name),e.append("slogan",this.schoolForm.slogan),this.schoolFile&&e.append("imgFile",this.schoolFile),Array.isArray(this.schoolForm.teamNumber)&&this.schoolForm.teamNumber.length>0&&e.append("teamNumber",JSON.stringify(this.schoolForm.teamNumber));const t=this.isEdit?"/modifySchool":"/addSchool";this.isEdit&&e.append("scId",this.schoolForm.id);const s=await(0,V.A)({url:t,method:"post",data:e});if(1===s.code){const e={id:this.isEdit?this.schoolForm.id:s.data,scId:this.isEdit?this.schoolForm.id:s.data,name:this.schoolForm.name,slogan:this.schoolForm.slogan,image:this.schoolForm.image,teamNumber:this.schoolForm.teamNumber,players:[]};this.$emit("success",e),this.$message.success((this.isEdit?"修改":"添加")+"成功"),this.dialogVisible=!1}}catch(e){console.error((this.isEdit?"修改":"添加")+"团体失败:",e),this.$message.error((this.isEdit?"修改":"添加")+"团体失败")}},validateTeamNumber(){if(!Array.isArray(this.schoolForm.teamNumber))return!1;for(let e=0;e<this.levelConfig.length;e++){const t=this.levelConfig[e],s=this.schoolForm.teamNumber[e];if(void 0===s||""===s)return this.$message.error(`请输入${t.field}级别的值`),!1;if(t.isNumeric){if(!/^\d+$/.test(s))return this.$message.error(`${t.field}必须是纯数字`),!1;if(s.length!==t.digits)return this.$message.error(`${t.field}必须是${t.digits}位数字`),!1}else{const e=t.valuePairs.map((e=>e.value));if(!e.includes(s))return this.$message.error(`${t.field}的值不在允许范围内`),!1}}return!0}}},z=G,U=(0,d.A)(z,I,$,!1,null,"6e1efb9e",null),j=U.exports,J=function(){var e=this,t=e._self._c;return t("responsive-dialog",{attrs:{title:e.getDialogTitle,visible:e.dialogVisible,width:"500px"},on:{"update:visible":function(t){e.dialogVisible=t},confirm:e.submitForm,cancel:function(t){return e.$emit("update:visible",!1)}}},[t("div",{staticClass:"dialog-body"},[t("el-form",{ref:"playerForm",attrs:{model:e.playerForm,"label-width":"80px",rules:e.rules}},[t("el-form-item",{attrs:{label:"姓名",prop:"name"}},[t("el-input",{attrs:{placeholder:"请输入姓名"},model:{value:e.playerForm.name,callback:function(t){e.$set(e.playerForm,"name",t)},expression:"playerForm.name"}})],1),t("el-form-item",{attrs:{label:"性别",prop:"gender"}},[t("el-radio-group",{model:{value:e.playerForm.gender,callback:function(t){e.$set(e.playerForm,"gender",t)},expression:"playerForm.gender"}},[t("el-radio",{attrs:{label:!0}},[e._v("男")]),t("el-radio",{attrs:{label:!1}},[e._v("女")])],1)],1),e.isEdit?t("el-form-item",{attrs:{label:"参赛编号",prop:"number"}},[t("el-input",{attrs:{placeholder:"请输入参赛编号"},model:{value:e.playerForm.number,callback:function(t){e.$set(e.playerForm,"number",t)},expression:"playerForm.number"}},[e.isManualNumbering?t("template",{slot:"append"},[t("el-tooltip",{attrs:{content:"当前可能尚未完成自动编号，若手动编号可能会被稍后的自动编号覆盖",placement:"top"}},[t("i",{staticClass:"el-icon-warning-outline",staticStyle:{color:"#E6A23C"}})])],1):e._e()],2)],1):e._e(),e.playerData?.isLeader?e._e():t("el-form-item",{attrs:{label:"项目",prop:"events"}},[t("multi-select",{attrs:{options:e.sportEventOptions,"max-limit":e.maxEvents,placeholder:"请选择参赛项目"},on:{change:e.handleEventsChange},model:{value:e.playerForm.events,callback:function(t){e.$set(e.playerForm,"events",t)},expression:"playerForm.events"}})],1),t("el-form-item",{attrs:{label:"头像"}},[t("image-uploader",{attrs:{imageUrl:e.playerForm.head},on:{"update:imageUrl":e.updatePlayerImage,"update:file":e.updatePlayerFile}})],1)],1)],1)])},q=[],B=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"click-outside",rawName:"v-click-outside",value:e.closeDropdown,expression:"closeDropdown"}],staticClass:"custom-multi-select"},[t("div",{staticClass:"select-box",on:{click:e.toggleDropdown}},[t("div",{staticClass:"selected-items"},[e.selectedItems.length?[t("div",{staticClass:"selected-tags"},e._l(e.selectedItems,(function(s){return t("el-tag",{key:s.id,attrs:{size:"small",closable:e.canRemove(s)},on:{close:function(t){return t.stopPropagation(),e.removeItem(s)}}},[e._v(" "+e._s(s.name)+" "),t("span",{staticClass:"comp-type-tag",class:e.getCompTypeClass(s.compType)},[e._v(" "+e._s(e.getCompTypeText(s.compType))+" ")])])})),1)]:t("span",{staticClass:"placeholder"},[e._v(e._s(e.placeholder))])],2),t("i",{class:["el-icon-arrow-down",{"is-reverse":e.isOpen}]})]),t("transition",{attrs:{name:"zoom-in-top"}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.isOpen,expression:"isOpen"}],staticClass:"select-dropdown"},[t("div",{staticClass:"select-dropdown__list"},e._l(e.visibleOptions,(function(s){return t("div",{key:s.id,staticClass:"select-dropdown__item",class:{"is-selected":e.isSelected(s),"is-disabled":e.isDisabled(s)},on:{click:function(t){return t.stopPropagation(),e.handleSelect(s)}}},[e._v(" "+e._s(s.name)+" "),t("span",{staticClass:"comp-type-tag",class:e.getCompTypeClass(s.compType)},[e._v(" "+e._s(e.getCompTypeText(s.compType))+" ")])])})),0)])])],1)},W=[],H={name:"MultiSelect",props:{value:{type:Array,default:()=>[]},options:{type:Array,default:()=>[]},placeholder:{type:String,default:"请选择"},maxLimit:{type:Number,default:1/0}},data(){return{isOpen:!1,selectedItems:[]}},created(){this.selectedItems=[...this.value]},watch:{value:{handler(e){this.selectedItems=[...e]},deep:!0}},computed:{visibleOptions(){return this.options.filter((e=>!e.hidden))}},methods:{toggleDropdown(){this.isOpen=!this.isOpen},closeDropdown(){this.isOpen=!1},isSelected(e){return this.selectedItems.some((t=>t.id===e.id))},handleSelect(e){if(this.isDisabled(e))return;const t=this.selectedItems.findIndex((t=>t.id===e.id));if(-1===t){if(!this.canAdd(e))return;this.selectedItems.push(e)}else{if(!this.canRemove(e))return void this.$message.error("当前比赛已截至报名，禁止退赛！");this.selectedItems.splice(t,1)}this.$emit("input",this.selectedItems),this.$emit("change",this.selectedItems)},removeItem(e){if(!this.canRemove(e))return void this.$message.error("当前比赛已截止报名，禁止退赛！");const t=this.selectedItems.findIndex((t=>t.id===e.id));-1!==t&&(this.selectedItems.splice(t,1),this.$emit("input",this.selectedItems),this.$emit("change",this.selectedItems))},getCompTypeText(e){const t=Number(e),s={1:"(预赛)",2:"(半决赛)",3:"(决赛)"};return s[t]||""},getCompTypeClass(e){const t=Number(e);return`type-${t}`},canAdd(e){const t=new Set(this.selectedItems.map((e=>e.mainSpId)));return!(!t.has(e.mainSpId)&&t.size>=this.maxLimit)||(this.$message.error(`每名运动员最多可报${this.maxLimit}个项目`),!1)},canRemove(e){return e.status<2},isDisabled(e){return e.disabled||e.status>=2}},directives:{clickOutside:{bind(e,t){e.__vueClickOutside__=function(s){e===s.target||e.contains(s.target)||t.value(s)},document.addEventListener("click",e.__vueClickOutside__)},unbind(e){document.removeEventListener("click",e.__vueClickOutside__),delete e.__vueClickOutside__}}}},Q=H,Y=(0,d.A)(Q,B,W,!1,null,"353b767e",null),Z=Y.exports,X={name:"PlayerDialog",components:{ResponsiveDialog:F.A,ImageUploader:P.A,MultiSelect:Z},props:{visible:Boolean,isEdit:Boolean,playerData:Object,schoolId:{type:Number,required:!0},schoolName:{type:String,required:!0},sportEvents:Array,maxEvents:{type:Number,default:3}},data(){return{dialogVisible:!1,playerForm:{id:null,name:"",gender:null,events:[],head:null,number:null},playerFile:null,rules:{name:[{required:!0,message:"姓名不能为空",trigger:"blur"}],gender:[{required:!0,message:"请选择性别",trigger:"change"}]}}},computed:{getDialogTitle(){const e=this.playerData?.isLeader?"负责人":"运动员";return this.isEdit?`编辑${e}`:`添加${e}`},sportEventOptions(){return this.sportEvents.map((e=>{const t=this.playerForm.events?.some((t=>t.id===e.spId)),s=1===e.compSystem&&3===e.compType||1!==e.compSystem&&1===e.compType;return{id:e.spId,name:this.formatEventName(e),status:e.status,compType:e.compType,compSystem:e.compSystem,mainSpId:e.mainSpId,disabled:1!==e.status||null!==e.gender&&e.gender!==this.playerForm.gender||!s&&!t,hidden:!1}}))},isManualNumbering(){return this.isEdit&&this.playerData&&null===this.playerData.number}},watch:{visible(e){this.dialogVisible=e,e&&this.isEdit&&this.playerData&&this.initEditForm(),e&&!this.isEdit&&(this.playerForm={id:Date.now(),name:"",gender:null,events:[],head:null,number:null})},dialogVisible(e){e||this.$emit("update:visible",!1)}},methods:{initEditForm(){this.playerForm={id:this.playerData.id,pid:this.playerData.pid,name:this.playerData.name,number:this.playerData.number,gender:this.playerData.gender,head:this.playerData.head,sports:[...this.playerData.sports||[]],events:this.playerData.events||[]}},validateEvents(e,t,s){if(!t||0===t.length)return void s();const i=new Set(t.map((e=>e.mainSpId)));i.size>this.maxEvents?s(new Error(`每名运动员最多可报${this.maxEvents}个不同主项目`)):s()},handleEventsChange(e){const t=[...this.playerForm.events],s=t.find((t=>!e.find((e=>e.id===t.id))));if(s){const e=this.sportEvents.find((e=>e.spId===s.id));if(e&&1!==e.status)return this.$message.warning("该项目已过报名期，不能退出"),void(this.playerForm.events=t)}const i=new Set(e.map((e=>e.mainSpId)));if(i.size>this.maxEvents)return this.$message.warning(`每名运动员最多可报${this.maxEvents}个不同主项目`),void(this.playerForm.events=t);this.playerForm.events=e},updatePlayerImage(e){this.playerForm.head=e},updatePlayerFile(e){this.playerFile=e},formatEventName(e){let t="";null!==e.gender&&(t=e.gender?"男子":"女子");const s={1:"(预赛)",2:"(半决赛)",3:"(决赛)"}[e.compType]||"";return`${t}${e.name}${s}`},async submitForm(){try{await this.$refs.playerForm.validate();const e=new FormData;let t;e.append("name",this.playerForm.name),e.append("age",18),e.append("gender",this.playerForm.gender),e.append("pClass",this.schoolName),e.append("scId",this.schoolId),this.isEdit&&e.append("number",this.playerForm.number||""),this.isEdit&&this.playerForm.pid&&e.append("pid",this.playerForm.pid),this.playerData?.isLeader||this.playerForm.events.forEach((t=>{e.append("sports",t.id)})),this.playerFile&&e.append("headFile",this.playerFile),t=this.playerData?.isLeader?this.isEdit?"/modifyPlayer":"/addLeader":this.isEdit?"/modifyPlayer":"/addPlayer",this.playerData?.isLeader&&e.append("userType","2");const s=await(0,V.A)({url:t,method:"post",data:e});if(1===s.code){const e={...this.playerForm,id:this.isEdit?this.playerForm.id:s.data,isLeader:this.playerData?.isLeader};this.$emit("success",e),this.$message.success((this.isEdit?"修改":"添加")+"成功"),this.dialogVisible=!1}}catch(e){console.error((this.isEdit?"修改":"添加")+"失败:",e),this.$message.error((this.isEdit?"修改":"添加")+"失败")}}}},K=X,ee=(0,d.A)(K,J,q,!1,null,"0289e598",null),te=ee.exports,se=function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{title:e.title,visible:e.dialogVisible,width:"400px","show-close":!1},on:{"update:visible":function(t){e.dialogVisible=t},close:function(t){return e.$emit("update:visible",!1)}}},[t("div",{staticClass:"confirm-content"},[t("p",{staticClass:"message"},[e._v(e._s(e.message))]),e.showCheckbox?t("div",{staticClass:"checkbox-wrapper"},[t("el-checkbox",{model:{value:e.checked,callback:function(t){e.checked=t},expression:"checked"}},[e._v(e._s(e.checkboxLabel))])],1):e._e()]),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:e.handleCancel}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:e.handleConfirm}},[e._v("确 定")])],1)])},ie=[],ae={name:"ConfirmDialog",props:{visible:Boolean,title:{type:String,default:"提示"},message:{type:String,required:!0},showCheckbox:Boolean,checkboxLabel:String},data(){return{dialogVisible:!1,checked:!1}},watch:{visible(e){this.dialogVisible=e,e||(this.checked=!1)}},methods:{handleConfirm(){this.$emit("confirm",this.checked),this.dialogVisible=!1},handleCancel(){this.$emit("cancel"),this.dialogVisible=!1}}},re=ae,ne=(0,d.A)(re,se,ie,!1,null,"c047b2a0",null),oe=ne.exports,le=function(){var e=this,t=e._self._c;return e.visible?t("div",{staticClass:"dialog-wrapper"},[t("div",{staticClass:"dialog-mask",on:{click:e.handleWrapperClick}}),t("div",{ref:"dialogEl",staticClass:"dialog",style:e.dialogStyle},[t("div",{staticClass:"dialog-header"},[t("h3",{staticClass:"title"},[e._v(e._s(e.title))]),t("div",{staticClass:"header-actions"},[t("button",{staticClass:"close-btn",on:{click:e.handleClose}},[e._v("×")])])]),t("div",{staticClass:"dialog-body"},[e._t("default")],2)])]):e._e()},ce=[],de={name:"BaseDialog",props:{visible:{type:Boolean,default:!1},title:{type:String,default:""},width:{type:String,default:"500px"},closeOnClickMask:{type:Boolean,default:!0}},computed:{dialogStyle(){const e=window.innerWidth<=768;return{width:e?"80%":this.width}}},methods:{handleClose(){this.$emit("update:visible",!1),this.$emit("close")},handleWrapperClick(){this.closeOnClickMask&&this.handleClose()}},watch:{visible(e){document.body.style.overflow=e?"hidden":""}}},ue=de,pe=(0,d.A)(ue,le,ce,!1,null,"495de8fb",null),me=pe.exports,he=s(9586),ge={name:"SchoolCard",components:{SchoolDialog:j,PlayerDialog:te,ConfirmDialog:oe,BaseDialog:me},props:{schoolData:{type:Object,required:!0},isActive:Boolean,isEditMode:Boolean,isSchoolMode:Boolean,maxPlayers:{type:Number,required:!0},loading:{type:Boolean,default:!1},sportEvents:{type:Array,default:()=>[]},maxEvents:{type:Number,required:!0},levelConfig:{type:Array,required:!0}},data(){const e=JSON.parse(localStorage.getItem("userInfo")||"{}");return{activeTab:"athletes",scoreDetailsTitle:"",currentScoreDetails:[],playerDialogVisible:!1,isEditingPlayer:!1,currentPlayer:{id:null,name:"",class:"",gender:null,events:[],head:"",level:{}},playerFile:null,localPlayers:[],isShowScoreDetails:!1,localSchoolData:{},detail:null,maxAthletes:8,maxPlayerEvents:7,dialogVisible:!1,showDeleteConfirm:!1,inviteDialogVisible:!1,inviteCode:"",inviteGender:!0,isExistingCode:!1,currentUserId:e.uid||null,currentUserInfo:e}},watch:{schoolData:{immediate:!0,handler(e){this.localSchoolData=JSON.parse(JSON.stringify({id:e.id,name:e.name,slogan:e.slogan,image:e.image,teamNumber:e.teamNumber||[]}))}},"schoolData.detail.players":{immediate:!0,handler(e){this.localPlayers=e?[...e]:[]}},isActive:{immediate:!0,handler(e){e&&!this.detail&&this.fetchSchoolDetail()}}},computed:{canAddMore(){return!this.detail?.players||this.detail.players.length<this.maxAthletes},schoolPlayers(){return this.detail?.players||[]},schoolName(){return this.localSchoolData.name},schoolSlogan(){return this.localSchoolData.slogan||"暂无口号"},schoolImage(){return this.localSchoolData.image||null},sortedPlayers(){return this.localPlayers?[...this.localPlayers].sort(((e,t)=>2===e.userType&&2!==t.userType?-1:2===t.userType&&2!==e.userType?1:0)):[]},isCurrentUser(){return e=>e.uid==this.currentUserId},isLeader(){return e=>2===e.userType},isAdmin(){const e=JSON.parse(localStorage.getItem("userInfo")||"{}"),t=JSON.parse(e.powerDegree||"[]");return t.includes(5)},hasCurrentUserRecord(){return!(!this.detail?.players||!this.currentUserId)&&this.detail.players.some((e=>e.uid===this.currentUserId&&(2===e.userType||4===e.userType)))}},methods:{formatEventName:he.z,validateEvents(e,t,s){if(!t||0===t.length)return void s();const i=new Set(t.map((e=>e.mainSpId)));i.size>this.maxPlayerEvents?s(new Error(`每名运动员最多可报${this.maxPlayerEvents}个不同主项目`)):s()},handleEventsChange(e){if(console.log("事件改变，当前选择的项目:",e),null===this.currentPlayer.gender)return this.$message.warning("请先选择运动员性别"),void(this.currentPlayer.events=[]);const t=e.every((e=>e&&null!=e.mainSpId));if(!t)return console.error("存在没有mainSpId的项目，需要检查数据转换过程"),void this.$message.error("项目数据不完整，请联系管理员");if(!this.validateEventSelection(e))return void this.$message.warning(`最多只能选择${this.maxEvents}个不同的主项目`);const s=e.some((e=>null!==e.gender&&e.gender!==this.currentPlayer.gender));s?this.$message.warning("不能选择与运动员性别不符的项目"):this.currentPlayer.events=e},getAthleteEvents(e){return 2===e.userType?"":e&&Array.isArray(e.events)?e.events.map((e=>(0,he.z)(e))).join("、"):"暂无参赛项目"},formatDegree(e){return null===e||void 0===e?0:Number(e).toFixed(1)},formatScore(e){if(!e)return"暂无成绩";try{const t=e.replace(/[{}]/g,"").split(",").map((e=>e.trim()));return t.map((e=>{const[t,s]=e.split("=");return`${s}${t}`})).join("")}catch(t){return console.error("成绩格式化失败:",t),e}},showScoreDetails(e){this.isShowScoreDetails=!0,this.scoreDetailsTitle="all"===e?"团体得分明细":("male"===e?"男子":"女子")+"比赛得分明细",this.currentScoreDetails="all"===e?[...this.detail?.maleDegreeDetails||[],...this.detail?.femaleDegreeDetails||[]]:this.detail?.[`${e}DegreeDetails`]||[],0===this.currentScoreDetails.length&&(this.$message.info("暂无得分明细数据"),this.isShowScoreDetails=!1)},closeScoreDetails(){this.currentScoreDetails=[],this.scoreDetailsTitle="",this.isShowScoreDetails=!1},handleAddPlayer(){this.isEditingPlayer=!1,this.currentPlayer={id:Date.now(),name:"",class:"",gender:null,events:[],head:null,isLeader:!1},this.playerDialogVisible=!0},async handleAddLeader(){this.isEditingPlayer=!1,this.currentPlayer={id:Date.now(),name:"",class:"",gender:null,head:null,isLeader:!0},this.playerDialogVisible=!0},handleEditPlayer(e){this.isEditingPlayer=!0,this.currentPlayer={id:e.id,pid:e.pid,name:e.name,number:e.number,class:e.pClass||"",gender:e.gender,head:e.head,sports:[...e.sports||[]],events:this.convertPlayerEvents(e),level:e.level||{},isLeader:2===e.userType,isEditing:!0},this.playerDialogVisible=!0},async handleDeletePlayer(e){try{await this.$confirm("删除该运动员将同时取消其已报名的所有项目，是否继续？","警告",{type:"warning",confirmButtonText:"确定",cancelButtonText:"取消"});const t=await(0,V.A)({url:"/deletePlayer",method:"get",params:{pid:e.pid}});1===t.code&&(this.$message.success("删除成功"),await this.fetchSchoolDetail())}catch(t){"cancel"!==t&&(console.error("删除运动员失败:",t),this.$message.error("删除运动员失败"))}},async handleDelete(){this.showDeleteConfirm=!0},async confirmDelete(e){try{const t=await(0,V.A)({url:"/deleteSchool",method:"get",params:{scId:this.schoolData.id,deletePlayers:e}});1===t.code&&(this.$emit("refresh"),this.$message.success("删除成功"))}catch(t){console.error("删除团体失败:",t),this.$message.error("删除团体失败")}},handlePlayerSuccess(){this.playerDialogVisible=!1,this.fetchSchoolDetail()},convertPlayerEvents(e){return Array.isArray(e.sports)&&Array.isArray(this.sportEvents)?e.sports.map((e=>{const t=this.sportEvents.find((t=>t.spId===e));return t?{id:t.spId,name:t.name,status:t.status,mainSpId:t.mainSpId,compType:t.compType,gender:t.gender}:(console.warn(`未找到ID为${e}的比赛信息`),null)})).filter(Boolean):[]},updatePlayerImage(e){this.currentPlayer.head=e},updatePlayerFile(e){this.playerFile=e},async fetchSchoolDetail(){if(this.localSchoolData.id){this.$emit("update:loading",!0);try{const e=await(0,V.A)({url:"/getSchoolDetail",method:"get",params:{scId:this.localSchoolData.id}});if(1===e.code){const t=(e.data.maleDegreeDetails||[]).map((e=>({...e,spId:e.spId,gender:!0,compType:e.compType||3}))),s=(e.data.femaleDegreeDetails||[]).map((e=>({...e,spId:e.spId,gender:!1,compType:e.compType||3})));this.detail={...e.data,players:e.data.players?.map((e=>({...e,id:e.pid,pClass:e.pclass||e.pClass,events:this.convertPlayerEvents(e),sports:e.sports||[],head:e.head})))||[],totalDegree:e.data.totalDegree||0,maleDegree:e.data.maleDegree||0,femaleDegree:e.data.femaleDegree||0,maleDegreeDetails:t,femaleDegreeDetails:s},console.log("处理后的学校详情:",this.detail),this.localPlayers=this.detail.players}}catch(e){console.error("获取学校详情失败:",e),this.$message.error("获取学校详情失败")}finally{this.$emit("update:loading",!1)}}},showEditDialog(){console.log("开启编辑对话框,当前学校数据:",this.localSchoolData),this.dialogVisible=!0},async handleEditSuccess(e){this.localSchoolData={...this.localSchoolData,name:e.name,slogan:e.slogan,image:e.image,teamNumber:e.teamNumber||[]},this.isActive&&await this.fetchSchoolDetail(),this.$emit("success",e)},async handleInvitePlayer(e){const t=2===e.userType?[2]:[4];await this.createAndShowInviteCode(`pid=${e.pid}`,e.gender,t)},async handleInviteSchool(){await this.createAndShowInviteCode(`scId=${this.localSchoolData.id}`)},async copyToClipboard(e){let t=!1;if(navigator.clipboard&&window.isSecureContext)try{await navigator.clipboard.writeText(e),t=!0}catch(s){console.warn("Clipboard API failed:",s)}if(!t){const i=document.createElement("textarea");if(i.value=e,i.style.cssText="position:fixed; top:-99999px; left:-99999px; opacity:0;",document.body.appendChild(i),navigator.userAgent.match(/ipad|iphone/i)){const e=document.createRange();e.selectNodeContents(i);const t=window.getSelection();t.removeAllRanges(),t.addRange(e),i.setSelectionRange(0,999999)}else i.select();try{t=document.execCommand("copy"),t||console.warn("execCommand copy failed")}catch(s){console.warn("execCommand error:",s),t=!1}document.body.removeChild(i)}return t||this.$message({message:"自动复制失败，请手动复制邀请码",type:"warning",duration:3e3}),t},async createAndShowInviteCode(e,t=null,s=[4]){try{let i=!1,a="";while(!i){a=this.generateRandomCode();const t=await(0,V.A)({url:"/createInviteCode",method:"post",data:{code:a,user:e,userType:s,expireTime:new Date(Date.now()+2592e5).toISOString()}});if(1===t.code)i=!0,this.inviteCode=a,this.isExistingCode=!1;else if("DUPLICATED_USER"==t.message)i=!0,this.inviteCode=t.data,this.isExistingCode=!0;else if("DUPLICATED_CODE"!==t.message)throw new Error(t.message||"生成邀请码失败")}this.inviteDialogVisible=!0,this.inviteGender=null===t||t,this.$nextTick((async()=>{const e=await this.copyToClipboard(this.inviteCode);e&&this.$message.success("邀请码已复制到剪贴板")}))}catch(i){console.error("生成邀请码失败:",i),this.$message.error(i.message||"生成邀请码失败")}},generateRandomCode(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_";let t="";for(let s=0;s<8;s++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},async handleQuitSchool(){try{await this.$confirm("确定要退出该团体吗？此操作无法撤销","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=new URLSearchParams;e.append("scId",this.localSchoolData.id);const t=await(0,V.A)({url:"/quitSchool",method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:e});1===t.code&&(this.$message.success("退出成功"),this.$emit("refresh"))}catch(e){"cancel"!==e&&(console.error("退出团体失败:",e),this.$message.error("退出失败"))}},isAllowEdit(){this.detail.players.forEach((e=>{if(e.uid===this.currentUserId&&2===e.userType)return!0}))}}},fe=ge,ve=(0,d.A)(fe,k,x,!1,null,"48bdaeef",null),ye=ve.exports,be={components:{SchoolCard:ye,ResponsiveDialog:F.A,SchoolDialog:j},data(){return{loading:!1,localEditMode:!1,activeSchoolId:null,schools:[],sportEvents:[],sportEventsMap:{},dialogVisible:!1,isEdit:!1,currentSchool:{id:null,name:"",slogan:"",image:"",players:[],teamNumber:[]},currentPlayer:{id:null,name:"",class:"",gender:null,events:[],head:""},rules:{name:[{required:!0,message:"姓名不能为空",trigger:"blur"}],class:[{required:!0,message:"班级不能为空",trigger:"blur"}],gender:[{required:!0,message:"请选择性别",trigger:"change"}],events:[{validator:(e,t,s)=>{if(!t||0===t.length)return void s();const i=new Set(t.map((e=>e.mainSpId)));i.size>this.maxEvents?s(new Error(`每名运动员最多可报${this.maxEvents}个不同主项目`)):s()},trigger:"change"}]},schoolDialogVisible:!1,isSchoolEdit:!1,schoolFile:null,playerFile:null,configDialogVisible:!1,configForm:{maxPlayers:7,maxEvents:3,levelConfig:[]},loadingDetail:!1,levelConfig:[{value:"年级",useChinese:!0,range:[1,9]},{value:"班",useChinese:!1,range:[1,9]}],joinDialogVisible:!1,joinForm:{inviteCode:""},joinRules:{inviteCode:[{required:!0,message:"请输入邀请码",trigger:"blur"}]},isAthlete:!1}},async created(){await Promise.all([this.fetchConfig(),this.fetchSportEvents(),this.fetchSchools()]);const e=localStorage.getItem("userInfo");var t;t=null!=e?JSON.parse(e):{userType:[]},this.localEditMode=t.userType.includes(5)||t.userType.includes(2)||!1,this.isAthlete=t.userType.includes(4)||!1},computed:{maxPlayers(){return this.configForm.maxPlayers},maxEvents(){return this.configForm.maxEvents},filteredSportEvents(){return this.isEdit?this.sportEvents:this.sportEvents.filter((e=>e.status<2))},getEventOptions(){return this.sportEvents.filter((e=>!!this.isEdit||e.status<2)).map((e=>{const t=this.currentPlayer.events.filter((t=>t.mainSpId===e.mainSpId));return{id:e.spId,name:this.formatEventName(e),status:e.status,compType:e.compType,mainSpId:e.mainSpId,disabled:null!==e.gender&&e.gender!==this.currentPlayer.gender||!this.isEdit&&t.length>0,hidden:!this.isEdit&&e.status>=2}}))}},mounted(){this.updateIsMobile(),window.addEventListener("resize",this.updateIsMobile)},beforeDestroy(){window.removeEventListener("resize",this.updateIsMobile)},methods:{updateIsMobile(){this.isMobile=window.innerWidth<=767},showConfig(){this.configDialogVisible=!0,this.fetchConfig()},async fetchConfig(){try{const e=await(0,V.A)({url:"/getDepartmentConfig",method:"get"});if(1===e.code){const t=e.data,s=JSON.parse(t.levelConfig).map((e=>{if(e.isNumeric){const t=e.valueRange.find((e=>"digits"===e[0]));return{...e,digits:t?t[1]:2,valuePairs:[],isExpanded:!1}}return{...e,valuePairs:e.valueRange.map((([e,t])=>({label:e,value:t}))),isExpanded:!1}}));return console.log("处理后的levelConfig:",s),this.configForm={maxPlayers:t.maxPlayers,maxEvents:t.maxEvents,levelConfig:s},!0}}catch(e){return console.error("获取配置失败:",e),this.$message.error("获取配置失败"),!1}},async saveConfig(){try{const e=new URLSearchParams;e.append("maxPlayers",this.configForm.maxPlayers),e.append("maxEvents",this.configForm.maxEvents);const t=this.configForm.levelConfig.map((e=>({field:e.field,isNumeric:e.isNumeric,valueRange:e.isNumeric?[["digits",parseInt(e.digits)||2]]:(e.valuePairs||[]).map((e=>[e.label,e.value]))})));e.append("levelConfig",JSON.stringify(t));const s=await(0,V.A)({url:"/updateDepartmentConfig",method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:e});1===s.code&&(this.$message.success("保存成功"),this.configDialogVisible=!1,await this.fetchConfig())}catch(e){console.error("保存配置失败:",e),this.$message.error("保存配置失败")}},toggleEditMode(){this.localEditMode=!this.localEditMode,this.localEditMode||(this.activeSchoolId=null),this.$emit("update:isEditMode",this.localEditMode)},async handleToggleSchool(e){this.activeSchoolId!==e?this.activeSchoolId=e:this.activeSchoolId=null},closePanel(){this.activeSchoolId=null},handleAddPlayer(e){e.players.length>=this.maxPlayers?this.$message.warning(`每个团体最多添加${this.maxPlayers}名运动员`):(this.currentSchool=e,this.isEdit=!1,this.dialogVisible=!0,this.currentPlayer={id:Date.now(),name:"新运动员",class:"未知班级",gender:null,events:[],head:null})},handleEditPlayer(e,t){console.log("编辑运动员原始数据:",t),this.currentSchool=e,this.isEdit=!0,this.dialogVisible=!0;const s=(t.sports||[]).map((e=>{const t=this.sportEvents.find((t=>t.spId===e));return console.log("找到的原始项目数据:",t),t?{id:t.spId,name:t.name,status:t.status,mainSpId:t.mainSpId,compType:t.compType,gender:t.gender}:null})).filter(Boolean);console.log("转换后的项目数据:",s),this.currentPlayer={id:t.id,pid:t.pid,name:t.name,number:t.number,class:t.pClass||"",gender:t.gender,head:t.head,sports:[...t.sports||[]],events:[...s]},console.log("当前编辑的运动员完整数据:",this.currentPlayer)},async handleDeletePlayer(e,t){try{const s=await(0,V.A)({url:"/deletePlayer",method:"get",params:{pid:t.pid}});if(1===s.code){const s=e.players.findIndex((e=>e.id===t.id));e.players.splice(s,1),this.$message.success("删除成功")}}catch(s){console.error("删除运动员失败:",s),this.$message.error("删除运动员失败")}},handleDialogClose(){this.$refs.athleteForm.resetFields(),this.currentSchool={id:null,name:"",slogan:"",image:"",players:[]}},handlePreview(e){const t=URL.createObjectURL(e.raw);this.currentPlayer={...this.currentPlayer,head:t,rawFile:e.raw},this.$once("hook:beforeDestroy",(()=>{URL.revokeObjectURL(t)}))},clearPreview(){URL.revokeObjectURL(this.currentPlayer.head),this.currentPlayer.head="",this.currentPlayer.rawFile=null},handleRemove(){return this.$confirm("确定移除该头像？","提示",{type:"warning"})},handleAvatarSuccess(e,t){this.currentPlayer.file=t.raw,this.currentPlayer.head=URL.createObjectURL(t.raw)},submitForm(){this.$refs.athleteForm.validate((async e=>{if(e)try{const e=new FormData;e.append("name",this.currentPlayer.name),e.append("age",18),e.append("gender",null===this.currentPlayer.gender?"":this.currentPlayer.gender),e.append("pClass",this.currentPlayer.class),e.append("scId",this.currentSchool.id),e.append("level",JSON.stringify(this.currentPlayer.level)),this.isEdit&&this.currentPlayer.pid&&e.append("pid",this.currentPlayer.pid),this.currentPlayer.events.forEach((t=>{e.append("sports",t.id)}));const t=this.currentPlayer.events.filter((e=>e.status>=2)).map(event.id),s=this.currentPlayer.events.filter((e=>e.status<2)).map(event.id),i=[...new Set([...t,...s])];i.forEach((t=>{e.append("sports",t)})),this.playerFile&&e.append("headFile",this.playerFile);const a=this.isEdit?"/modifyPlayer":"/addPlayer";this.isEdit&&e.append("pid",this.currentPlayer.id);const r=await(0,V.A)({url:a,method:"post",data:e});if(1===r.code){if(this.isEdit){const e=this.currentSchool.players.findIndex((e=>e.id===this.currentPlayer.id));this.$set(this.currentSchool.players,e,{...this.currentPlayer,id:r.data}),this.$message.success("修改成功")}else{const e={id:r.data,...this.currentPlayer};this.currentSchool.players.push(e),this.$message.success("添加成功")}this.dialogVisible=!1}}catch(t){console.error((this.isEdit?"修改":"添加")+"运动员失败:",t),this.$message.error((this.isEdit?"修改":"添加")+"运动员失败")}}))},handleAddSchool(){this.isSchoolEdit=!1,this.currentSchool={id:Date.now(),name:"新学校",slogan:"",image:"default-school.jpg",players:[],teamNumber:[]},this.schoolDialogVisible=!0},handleSchoolSuccess(){this.fetchSchools(),this.schoolDialogVisible=!1,this.isSchoolEdit=!1},async fetchSchools(){try{const e=await(0,V.A)({url:"/getSchools",method:"get"});1===e.code&&(console.log("获取到的原始团体数据:",e.data),this.schools=e.data.map((e=>{let t=[];try{t=e.teamNumber?JSON.parse(JSON.stringify(JSON.parse(e.teamNumber))):[]}catch(s){console.error(`团体 ${e.name} 的teamNumber解析失败:`,s)}return{id:e.scId,name:e.name||"未命名",slogan:e.slogan||"",image:e.img||null,teamNumber:t,players:[]}})),console.log("处理后的团体数据:",this.schools))}catch(e){console.error("获取部门数据失败:",e),this.$message.error("获取部门数据失败")}},async fetchSportEvents(){try{const e=await(0,V.A)({url:"/getAvailableSports",method:"get"});if(1===e.code){const t=e.data.map((e=>({spId:e.spId,name:e.name,gender:e.gender,status:e.status,compType:e.compType,mainSpId:e.mainSpId,compSystem:e.compSystem})));this.sportEvents=t,console.log("处理后的运动项目数据:",this.sportEvents);const s=t.reduce(((e,t)=>(e[t.spId]=t.name,e)),{});this.sportEventsMap={...s},console.log("创建的项目映射:",this.sportEventsMap)}}catch(e){console.error("获取运动项目列表失败:",e),this.$message.error("获取运动项目列表失败")}},validateEventSelection(e){console.log("验证前的选中项目:",e);const t=e.filter((e=>{const t=e&&null!=e.mainSpId;return t||console.warn("发现没有mainSpId的项目:",e),t})),s=new Set(t.map((e=>e.mainSpId)));return console.log("不同的mainSpId数量:",s.size),console.log("所有有效mainSpId:",Array.from(s)),s.size<=this.maxEvents},handleEventsChange(e){console.log("事件改变，当前选择的项目:",e);const t=e.every((e=>e&&null!=e.mainSpId));if(!t)return console.error("存在没有mainSpId的项目，需要检查数据转换过程"),void this.$message.error("项目数据不完整，请联系管理员");this.validateEventSelection(e)?this.currentPlayer.events=e:this.$message.warning(`最多只能选择${this.maxEvents}个不同的主项目`)},formatEventName(e){let t="";null!==e.gender&&(t=e.gender?"男子":"女子");const s=this.getCompTypeText(e.compType);return`${t}${e.name}${s}`},getCompTypeText(e){const t={1:"(预赛)",2:"(半决赛)",3:"(决赛)"};return t[e]||""},addLevelConfig(){this.configForm.levelConfig.push({field:"",isNumeric:!0,digits:2,valuePairs:[],isExpanded:!0})},removeLevelConfig(e){this.configForm.levelConfig.splice(e,1)},handleValueRangeEdit(e,t){if(!Array.isArray(t))return;const s=this.configForm.levelConfig[e];s.valueRange=new Map(t.filter((e=>Array.isArray(e)&&2===e.length)))},toggleLevelExpand(e){this.$set(this.configForm.levelConfig[e],"isExpanded",!this.configForm.levelConfig[e].isExpanded)},addValuePair(e){this.configForm.levelConfig[e].valuePairs||this.$set(this.configForm.levelConfig[e],"valuePairs",[]),this.configForm.levelConfig[e].valuePairs.push({label:"",value:""})},removeValuePair(e,t){this.configForm.levelConfig[e].valuePairs.splice(t,1)},handleLevelHeaderClick(e){if(e.target.closest(".level-info"))return;const t=this.configForm.levelConfig.findIndex((t=>t.field===e.currentTarget.querySelector("input").value));t>-1&&this.toggleLevelExpand(t)},showJoinDialog(){this.joinDialogVisible=!0,this.joinForm.inviteCode=""},async handleJoin(){try{await this.$refs.joinForm.validate();const e=await(0,V.A)({url:"/joinSchool",method:"post",data:"inviteCode="+this.joinForm.inviteCode});if(1===e.code)this.$message.success("加入成功"),this.joinDialogVisible=!1,this.fetchSchools();else{let t="加入失败";switch(e.message){case"INVALID_CODE":t="无效的邀请码";break;case"EXPIRED_CODE":t="邀请码已过期";break;case"ALREADY_JOINED":t="您已经是当前团体的成员";break;case"SCHOOL_NOT_FOUND":t="团体不存在";break;case"REGISTRATION_CLOSED":t="报名已截止";break}this.$message.error(t)}}catch(e){let t="加入失败";this.$message.error(t)}},async validateTeamNumber({teamNumber:e,excludeId:t}){if(!Array.isArray(e)||0===e.length)return!1;const s=JSON.stringify(e);return this.schools.some((e=>{if(e.id===t)return!1;const i=Array.isArray(e.teamNumber)?JSON.stringify(e.teamNumber):"[]";return i===s}))}}},we=be,Se=(0,d.A)(we,_,E,!1,null,"51d0658c",null),Ce=Se.exports,Te=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"sport-management",attrs:{"element-loading-text":"加载中..."}},[t("div",{staticClass:"action-bar"},[t("div",{staticClass:"action-bar-content"},[t("div",{staticClass:"filter-container"},[t("FilterDropdown",{attrs:{options:e.filterOptions.status,label:"状态"},on:{change:e.handleStateFilter},model:{value:e.currentStateFilter,callback:function(t){e.currentStateFilter=t},expression:"currentStateFilter"}}),t("FilterDropdown",{attrs:{options:e.filterOptions.eventType,label:"项目"},on:{change:e.handleEventTypeFilter},model:{value:e.currentEventType,callback:function(t){e.currentEventType=t},expression:"currentEventType"}}),e.isMobile?e._e():t("FilterDropdown",{attrs:{options:e.filterOptions.system,label:"赛制"},on:{change:e.handleSystemFilter},model:{value:e.currentSystemFilter,callback:function(t){e.currentSystemFilter=t},expression:"currentSystemFilter"}}),t("FilterDropdown",{attrs:{options:e.filterOptions.gender,label:"性别"},on:{change:e.handleGenderFilter},model:{value:e.currentGenderFilter,callback:function(t){e.currentGenderFilter=t},expression:"currentGenderFilter"}})],1),e.isEditMode?t("el-button",{staticClass:"create-button",attrs:{type:"primary",icon:"el-icon-plus"},on:{click:e.handleCreate}},[e._v("发布新赛组")]):e._e()],1)]),t("transition-group",{staticClass:"group-list",class:{"has-active":e.activeGroupId},attrs:{name:"card-list",tag:"div",css:!1}},[e._l(e.displayGroups,(function(s){return t("group-card",{key:s.id,attrs:{"group-data":s,"is-active":String(s.id)===e.activeGroupId,"is-edit-mode":e.isEditMode},on:{toggle:e.toggleGroup,edit:e.openEditDialog,"manage-groups":e.openGroupManagement,delete:function(t){return e.deleteGroup(s)}}})})),e.isEditMode?t("div",{key:"add-card-button",staticClass:"add-card",on:{click:e.handleCreate}},[t("el-button",{attrs:{type:"dashed",icon:"el-icon-plus"}},[e._v("添加赛组")])],1):e._e(),0===e.groups.length?t("el-empty",{key:"empty-state-message",attrs:{description:"暂无赛组数据"}}):e._e()],2),t("sport-dialog",{attrs:{visible:e.showEditDialog,"sport-data":e.currentGroup,venues:e.venues,"score-rules":e.scoreRules},on:{"update:visible":function(t){e.showEditDialog=t},save:e.saveGroup,"time-change":e.handleTimeChange}}),t("responsive-dialog",{attrs:{visible:e.showGroupManageDialog,title:`${e.currentPhase.name||""} - 分组管理`,width:"90%"},on:{"update:visible":function(t){e.showGroupManageDialog=t}}},[t("div",{staticClass:"group-management-wrapper"},[t("group-management",{attrs:{visible:e.showGroupManageDialog,"current-phase":e.currentPhase,events:e.currentGroup.sports||[],athletes:e.currentGroup.players||[]},on:{save:e.handleGroupsSave}}),t("div",{staticClass:"feature-unavailable-mask"},[t("div",{staticClass:"message-box"},[t("i",{staticClass:"el-icon-info"}),t("p",[e._v("目前项目分组完全依赖系统自动分组。")]),t("p",[e._v("手动分组管理功能暂未开放，将在后续的版本中启用手动分组。")])])])],1)])],1)},De=[],_e=(s(2912),function(){var e=this,t=e._self._c;return t("div",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"group-card",class:{"is-active":e.isActive}},"div",e.$attrs,!1),[t("div",{staticClass:"card-header",on:{click:function(t){return t.stopPropagation(),e.handleCardClick.apply(null,arguments)}}},[t("div",{staticClass:"title"},[t("h3",[e._v(e._s(e.title))]),t("div",{staticClass:"card-info"},[t("div",{staticClass:"info-row"},[t("el-tag",{attrs:{size:"small",type:e.systemTagType}},[e._v(e._s(e.systemText))])],1),e.firstEventWithRegistration?t("div",{staticClass:"info-row registration-time"},[t("i",{staticClass:"el-icon-time"}),t("span",{staticClass:"time-label"},[e._v(e._s(e.registrationPhase)+"报名时间：")]),t("span",{staticClass:"time-value"},[e._v(" "+e._s(e.formatDateTime(e.firstEventWithRegistration.appStartTime))+" 至 "+e._s(e.formatDateTime(e.firstEventWithRegistration.appEndTime))+" ")])]):e._e()])]),e.isEditMode?t("div",{staticClass:"actions"},[t("el-button-group",[t("el-button",{attrs:{size:"mini",type:"primary",icon:"el-icon-edit"},on:{click:function(t){return t.stopPropagation(),e.handleEdit.apply(null,arguments)}}}),t("el-button",{attrs:{size:"mini",type:"success",icon:"el-icon-menu"},on:{click:function(t){return t.stopPropagation(),e.handleManageGroups.apply(null,arguments)}}}),t("el-button",{attrs:{size:"mini",type:"danger",icon:"el-icon-delete"},on:{click:function(t){return t.stopPropagation(),e.handleDelete.apply(null,arguments)}}})],1)],1):e._e()]),t("transition",{attrs:{name:"expand"}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.isActive,expression:"isActive"}],staticClass:"card-content"},[t("el-tabs",{staticClass:"scrollable-tabs",model:{value:e.activePhase,callback:function(t){e.activePhase=t},expression:"activePhase"}},e._l(e.availablePhases,(function(s){return t("el-tab-pane",{key:s.value,attrs:{label:s.label,name:s.value}},[t("div",{staticClass:"time-info"},[t("div",{staticClass:"info-section"},[t("div",{staticClass:"info-item"},[t("label",[e._v("比赛项目：")]),t("span",[e._v(e._s(e.combinedEventTypeText))])]),e.groupData.size?t("div",{staticClass:"info-item"},[t("label",[e._v("比赛规格：")]),t("span",[e._v(e._s(e.sizeText))])]):e._e(),null!==e.groupData.gender?t("div",{staticClass:"info-item"},[t("label",[e._v("性别要求：")]),t("span",[e._v(e._s(e.groupData.gender?"男子":"女子"))])]):e._e(),void 0!==e.groupData.gender?t("div",{staticClass:"info-item"},[t("label",[e._v("性别限制：")]),t("span",[e._v(e._s(null===e.groupData.gender?"不限":e.groupData.gender?"男子项目":"女子项目"))])]):e._e()]),t("div",{staticClass:"time-items"},[e.currentPhaseData?.appTime&&2===e.currentPhaseData.appTime.length?t("div",{staticClass:"time-item"},[t("label",[e._v("报名时间：")]),t("span",[e._v(e._s(e.formatDateTime(e.currentPhaseData.appTime[0]))+" 至 "+e._s(e.formatDateTime(e.currentPhaseData.appTime[1])))])]):e._e(),e.currentPhaseData?.registrationTime?t("div",{staticClass:"time-item"},[t("label",[e._v("报名时间：")]),t("span",[e._v(e._s(e.formatDateTime(e.currentPhaseData.registrationTime[0]))+" 至 "+e._s(e.formatDateTime(e.currentPhaseData.registrationTime[1])))])]):e._e(),t("div",{staticClass:"time-item"},[t("label",[e._v("比赛时间：")]),e.currentPhaseData?.compTime?t("span",[e._v(" "+e._s(e.formatDateTime(e.currentPhaseData.compTime[0]))+" 至 "+e._s(e.formatDateTime(e.currentPhaseData.compTime[1]))+" ")]):t("span",{staticClass:"pending"},[e._v("尚未安排")]),e.currentPhaseData?.venue?[t("span",{staticClass:"venue-separator"},[e._v("·")]),t("span",{staticClass:"venue-info"},[t("i",{staticClass:"el-icon-location"}),e._v(" "+e._s(e.currentPhaseData.venue)+" ")])]:e._e()],2),e._e()]),e.showSignupButton&&1===e.currentPhaseData?.compType?t("div",{staticClass:"signup-section"},[e.isRegistrationClosed?t("el-tooltip",{attrs:{content:"已超过报名时间",placement:"top"}},[t("el-button",{attrs:{type:e.isUserEnrolled?"danger":"primary",size:"medium",disabled:e.isRegistrationClosed||e.signupLoading},on:{click:function(t){return t.stopPropagation(),e.handleSignup.apply(null,arguments)}}},[e._v(" "+e._s(e.isUserEnrolled?"取消报名":"立即报名")+" ")])],1):t("el-button",{attrs:{type:e.isUserEnrolled?"danger":"primary",size:"medium",loading:e.signupLoading},on:{click:function(t){return t.stopPropagation(),e.handleSignup.apply(null,arguments)}}},[e._v(" "+e._s(e.isUserEnrolled?"取消报名":"立即报名")+" ")])],1):e._e()]),t("div",{staticClass:"view-controls"},[t("el-radio-group",{staticClass:"view-switch",attrs:{size:"small"},model:{value:e.currentView,callback:function(t){e.currentView=t},expression:"currentView"}},[t("el-radio-button",{attrs:{label:"players"}},[e._v("选手一览")]),t("el-radio-button",{attrs:{label:"groups",disabled:!e.currentPhaseData?.groups}},[e._v("分组一览")])],1)],1),"players"===e.currentView?t("div",{staticClass:"athletes-view"},[e.hasPlayers?[t("el-table",{attrs:{data:e.currentPhasePlayers,stripe:""}},[t("el-table-column",{attrs:{prop:"name",label:"姓名"}}),t("el-table-column",{attrs:{prop:"number",label:"号码"}}),t("el-table-column",{attrs:{prop:"pclass",label:"班级"}})],1)]:t("div",{staticClass:"empty-tip"},[e._v(e._s(e.emptyDescription))])],2):"groups"===e.currentView?t("div",{staticClass:"groups-view"},[e.currentPhaseData?.groups?.length>0?[t("el-collapse",{model:{value:e.activeGroups,callback:function(t){e.activeGroups=t},expression:"activeGroups"}},e._l(e.currentPhaseData.groups,(function(s){return t("el-collapse-item",{key:s.gid,attrs:{title:s.name,name:s.gid}},[t("el-table",{attrs:{data:s.players||[],stripe:""}},[t("el-table-column",{attrs:{prop:"name",label:"姓名"}}),t("el-table-column",{attrs:{prop:"number",label:"号码"}}),t("el-table-column",{attrs:{prop:"pclass",label:"班级"}}),t("el-table-column",{attrs:{prop:"score",label:"成绩"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.formatScore(t.row.score))+" ")]}}],null,!0)})],1)],1)})),1)]:t("div",{staticClass:"empty-tip"},[e._v("暂无分组数据")])],2):e._e()])})),1)],1)]),t("form-dialog",{attrs:{title:e.isUserEnrolled?"选择要取消的参赛身份":"选择参赛身份"},scopedSlots:e._u([{key:"footer",fn:function(){return[t("el-button",{on:{click:function(t){e.showSchoolDialog=!1}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:e.submitSignup}},[e._v(" "+e._s(e.isUserEnrolled?"确定取消":"确定报名")+" ")])]},proxy:!0}]),model:{value:e.showSchoolDialog,callback:function(t){e.showSchoolDialog=t},expression:"showSchoolDialog"}},[t("el-form",[t("el-form-item",{attrs:{label:"参赛单位"}},[t("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择"},model:{value:e.selectedSchool,callback:function(t){e.selectedSchool=t},expression:"selectedSchool"}},e._l(e.schools,(function(e){return t("el-option",{key:e.scId,attrs:{label:e.name,value:e.scId}})})),1)],1)],1)],1)],1)}),Ee=[],ke=new i["default"],xe=function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{visible:e.dialogVisible,title:e.title,width:e.dialogWidth,"append-to-body":!0,"close-on-click-modal":!1,"close-on-press-escape":!0,"custom-class":"form-dialog"},on:{"update:visible":function(t){e.dialogVisible=t},close:e.handleClose},scopedSlots:e._u([{key:"footer",fn:function(){return[e._t("footer",(function(){return[t("el-button",{on:{click:e.handleClose}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:e.handleConfirm}},[e._v("确 定")])]}))]},proxy:!0}],null,!0)},[t("div",{staticClass:"dialog-content"},[e._t("default")],2)])},Ie=[],$e={name:"FormDialog",model:{prop:"modelValue",event:"update:modelValue"},props:{modelValue:Boolean,title:String},data(){return{isMobile:!1}},computed:{dialogVisible:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}},dialogWidth(){return this.isMobile?"70%":"420px"}},created(){this.checkMobile(),window.addEventListener("resize",this.checkMobile)},beforeDestroy(){window.removeEventListener("resize",this.checkMobile)},methods:{checkMobile(){this.isMobile=window.innerWidth<=768},handleClose(){this.$emit("update:modelValue",!1)},handleConfirm(){this.$emit("confirm")}}},Fe=$e,Pe=(0,d.A)(Fe,xe,Ie,!1,null,"0e793626",null),Ae=Pe.exports,Me={name:"GroupCard",props:{groupData:{type:Object,required:!0},isActive:Boolean,isEditMode:Boolean},data(){return{players:[],activePhase:null,currentView:"players",activeGroups:[],loading:!1,detailsLoaded:!1,loadedPhases:new Set,localGroupData:{},groupsCache:new Map,showSchoolDialog:!1,selectedSchool:null,schools:[],userPowerDegree:[],isMobile:!1,currentUserId:null,userRegistrations:[],signupLoading:!1}},created(){this.localGroupData=JSON.parse(JSON.stringify(this.groupData));const e=JSON.parse(localStorage.getItem("userInfo")||"{}");this.userPowerDegree=e.powerDegree||[],this.currentUserId=e.uid,this.checkMobile(),window.addEventListener("resize",this.checkMobile)},beforeDestroy(){window.removeEventListener("resize",this.checkMobile)},watch:{groupData:{handler(e){this.localGroupData=JSON.parse(JSON.stringify(e))},deep:!0},availablePhases:{immediate:!0,handler(e){!(e.length>0)||this.activePhase&&e.find((e=>e.value===this.activePhase))||(this.activePhase=e[0].value)}},activePhase:{handler(e){e&&this.isActive&&!this.loadedPhases.has(e)&&this.loadPhaseDetails(e)},immediate:!0}},computed:{title(){return(0,he.z)(this.groupData)},systemText(){const e=Number(this.groupData.compSystem),t={1:"决赛制",2:"预赛+决赛",3:"预赛+半决赛+决赛"};return t[e]||"未知赛制"},systemTagType(){const e=Number(this.groupData.compSystem),t={1:"success",2:"warning",3:"primary"};return t[e]||"info"},availablePhases(){if(!Array.isArray(this.groupData?.sports))return[];const e=[];return this.groupData.sports.forEach((t=>{if(t&&"undefined"!==typeof t.compType){const s=this.getEventTypeName(t.compType);e.push({label:s,value:String(t.compType)})}})),e},currentPhaseData(){if(!this.activePhase||!Array.isArray(this.localGroupData?.sports))return null;const e=this.localGroupData.sports.find((e=>String(e.compType)===String(this.activePhase)));return e?{...e,compTime:e.gameStartTime&&e.gameEndTime?[e.gameStartTime,e.gameEndTime]:null,venue:e.venue||"",groups:e.groups||[]}:null},currentPhasePlayers(){if(!this.currentPhaseData)return[];if(this.hasDefaultGroup){const e=this.currentPhaseData.groups?.find((e=>-1===e.gid));return e?.players||[]}return this.currentPhaseData.groups?this.currentPhaseData.groups.reduce(((e,t)=>Array.isArray(t.players)?e.concat(t.players):e),[]):[]},hasDefaultGroup(){return this.currentPhaseData?.groups?.some((e=>-1===e.gid))},hasPlayers(){const e=this.currentPhasePlayers;return Array.isArray(e)&&e.length>0},emptyDescription(){const e=parseInt(this.activePhase),t=this.groupData.sports?.[0]?.compType;return e===t?"暂时无人报名":"上一场比赛尚未晋级"},firstEventWithRegistration(){return Array.isArray(this.groupData?.sports)?this.groupData.sports.find((e=>e&&e.appStartTime&&e.appEndTime)):null},registrationPhase(){if(!this.firstEventWithRegistration)return"";const e={1:"预赛",2:"半决赛",3:"决赛"};return e[this.firstEventWithRegistration.compType]||""},eventTypeText(){const e={1:"径赛",2:"田赛"};return e[this.groupData.eventType]||"未知类型"},subEventTypeText(){const e={1:1===this.groupData.eventType?"个人跑":"跳远",2:1===this.groupData.eventType?"接力跑":"三级跳远",3:"铅球",4:"跳高"};return e[this.groupData.subEventType]||"未知项目"},sizeText(){return this.groupData.size?1===this.groupData.eventType?2===this.groupData.subEventType?this.groupData.size:`${this.groupData.size}米`:this.groupData.size:""},showSignupButton(){return this.userPowerDegree.includes(4)},combinedEventTypeText(){const e=this.eventTypeText,t=this.subEventTypeText;return`${e} ${t}`},isUserEnrolled(){return!(!this.currentUserId||!this.currentPhasePlayers)&&this.currentPhasePlayers.some((e=>e.uid===this.currentUserId))},isRegistrationClosed(){const e=Date.now(),t=new Date(this.firstEventWithRegistration?.appEndTime).getTime();return e>t},userRegistrationRecords(){return this.currentPhasePlayers&&this.currentUserId?this.currentPhasePlayers.filter((e=>e.uid===this.currentUserId)).map((e=>({scId:e.scId,pclass:e.pclass,pid:e.pid}))):[]}},methods:{initAthletes(){if(!this.groupData?.sports)return;const e=new Map;this.groupData.sports.forEach((t=>{Array.isArray(t.groups)&&t.groups.forEach((t=>{Array.isArray(t.players)&&t.players.forEach((t=>{t&&t.pid&&e.set(t.pid,{id:t.pid,name:t.name,number:t.number,pclass:t.pclass})}))}))})),this.players=Array.from(e.values())},formatDateTime(e){if(!e)return"待定";try{const t=new Date(e);return isNaN(t.getTime())?(console.error("Invalid date:",e),"待定"):t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})}catch(t){return console.error("Date formatting error:",t),"待定"}},handleDelete(){this.$confirm("确定要删除该赛组吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.$emit("delete")})).catch((()=>{}))},getEventTypeName(e){const t={1:"预赛",2:"半决赛",3:"决赛"};return t[e]||"未知赛段"},async handleCardClick(){if(this.groupData?.id)try{this.isActive||!this.activePhase||this.loadedPhases.has(this.activePhase)||await this.loadPhaseDetails(this.activePhase),this.$emit("toggle",this.groupData.id)}catch(e){console.error("Error in handleCardClick:",e),this.$message.error("操作失败")}else this.$message.warning("赛组数据无效")},getCachedGroups(e){return this.groupsCache.get(e)},setCachedGroups(e,t){this.groupsCache.set(e,t)},async loadPhaseDetails(e){console.log("Loading phase details - compType:",e);const t=this.localGroupData.sports.find((t=>t.compType===Number(e)));if(!t)return;const s=this.getCachedGroups(t.spId);if(s){console.log("Using cached data for spId:",t.spId);const i=this.localGroupData.sports.findIndex((e=>e.spId===t.spId));i>-1&&(this.$set(this.localGroupData.sports[i],"groups",JSON.parse(JSON.stringify(s))),this.loadedPhases.add(e))}else{this.loading=!0;try{const s=await(0,V.A)({url:"/getMatchGroups",method:"get",params:{spId:t.spId}});if(1===s.code){this.setCachedGroups(t.spId,s.data);const i=this.localGroupData.sports.findIndex((t=>t.compType===Number(e)));i>-1&&(this.$set(this.localGroupData.sports[i],"groups",s.data),this.loadedPhases.add(e))}}catch(i){console.error("Error loading phase details:",i),this.$message.error("获取分组数据失败")}finally{this.loading=!1}}},async handleManageGroups(){try{this.loading=!0,console.log("Start loading group data..."),this.localGroupData=JSON.parse(JSON.stringify(this.groupData));const e=this.localGroupData.sports.filter((e=>!this.getCachedGroups(e.spId)));if(e.length>0){const t=e.map((async e=>{try{const t=await(0,V.A)({url:"/getMatchGroups",method:"get",params:{spId:e.spId}});return{success:1===t.code,spId:e.spId,compType:e.compType,data:1===t.code?t.data:[]}}catch(t){return console.error("Error loading groups:",t),{success:!1,spId:e.spId,compType:e.compType,data:[]}}})),s=await Promise.all(t);s.forEach((e=>{if(e.success){this.setCachedGroups(e.spId,e.data);const t=this.localGroupData.sports.findIndex((t=>t.spId===e.spId));t>-1&&this.$set(this.localGroupData.sports[t],"groups",e.data)}}))}this.localGroupData.sports.forEach((e=>{const t=this.getCachedGroups(e.spId);if(t){const s=this.localGroupData.sports.findIndex((t=>t.spId===e.spId));s>-1&&this.$set(this.localGroupData.sports[s],"groups",t)}})),ke.$emit("group-data-init",this.localGroupData),this.$emit("manage-groups",this.localGroupData)}catch(e){console.error("Error in handleManageGroups:",e),this.$message.error("获取分组数据失败")}finally{this.loading=!1}},handleEdit(){console.log("Edit group data:",this.groupData),this.$emit("edit",this.groupData)},checkMobile(){this.isMobile=window.innerWidth<=768},async handleSignup(){if(this.isRegistrationClosed||this.signupLoading)return;this.signupLoading=!0;const e=this.isUserEnrolled;try{if(e){const e=this.userRegistrationRecords;if(0===e.length)return void this.$message.warning("未找到报名记录");1===e.length?await this.submitCancelSignup(e[0].scId):(this.schools=e.map((e=>({scId:e.scId,name:e.pclass}))),this.selectedSchool=null,this.showSchoolDialog=!0)}else{const e=await(0,V.A)({url:"/getUserInfo",method:"get"});if(1===e.code){const t=e.data.joinedSchools;if(!t||0===t.length)return void this.$message.warning("您还未加入任何团体");this.schools=t,1===t.length?(this.selectedSchool=t[0].scId,await this.submitSignup()):this.showSchoolDialog=!0}}}catch(t){console.error("报名操作失败:",t),this.$message.error("操作失败"),e||await this.loadPhaseDetails(this.activePhase)}finally{this.signupLoading=!1}},async submitSignup(){if(this.selectedSchool)if(this.isUserEnrolled)await this.submitCancelSignup(this.selectedSchool);else try{const e=new URLSearchParams;e.append("spId",this.groupData.sports[0].spId),e.append("scId",this.selectedSchool);const t=await(0,V.A)({url:"/signup",method:"post",data:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}});1===t.code?(this.$message.success("报名成功"),this.showSchoolDialog=!1):this.$message.error(t.message||"报名失败")}catch(e){console.error("报名失败:",e),this.$message.error("报名失败")}else this.$message.warning("请选择参赛团体")},async submitCancelSignup(e){try{const t=new URLSearchParams;t.append("spId",this.groupData.sports[0].spId),t.append("scId",e);const s=await(0,V.A)({url:"/cancelSignup",method:"post",data:t,headers:{"Content-Type":"application/x-www-form-urlencoded"}});1===s.code?(this.$message.success("取消报名成功"),this.showSchoolDialog=!1,this.loadPhaseDetails(this.activePhase)):this.$message.error(s.message||"取消报名失败")}catch(t){console.error("取消报名失败:",t),this.$message.error("取消报名失败")}},formatScore:he.y},components:{FormDialog:Ae}},Re=Me,Ne=(0,d.A)(Re,_e,Ee,!1,null,"f57e8dbe",null),Le=Ne.exports,Oe=function(){var e=this,t=e._self._c;return t("div",{staticClass:"group-management"},[t("el-tabs",{staticClass:"phase-tabs",attrs:{type:"card"},model:{value:e.activePhase,callback:function(t){e.activePhase=t},expression:"activePhase"}},e._l(e.localEvents,(function(s){return t("el-tab-pane",{key:s.type,attrs:{label:e.getEventTypeName(s.type),name:String(s.type)}},[t("div",{staticClass:"phase-content"},[t("div",{staticClass:"phase-header"},[t("span",{staticClass:"athletes-count"},[e._v("待分配运动员："+e._s(e.unassignedAthletes.length)+"人")]),t("div",{staticClass:"actions"},[t("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.addNewGroup}},[t("i",{staticClass:"el-icon-plus"}),e._v(" 新建分组 ")]),t("el-button",{attrs:{type:"success",size:"small"},on:{click:e.handleRandomGroup}},[t("i",{staticClass:"el-icon-sort"}),e._v(" 随机分组 ")])],1)]),t("el-row",{attrs:{gutter:20}},[t("el-col",{attrs:{span:8}},[t("div",{staticClass:"panel athlete-panel"},[t("div",{staticClass:"panel-header"},[t("h4",[e._v("待分配运动员")]),t("el-input",{attrs:{size:"small",placeholder:"搜索..."},model:{value:e.searchText,callback:function(t){e.searchText=t},expression:"searchText"}})],1),t("div",{staticClass:"athlete-list"},[t("el-table",{attrs:{data:e.filteredUnassignedAthletes},on:{"selection-change":e.handleSelectionChange}},[t("el-table-column",{attrs:{type:"selection",width:"55"}}),t("el-table-column",{attrs:{prop:"name",label:"姓名"}}),t("el-table-column",{attrs:{prop:"number",label:"号码"}})],1)],1)])]),t("el-col",{attrs:{span:16}},[t("div",{staticClass:"panel groups-panel"},[t("el-collapse",{model:{value:e.activeGroups,callback:function(t){e.activeGroups=t},expression:"activeGroups"}},e._l(e.currentPhaseGroups,(function(s,i){return t("el-collapse-item",{key:i,attrs:{name:i}},[t("template",{slot:"title"},[t("el-input",{staticStyle:{width:"200px"},attrs:{size:"small"},nativeOn:{click:function(e){e.stopPropagation()}},model:{value:s.name,callback:function(t){e.$set(s,"name",t)},expression:"group.name"}}),t("span",{staticClass:"group-count"},[e._v(" ("+e._s(s.players?.length||0)+"人) ")])],1),t("el-table",{attrs:{data:s.players||[],stripe:""}},[t("el-table-column",{attrs:{prop:"name",label:"姓名"}}),t("el-table-column",{attrs:{prop:"number",label:"号码"}}),t("el-table-column",{attrs:{label:"操作",width:"100"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("el-button",{attrs:{type:"text"},on:{click:function(t){return e.removeFromGroup(i,s.$index)}}},[e._v(" 移出 ")])]}}],null,!0)})],1),t("div",{staticClass:"group-footer"},[t("el-button",{attrs:{type:"primary",size:"small",disabled:!e.selectedAthletes.length},on:{click:function(t){return e.assignToGroup(i)}}},[e._v(" 添加选中运动员 ")]),t("el-button",{attrs:{type:"danger",size:"small"},on:{click:function(t){return e.removeGroup(i)}}},[e._v(" 删除分组 ")])],1)],2)})),1)],1)])],1)],1)])})),1)],1)},Ve=[],Ge={name:"GroupManagement",components:{},props:{visible:Boolean,currentPhase:{type:Object,required:!0},events:{type:Array,default:()=>[]},athletes:{type:Array,default:()=>[]}},data(){return{debug:!0,activePhase:null,searchText:"",selectedAthletes:[],activeGroups:[],isMobile:window.innerWidth<768,localEvents:[],localAthletes:[],mobileActivePanel:"unassigned"}},created(){ke.$on("group-data-init",this.initLocalData),(this.events.length>0||this.athletes.length>0)&&(console.log("Initializing with props data:",{events:this.events,athletes:this.athletes}),this.localAthletes=this.athletes.map((e=>({...e,id:e.pid||e.id}))),this.localEvents=this.events.map((e=>({...e,type:e.type||e.compType,groups:Array.isArray(e.groups)?e.groups.map((e=>({...e,id:e.gid||e.id,players:Array.isArray(e.players)?e.players.map((e=>({...e,id:e.pid||e.id}))):[]}))):[]}))),this.localEvents.length>0&&(this.activePhase=String(this.localEvents[0].type)))},beforeDestroy(){ke.$off("group-data-init",this.initLocalData)},watch:{visible:{immediate:!0,async handler(e){if(e){const e=await this.checkEnrollmentStatus();if(!e)return void this.$emit("update:visible",!1);console.log("Dialog opened, initializing data..."),this.initLocalData()}}},athletes:{immediate:!0,handler(e){e&&e.length>0&&(this.localAthletes=JSON.parse(JSON.stringify(e)),console.log("运动员数据已更新到本地:",this.localAthletes))}},activePhase:{immediate:!0,handler(e,t){console.log("Active phase changed:",{from:t,to:e,currentPhaseGroups:this.currentPhaseGroups})}}},computed:{currentPhaseGroups(){const e=this.localEvents.find((e=>String(e.type)===this.activePhase));return e?.groups?e.groups:[]},unassignedAthletes(){const e=new Set,t=this.currentPhaseGroups;t.forEach((t=>{(t.players||[]).forEach((t=>{e.add(t.id)}))}));const s=this.localAthletes.filter((t=>!e.has(t.id)));return console.log("Unassigned athletes:",{total:this.localAthletes.length,assigned:e.size,unassigned:s.length}),s},filteredUnassignedAthletes(){return this.unassignedAthletes.filter((e=>e.name.includes(this.searchText)||e.number.includes(this.searchText)))}},methods:{getEventTypeName(e){return{1:"预赛",2:"半决赛",3:"决赛"}[e]||"未知阶段"},initLocalData(e){if(console.log("Initializing with new data:",e),e||this.localEvents.length){if(e){this.selectedAthletes=[],this.activeGroups=[],this.searchText="";const t=e.sports;if(!Array.isArray(t))return void console.warn("Sports data is not an array:",t);this.localEvents=t.map((e=>{const t=String(e.type||e.compType);return console.log(`Processing event ${t}:`,e),{...e,type:t,groups:Array.isArray(e.groups)?e.groups.map((e=>({...e,id:e.gid||e.id,players:(e.players||[]).map((e=>({...e,id:e.pid||e.id})))}))):[]}}));const s=new Map;this.localEvents.forEach((e=>{e.groups?.forEach((e=>{e.players?.forEach((e=>{(e.pid||e.id)&&s.set(e.pid||e.id,{...e,id:e.pid||e.id})}))}))})),this.localAthletes=Array.from(s.values()),console.log("Initialized athletes:",this.localAthletes)}!this.activePhase&&this.localEvents.length>0&&this.$nextTick((()=>{this.activePhase=String(this.localEvents[0].type),console.log("Setting active phase to:",this.activePhase)}))}else console.log("Skip initialization - no data and no existing local data")},updateLocalData(e){this.localEvents=e.sports?.map((e=>({...e,type:e.compType,groups:e.groups||[]})))||[]},removeFromGroup(e,t){this.currentPhaseGroups[e].players.splice(t,1)},assignToGroup(e){this.currentPhaseGroups[e].players||this.$set(this.currentPhaseGroups[e],"players",[]),this.selectedAthletes.forEach((t=>{const s=JSON.parse(JSON.stringify(t));this.currentPhaseGroups[e].players.push(s)})),this.selectedAthletes=[]},handleAutoGroup(){this.$message.success("自动分组成功")},handleSave(){this.$emit("save",this.localEvents),this.$emit("update:visible",!1)},addNewGroup(){const e=this.localEvents.find((e=>e.type.toString()===this.activePhase));e.groups||this.$set(e,"groups",[]),e.groups.push({id:`group_${Date.now()}`,name:`第${e.groups.length+1}组`,players:[]}),this.activeGroups.push(e.groups.length-1)},handleSelectionChange(e){this.selectedAthletes=e},removeGroup(e){const t=this.localEvents.find((e=>e.type.toString()===this.activePhase));this.$confirm("确定要删除该分组吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{t.groups.splice(e,1),this.activeGroups=this.activeGroups.filter((t=>t!==e))})).catch((()=>{}))},handleTabClick(e){console.log("Tab clicked:",e.name),console.log("Current phase groups:",this.currentPhaseGroups)},async checkEnrollmentStatus(){const e=(new Date).getTime(),t=new Date(this.currentPhase.appEndTime).getTime();return!(e<t+6e5)||(await this.$confirm("当前项目尚未完成报名，暂未自动分组，请于报名结束十分钟后再进行分组管理。","提示",{confirmButtonText:"知道了",showCancelButton:!1,type:"warning"}),!1)},async handleRandomGroup(){try{const e=this.localEvents.find((e=>e.type.toString()===this.activePhase));if(!e?.spId)return void this.$message.error("无法获取比赛ID");const t=await(0,V.A)({url:"/randomGroups",method:"get",params:{spId:e.spId}});1===t.code?(e&&(e.groups=t.data),this.$message.success("随机分组成功")):this.$message.error(t.message||"随机分组失败")}catch(e){console.error("随机分组失败:",e),this.$message.error("随机分组失败")}}}},ze=Ge,Ue=(0,d.A)(ze,Oe,Ve,!1,null,"26c67f6a",null),je=Ue.exports,Je=function(){var e=this,t=e._self._c;return t("responsive-dialog",{attrs:{visible:e.dialogVisible,title:e.title,width:"720px"},on:{"update:visible":function(t){e.dialogVisible=t},confirm:e.handleConfirm,cancel:e.handleCancel},scopedSlots:e._u([{key:"footer",fn:function(){return[t("div",{staticClass:"footer-buttons"},[t("el-button",{staticClass:"btn",on:{click:e.handleCancel}},[e._v("取消")]),e.currentStep>0?t("el-button",{staticClass:"btn",on:{click:e.prevStep}},[e._v("上一步")]):e._e(),e.currentStep<e.totalSteps-1?t("el-button",{staticClass:"btn",attrs:{type:"primary"},on:{click:e.nextStep}},[e._v("下一步")]):e._e(),e.currentStep===e.totalSteps-1?t("el-button",{staticClass:"btn",attrs:{type:"primary"},on:{click:e.handleSubmit}},[e._v("发布")]):e._e()],1)]},proxy:!0}])},[t("div",{staticClass:"steps-wrapper"},[t("simple-steps",{attrs:{steps:[{title:"基本信息",mobileTitle:"基本",icon:"el-icon-edit-outline"},{title:"预赛配置",mobileTitle:"预赛",icon:"el-icon-tickets",disabled:e.form.system<2},{title:"半决赛配置",mobileTitle:"半决",icon:"el-icon-time",disabled:3!==e.form.system},{title:e.form.system>1?"决赛配置":"完成",mobileTitle:"决赛",icon:"el-icon-trophy"},{title:"完成",mobileTitle:"完成",icon:"el-icon-success",isComplete:!0}],active:e.currentStep,showCompleteStep:e.currentStep===e.totalSteps}})],1),t("div",{staticClass:"forms-container"},[t("transition",{attrs:{name:`slide-${e.slideDirection}`}},[t("el-form",{directives:[{name:"show",rawName:"v-show",value:0===e.currentStep,expression:"currentStep === 0"}],ref:"baseForm",staticClass:"form-panel",attrs:{model:e.form,rules:e.rules,"label-width":"120px"}},[t("el-form-item",{attrs:{label:"赛组名称",prop:"name"}},[t("el-input",{model:{value:e.form.name,callback:function(t){e.$set(e.form,"name",t)},expression:"form.name"}})],1),t("el-form-item",{attrs:{label:"比赛类型",required:""}},[t("el-cascader",{attrs:{options:e.eventTypeOptions,props:{expandTrigger:"hover",value:"value",label:"label"},disabled:e.isEditing},on:{change:e.handleEventTypeChange},model:{value:e.form.eventTypes,callback:function(t){e.$set(e.form,"eventTypes",t)},expression:"form.eventTypes"}})],1),t("el-form-item",{attrs:{label:"性别限制",prop:"gender"}},[t("div",{staticClass:"gender-select-group"},[t("el-select",{staticStyle:{width:"160px"},attrs:{placeholder:"请选择性别限制",required:""},model:{value:e.form.gender,callback:function(t){e.$set(e.form,"gender",t)},expression:"form.gender"}},[t("el-option",{attrs:{value:!0,label:"男子项目"}}),t("el-option",{attrs:{value:!1,label:"女子项目"}}),t("el-option",{attrs:{value:null,label:"不限性别"}})],1),e.isEditing||null===e.form.gender?e._e():t("el-checkbox",{attrs:{label:e.form.gender?"同时创建女子赛组":"同时创建男子赛组"},model:{value:e.createOppositeGender,callback:function(t){e.createOppositeGender=t},expression:"createOppositeGender"}})],1)]),e.showSizeInput&&e.isTrackEvent?t("el-form-item",{attrs:{label:"比赛规格",prop:"size"}},[e.isRelayRace?[t("div",{staticClass:"relay-input"},[t("el-input-number",{staticStyle:{width:"120px"},attrs:{min:2,max:8,"controls-position":"right"},model:{value:e.form.relayCount,callback:function(t){e.$set(e.form,"relayCount",t)},expression:"form.relayCount"}}),t("span",{staticClass:"delimiter"},[e._v("×")]),t("el-input-number",{staticStyle:{width:"120px"},attrs:{min:50,step:50,"controls-position":"right"},model:{value:e.form.relayDistance,callback:function(t){e.$set(e.form,"relayDistance",t)},expression:"form.relayDistance"}}),t("span",{staticClass:"unit"},[e._v("米")])],1)]:[t("el-input-number",{staticStyle:{width:"120px"},attrs:{min:50,step:50,"controls-position":"right"},model:{value:e.form.distance,callback:function(t){e.$set(e.form,"distance",t)},expression:"form.distance"}}),t("span",{staticClass:"unit"},[e._v("米")])]],2):e._e(),t("el-form-item",{attrs:{label:"赛制类型",prop:"system"}},[e.isEditing?t("el-tooltip",{attrs:{content:"技术原因暂不支持修改赛制，后续版本可能开放此功能",placement:"top"}},[t("span",[t("el-select",{attrs:{disabled:e.isEditing},on:{change:e.handleSystemChange},model:{value:e.form.system,callback:function(t){e.$set(e.form,"system",t)},expression:"form.system"}},[t("el-option",{attrs:{value:1,label:"决赛制"}}),t("el-option",{attrs:{value:2,label:"预赛+决赛"}}),t("el-option",{attrs:{value:3,label:"预赛+半决赛+决赛"}})],1)],1)]):t("el-select",{on:{change:e.handleSystemChange},model:{value:e.form.system,callback:function(t){e.$set(e.form,"system",t)},expression:"form.system"}},[t("el-option",{attrs:{value:1,label:"决赛制"}}),t("el-option",{attrs:{value:2,label:"预赛+决赛"}}),t("el-option",{attrs:{value:3,label:"预赛+半决赛+决赛"}})],1)],1),t("el-form-item",{attrs:{label:"报名开始时间",prop:"appTimeStart"}},[t("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"datetime",format:"yyyy-MM-dd HH:mm","value-format":"timestamp",placeholder:"开始时间","default-time":"08:00:00"},on:{change:e.handleTimeChange},model:{value:e.form.appTimeStart,callback:function(t){e.$set(e.form,"appTimeStart",t)},expression:"form.appTimeStart"}})],1),t("el-form-item",{attrs:{label:"报名结束时间",prop:"appTimeEnd"}},[t("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"datetime",format:"yyyy-MM-dd HH:mm","value-format":"timestamp",placeholder:"结束时间","default-time":"18:00:00"},on:{change:e.handleTimeChange},model:{value:e.form.appTimeEnd,callback:function(t){e.$set(e.form,"appTimeEnd",t)},expression:"form.appTimeEnd"}})],1),t("el-form-item",{attrs:{label:"评分规则",prop:"rid"}},[t("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择评分规则",filterable:"","popper-append-to-body":!1,"popper-class":"rule-select-dropdown"},model:{value:e.form.rid,callback:function(t){e.$set(e.form,"rid",t)},expression:"form.rid"}},[e._l(e.scoreRules,(function(s){return t("el-option",{key:s.rid,attrs:{label:s.name,value:s.rid}},[t("span",{staticStyle:{float:"left"}},[e._v(e._s(s.name))]),t("span",{staticStyle:{float:"right",color:"#8492a6","font-size":"13px"}},[e._v(" "+e._s(s.units.join(", "))+" ")])])})),t("el-divider"),t("el-option",{attrs:{value:"new"}},[t("div",{staticStyle:{color:"#409EFF"},on:{click:function(t){return t.stopPropagation(),e.handleAddRule.apply(null,arguments)}}},[t("i",{staticClass:"el-icon-plus"}),e._v(" 添加新规则 ")])])],2)],1)],1)],1),t("transition",{attrs:{name:`slide-${e.slideDirection}`}},[1===e.currentStep&&e.form.system>=2?t("el-form",{ref:"preliminaryForm",staticClass:"form-panel phase-config",attrs:{model:e.form.preliminarySettings,"label-width":"120px"}},[t("h3",[e._v("预赛配置")]),t("el-form-item",{attrs:{label:"比赛场地"}},[t("el-input",{staticClass:"short-input",attrs:{placeholder:"请输入比赛场地"},model:{value:e.form.preliminarySettings.venue,callback:function(t){e.$set(e.form.preliminarySettings,"venue",t)},expression:"form.preliminarySettings.venue"}})],1),t("div",{staticClass:"divider-section"},[t("div",{staticClass:"divider-label"},[e._v("自动分组")]),t("el-divider")],1),t("el-form-item",[t("el-checkbox",{on:{change:function(t){return e.handleNoGroupingChange("preliminary")}},model:{value:e.form.preliminarySettings.noGrouping,callback:function(t){e.$set(e.form.preliminarySettings,"noGrouping",t)},expression:"form.preliminarySettings.noGrouping"}},[e._v(" 不需要分组 ")])],1),e.form.preliminarySettings.noGrouping?e._e():t("el-form-item",{attrs:{label:"每组人数"}},[t("el-input-number",{attrs:{min:2},model:{value:e.form.preliminarySettings.playersPerGroup,callback:function(t){e.$set(e.form.preliminarySettings,"playersPerGroup",t)},expression:"form.preliminarySettings.playersPerGroup"}})],1),t("div",{staticClass:"divider-section"},[t("div",{staticClass:"divider-label"},[e._v("晋级设置")]),t("el-divider")],1),t("el-form-item",{attrs:{label:"晋级方式"}},[t("el-select",{model:{value:e.form.preliminarySettings.promotionType,callback:function(t){e.$set(e.form.preliminarySettings,"promotionType",t)},expression:"form.preliminarySettings.promotionType"}},[t("el-option",{attrs:{label:"固定名额",value:"fixed"}}),t("el-option",{attrs:{label:"动态分组",value:"dynamic"}})],1)],1),t("el-form-item",{attrs:{label:e.promotionQuotaLabel("preliminary")}},[t("el-input-number",{attrs:{min:1},model:{value:e.form.preliminarySettings.promotionQuota,callback:function(t){e.$set(e.form.preliminarySettings,"promotionQuota",t)},expression:"form.preliminarySettings.promotionQuota"}})],1)],1):e._e()],1),t("transition",{attrs:{name:`slide-${e.slideDirection}`}},[2===e.currentStep&&3===e.form.system?t("el-form",{ref:"semifinalForm",staticClass:"form-panel phase-config",attrs:{model:e.form.semifinalSettings,"label-width":"120px"}},[t("h3",[e._v("半决赛配置")]),t("el-form-item",{attrs:{label:"比赛场地"}},[t("el-input",{staticClass:"short-input",attrs:{placeholder:"请输入比赛场地"},model:{value:e.form.semifinalSettings.venue,callback:function(t){e.$set(e.form.semifinalSettings,"venue",t)},expression:"form.semifinalSettings.venue"}})],1),t("div",{staticClass:"divider-section"},[t("div",{staticClass:"divider-label"},[e._v("自动分组")]),t("el-divider")],1),t("el-form-item",[t("el-checkbox",{on:{change:function(t){return e.handleNoGroupingChange("semifinal")}},model:{value:e.form.semifinalSettings.noGrouping,callback:function(t){e.$set(e.form.semifinalSettings,"noGrouping",t)},expression:"form.semifinalSettings.noGrouping"}},[e._v(" 不需要分组 ")])],1),e.form.semifinalSettings.noGrouping?e._e():t("el-form-item",{attrs:{label:"每组人数"}},[t("el-input-number",{attrs:{min:2},model:{value:e.form.semifinalSettings.playersPerGroup,callback:function(t){e.$set(e.form.semifinalSettings,"playersPerGroup",t)},expression:"form.semifinalSettings.playersPerGroup"}})],1),t("div",{staticClass:"divider-section"},[t("div",{staticClass:"divider-label"},[e._v("晋级设置")]),t("el-divider")],1),t("el-form-item",{attrs:{label:"晋级方式"}},[t("el-select",{model:{value:e.form.semifinalSettings.promotionType,callback:function(t){e.$set(e.form.semifinalSettings,"promotionType",t)},expression:"form.semifinalSettings.promotionType"}},[t("el-option",{attrs:{label:"固定名额",value:"fixed"}}),t("el-option",{attrs:{label:"动态分组",value:"dynamic"}})],1)],1),t("el-form-item",{attrs:{label:e.promotionQuotaLabel("semifinal")}},[t("el-input-number",{attrs:{min:1},model:{value:e.form.semifinalSettings.promotionQuota,callback:function(t){e.$set(e.form.semifinalSettings,"promotionQuota",t)},expression:"form.semifinalSettings.promotionQuota"}})],1)],1):e._e()],1),t("transition",{attrs:{name:`slide-${e.slideDirection}`}},[e.currentStep===(1===e.form.system?1:2===e.form.system?2:3)?t("el-form",{ref:"finalForm",staticClass:"form-panel phase-config",attrs:{model:e.form.finalSettings,"label-width":"120px"}},[t("h3",[e._v("决赛配置")]),t("el-form-item",{attrs:{label:"比赛场地"}},[t("el-input",{staticClass:"short-input",attrs:{placeholder:"请输入比赛场地"},model:{value:e.form.finalSettings.venue,callback:function(t){e.$set(e.form.finalSettings,"venue",t)},expression:"form.finalSettings.venue"}})],1),t("div",{staticClass:"divider-section"},[t("div",{staticClass:"divider-label"},[e._v("自动分组")]),t("el-divider")],1),t("el-form-item",[t("el-checkbox",{on:{change:function(t){return e.handleNoGroupingChange("final")}},model:{value:e.form.finalSettings.noGrouping,callback:function(t){e.$set(e.form.finalSettings,"noGrouping",t)},expression:"form.finalSettings.noGrouping"}},[e._v(" 不需要分组 ")])],1),e.form.finalSettings.noGrouping?e._e():t("el-form-item",{attrs:{label:"每组人数"}},[t("el-input-number",{attrs:{min:2},model:{value:e.form.finalSettings.playersPerGroup,callback:function(t){e.$set(e.form.finalSettings,"playersPerGroup",t)},expression:"form.finalSettings.playersPerGroup"}})],1)],1):e._e()],1)],1),e.form.showSuccess?t("div",{staticClass:"success-overlay"},[t("div",{staticClass:"success-content"},[t("i",{staticClass:"el-icon-success"}),t("div",{staticClass:"success-message",domProps:{innerHTML:e._s(e.successMessage)}}),t("el-button",{staticClass:"confirm-btn",attrs:{type:"primary",size:"large"},on:{click:e.handleConfirmSuccess}},[e._v(" 我知道了 ")])],1)]):e._e()])},qe=[],Be=function(){var e=this,t=e._self._c;return t("div",{staticClass:"simple-steps"},[t("div",{staticClass:"steps-container"},e._l(e.stepsToShow,(function(s,i){return t("div",{key:i,staticClass:"step",class:{"is-active":i===e.active,"is-completed":i<e.active,"is-disabled":s.disabled}},[t("div",{staticClass:"step-icon"},[i<e.active?t("i",{staticClass:"success-icon"},[e._v("✓")]):t("i",{class:s.icon})]),t("div",{staticClass:"step-info"},[t("span",{staticClass:"step-title",attrs:{"data-mobile-title":s.mobileTitle}},[e._v(" "+e._s(s.title)+" ")])]),i!==e.stepsToShow.length-1?t("div",{staticClass:"step-line"}):e._e()])})),0)])},We=[],He={name:"SimpleSteps",props:{steps:{type:Array,required:!0},active:{type:Number,default:0},showCompleteStep:{type:Boolean,default:!0}},computed:{stepsToShow(){return this.showCompleteStep?this.steps:this.steps.filter((e=>!e.isComplete))}}},Qe=He,Ye=(0,d.A)(Qe,Be,We,!1,null,"5679731c",null),Ze=Ye.exports,Xe={name:"SportDialog",components:{ResponsiveDialog:F.A,SimpleSteps:Ze},props:{visible:{type:Boolean,default:!1},sportData:{type:Object,default:()=>({})},scoreRules:{type:Array,default:()=>[]}},data(){return{dialogVisible:!1,isMobile:!1,activeConfigTab:"promotion",currentStep:0,eventTypeOptions:[{value:1,label:"径赛",children:[{value:1,label:"个人跑"},{value:2,label:"接力跑"}]},{value:2,label:"田赛",children:[{value:1,label:"跳远"},{value:2,label:"三级跳远"},{value:3,label:"铅球"},{value:4,label:"跳高"}]}],form:{...this.getInitialForm(),gender:null,showSuccess:!1,rid:null},createOppositeGender:!1,successMessage:"",rules:{name:[{required:!0,message:"请输入赛组名称",trigger:"blur"}],appTimeStart:[{required:!0,message:"请选择报名开始时间",trigger:"change"}],appTimeEnd:[{required:!0,message:"请选择报名结束时间",trigger:"change"},{validator:this.validateAppTime,trigger:"change"}],eventTypes:[{required:!0,message:"请选择比赛类型",trigger:"change"}],size:[{required:!0,message:"请输入比赛规格",trigger:"blur",validator:(e,t,s)=>{if(this.isTrackEvent)if(t){if(this.isRelayRace){if(!/^\d+\*\d+$/.test(t))return void s(new Error("接力赛格式应为: 人数*距离"))}else if(!/^\d+$/.test(t))return void s(new Error("请输入有效的距离"));s()}else s(new Error("请输入比赛规格"));else s()}}],gender:[{required:!1,trigger:"change",validator:(e,t,s)=>{null===t||!0===t||!1===t?s():s(new Error("请选择性别"))}}],system:[{required:!0,message:"请选择赛制类型",trigger:"change"}],rid:[{required:!0,message:"请选择评分规则",trigger:"change"}]},meetingInfo:null,slideDirection:"left"}},created(){this.checkMobile(),window.addEventListener("resize",this.checkMobile),this.getMeetingInfo()},beforeDestroy(){window.removeEventListener("resize",this.checkMobile)},computed:{title(){return this.sportData&&this.sportData.id?"编辑赛组":"新建赛组"},promotionQuotaLabel(){return function(e){const t=this.form[`${e}Settings`];return"fixed"===t.promotionType?"晋级名额":"每组晋级名额"}},showSizeInput(){return 2===this.form.eventTypes?.length&&this.isTrackEvent},isTrackEvent(){return 1===this.form.eventTypes?.[0]},isRelayRace(){return this.isTrackEvent&&2===this.form.eventTypes?.[1]},isEditing(){return Boolean(this.sportData.id)},sizePlaceholder(){return this.isTrackEvent?this.isRelayRace?"例如: 4*100":"例如: 100":"输入数字"},sizeUnit(){return this.isTrackEvent?"米":""},totalSteps(){return 3===this.form.system?4:2===this.form.system?3:2}},watch:{visible(e){this.dialogVisible=e,e&&this.initForm()},dialogVisible(e){e||this.$emit("update:visible",!1)}},methods:{checkMobile(){this.isMobile=window.innerWidth<=768},getInitialForm(){return{name:"",system:2,appTimeStart:"",appTimeEnd:"",events:[],gender:null,preliminarySettings:{playersPerGroup:4,venue:"",promotionType:"fixed",promotionQuota:8,noGrouping:!1},semifinalSettings:{playersPerGroup:4,venue:"",promotionType:"fixed",promotionQuota:4,noGrouping:!1},finalSettings:{playersPerGroup:4,venue:"",noGrouping:!0},eventTypes:[],eventType:null,subEventType:null,size:"",relayCount:4,relayDistance:100,distance:100,fieldDistance:0,rid:null}},async getMeetingInfo(){try{const e=await(0,V.A)({url:"/getMeetingInfo",method:"get"});1===e.code&&(this.meetingInfo=e.data)}catch(e){console.error("获取比赛信息失败:",e)}},initForm(){if(this.sportData.id){const e=this.sportData.sports?.[0]||{};if(this.form={name:this.sportData.name,system:this.sportData.compSystem,appTimeStart:this.parseISOString(e.appStartTime||this.sportData.appStartTime),appTimeEnd:this.parseISOString(e.appEndTime||this.sportData.appEndTime),eventTypes:[e.eventType||this.sportData.eventType,e.subEventType||this.sportData.subEventType],eventType:e.eventType||this.sportData.eventType,subEventType:e.subEventType||this.sportData.subEventType,size:e.size||"",gender:this.sportData.gender,preliminarySettings:this.initPhaseSettings(this.sportData.sports?.find((e=>1===e.compType))),semifinalSettings:this.initPhaseSettings(this.sportData.sports?.find((e=>2===e.compType))),finalSettings:this.initPhaseSettings(this.sportData.sports?.find((e=>3===e.compType))),rid:this.sportData.rid||e.rid||null},e.size&&this.isTrackEvent)if(this.isRelayRace){const[t,s]=e.size.split("*").map(Number);this.form.relayCount=t||4,this.form.relayDistance=s||100}else this.form.distance=parseInt(e.size)||100}else this.form=this.getInitialForm()},initPhaseSettings(e){return e?{playersPerGroup:e.countPgp||4,venue:e.venue||"",promotionType:e.riseType?"fixed":"dynamic",promotionQuota:e.riseCount||8,noGrouping:!e.countPgp,spId:e.spId}:{playersPerGroup:4,venue:"",promotionType:"fixed",promotionQuota:8,noGrouping:!1}},parseISOString(e){if(!e)return null;const t=new Date(e);return t.getTime()},validateAppTime(e,t,s){if(!this.form.appTimeStart)return s(new Error("请先选择报名开始时间"));if(!this.form.appTimeEnd)return s(new Error("请选择报名结束时间"));const i=Number(this.form.appTimeStart),a=Number(this.form.appTimeEnd);if(a<=i)return s(new Error("报名结束时间必须晚于开始时间"));if(this.meetingInfo?.registrationDeadline){const e=new Date(this.meetingInfo.registrationDeadline).getTime();if(a>e)return s(new Error(`报名截止时间不能超过运动会总报名截止时间: ${this.formatDateTime(e)}`))}s()},handleSystemChange(e){const t=[];e>=2&&t.push({type:1,compTime:null,appTime:[this.form.appTimeStart,this.form.appTimeEnd],groups:null,players:[],finished:!1,promotionType:"fixed",promotionQuota:8,venue:""}),3===e&&t.push({type:2,compTime:null,appTime:null,groups:null,players:[],finished:!1,promotionType:"fixed",promotionQuota:4,venue:""}),t.push({type:3,compTime:null,appTime:1===e?[this.form.appTimeStart,this.form.appTimeEnd]:null,groups:null,players:[],finished:!1,venue:""}),this.$set(this.form,"events",t)},handleTimeChange(){this.$emit("time-change",[this.form.appTimeStart,this.form.appTimeEnd])},handleEventTypeChange(e){console.log("Event type changed:",{value:e,oldSize:this.form.size}),2===e?.length&&(this.form.eventType=e[0],this.form.subEventType=e[1],this.isTrackEvent?this.isRelayRace?(this.form.size=`${this.form.relayCount}*${this.form.relayDistance}`,this.$nextTick((()=>{this.form.size=`${this.form.relayCount}*${this.form.relayDistance}`}))):(this.form.size=String(this.form.distance),this.$nextTick((()=>{this.form.size=String(this.form.distance)}))):this.form.size="",console.log("After event type change:",{eventType:this.form.eventType,subEventType:this.form.subEventType,isTrackEvent:this.isTrackEvent,isRelayRace:this.isRelayRace,newSize:this.form.size}))},async nextStep(){try{let e="baseForm";1===this.currentStep&&(e="preliminaryForm"),2===this.currentStep&&(e="semifinalForm"),3===this.currentStep&&(e="finalForm"),await this.$refs[e].validate(),this.slideDirection="left",this.currentStep++}catch(e){console.log("表单验证失败")}},prevStep(){this.slideDirection="right",this.currentStep--},formatDateTime(e){return new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})},async handleConfirm(){this.handleSubmit()},async validateAllForms(){const e=["baseForm"];this.form.system>=2&&e.push("preliminaryForm"),3===this.form.system&&e.push("semifinalForm"),e.push("finalForm"),await Promise.all(e.map((e=>this.$refs[e].validate())))},handleCancel(){this.dialogVisible=!1,this.$refs.form?.resetFields(),this.currentStep=0},updateSizeField(){this.isTrackEvent?this.isRelayRace?this.form.size=`${this.form.relayCount}*${this.form.relayDistance}`:this.form.size=String(this.form.distance):this.form.size=""},handleNoGroupingChange(e){const t=this.form[`${e}Settings`];t.noGrouping?t.playersPerGroup=null:t.playersPerGroup=4},async handleSubmit(){try{if(!this.form.rid)return void this.$message.error("请选择评分规则");let e;if(e=0===this.currentStep?this.$refs.baseForm:1===this.currentStep&&this.form.system>=2?this.$refs.preliminaryForm:2===this.currentStep&&3===this.form.system?this.$refs.semifinalForm:this.$refs.finalForm,!e)throw new Error("未找到当前表单");await e.validate(),this.updateSizeField();const t={name:this.form.name,compSystem:this.form.system,appStartTime:new Date(Number(this.form.appTimeStart)).toISOString(),appEndTime:new Date(Number(this.form.appTimeEnd)).toISOString(),eventType:this.form.eventTypes[0],subEventType:this.form.eventTypes[1],size:this.form.size,gender:this.form.gender,rid:this.form.rid,sports:[]};if(this.form.system>=2&&t.sports.push({compType:1,countPgp:this.form.preliminarySettings.noGrouping?null:this.form.preliminarySettings.playersPerGroup,venue:this.form.preliminarySettings.venue,riseType:"fixed"===this.form.preliminarySettings.promotionType,riseCount:this.form.preliminarySettings.promotionQuota}),3===this.form.system&&t.sports.push({compType:2,countPgp:this.form.semifinalSettings.noGrouping?null:this.form.semifinalSettings.playersPerGroup,venue:this.form.semifinalSettings.venue,riseType:"fixed"===this.form.semifinalSettings.promotionType,riseCount:this.form.semifinalSettings.promotionQuota}),t.sports.push({compType:3,countPgp:this.form.finalSettings.noGrouping?null:this.form.finalSettings.playersPerGroup,venue:this.form.finalSettings.venue}),this.createOppositeGender&&!this.isEditing&&null!==this.form.gender){const e={...t,gender:!this.form.gender,name:t.name,sports:t.sports.map((e=>({...e})))},[s,i]=await Promise.all([(0,V.A)({url:"/addSport",method:"post",data:t,headers:{"Content-Type":"application/json"}}),(0,V.A)({url:"/addSport",method:"post",data:e,headers:{"Content-Type":"application/json"}})]);if(1!==s.code||1!==i.code)throw new Error("创建对应性别赛组失败");this.form.showSuccess=!0,this.currentStep=this.totalSteps,this.successMessage="<p>发布成功！</p><p>已同时创建对应性别的赛组</p><p>若要为该比赛分配裁判，请到裁判评分页面分配。</p>"}else{const e=await(0,V.A)({url:this.isEditing?"/modifySport":"/addSport",method:"post",data:{...t,mainSpId:this.isEditing?this.sportData.sports?.[0]?.mainSpId||this.sportData.sports?.[1]?.mainSpId||this.sportData.sports?.[2]?.mainSpId:void 0},headers:{"Content-Type":"application/json"}});if(1!==e.code)throw new Error(e.message||"操作失败");this.form.showSuccess=!0,this.currentStep=this.totalSteps,this.successMessage="<p>发布成功！</p><p>若要为该比赛分配裁判，请到裁判评分页面分配。</p>"}}catch(e){console.error("保存失败:",e),this.$message.error(e.message||"保存失败，请检查表单填写是否完整")}},handleAddRule(){this.$message.info('请在"裁判评分"页面完成添加/编辑规则的操作')},handleConfirmSuccess(){this.form.showSuccess=!1,this.dialogVisible=!1,this.currentStep=0,this.$emit("save",this.isEditing?this.sportData:null)}}},Ke=Xe,et=(0,d.A)(Ke,Je,qe,!1,null,null,null),tt=et.exports,st=s(9947),it={components:{GroupCard:Le,GroupManagement:je,ResponsiveDialog:F.A,SportDialog:tt,FilterDropdown:st.A},data(){const e=(e,t,s)=>this.formData.appTimeStart?this.formData.appTimeEnd?Number(this.formData.appTimeEnd)<=Number(this.formData.appTimeStart)?s(new Error("报名结束时间必须晚于开始时间")):void s():s(new Error("请选择报名结束时间")):s(new Error("请先选择报名开始时间"));return{loading:!1,activeGroupId:null,showEditDialog:!1,currentGroup:this.emptyGroup(),groups:[],formData:{name:"",system:2,appTimeStart:"",appTimeEnd:"",events:[],preliminaryPromotionType:"fixed",preliminaryPromotionQuota:8,semifinalPromotionType:"fixed",semifinalPromotionQuota:4,preliminaryAthletePerGroup:4,semifinalAthletePerGroup:4,finalAthletePerGroup:4,preliminaryVenue:"",semifinalVenue:"",finalVenue:""},rules:{name:[{required:!0,message:"请输入赛组名称",trigger:"blur"}],appTimeStart:[{required:!0,message:"请选择报名开始时间",trigger:"change"}],appTimeEnd:[{required:!0,message:"请选择报名结束时间",trigger:"change"},{validator:e,trigger:"change"}]},activeGroupsEdit:[],showGroupManageDialog:!1,activeEventTab:"1",searchUnassigned:"",searchAssigned:"",selectedUnassigned:[],selectedAssigned:[],showMemberDialog:!1,currentGroupEvents:[],currentPhase:{name:"",type:1},activeConfigTab:"promotion",configDialogVisible:!1,venues:["主田径场","副田径场","室内体育馆","训练场"],showAddVenue:!1,newVenue:"",currentFilter:"all",filteredGroups:[],currentStateFilter:"enrolling",currentSystemFilter:"all",currentGenderFilter:"all",currentEventType:"all",currentSubEventType:"all",stateFilterMap:{all:"全部",preparing:"筹备中",enrolling:"报名中",ongoing:"进行中",finished:"已结束"},timeSortMap:{none:"默认",asc:"升序",desc:"降序"},eventTypeMap:{all:"全部",1:"径赛",2:"田赛"},subEventTypeMap:{all:"全部","1-1":"个人跑","1-2":"接力跑","2-1":"跳远","2-2":"三级跳远","2-3":"铅球","2-4":"跳高"},filterOptions:{status:[{value:"all",label:"全部"},{value:"preparing",label:"筹备中"},{value:"enrolling",label:"报名中"},{value:"ongoing",label:"进行中"},{value:"finished",label:"已结束"}],eventType:[{value:"all",label:"全部"},{value:"1",label:"径赛"},{value:"2",label:"田赛"}],system:[{value:"all",label:"全部"},{value:"1",label:"决赛"},{value:"2",label:"预决"},{value:"3",label:"预半决"}],gender:[{value:"all",label:"全部"},{value:"male",label:"男子"},{value:"female",label:"女子"},{value:"unlimited",label:"不限"}]},isMobile:!1,scoreRules:[]}},watch:{"formData.appTimeStart"(e){if(e&&this.currentGroup.events?.[0]){const t=[e];this.formData.appTimeEnd&&t.push(this.formData.appTimeEnd),this.$set(this.currentGroup.events[0],"appTime",t)}},"formData.appTimeEnd"(e){if(e&&this.currentGroup.events?.[0]){const t=[this.formData.appTimeStart];e&&t.push(e),this.$set(this.currentGroup.events[0],"appTime",t)}}},computed:{filteredUnassignedPlayers(){return this.currentGroup?.players?this.currentGroup.players.filter((e=>!this.currentGroupEvents.some((t=>t.groups?.some((t=>t.players?.some((t=>t.id===e.id))))))&&(e.name.includes(this.searchUnassigned)||e.number.includes(this.searchUnassigned)))):[]},filteredAssignedPlayers(){return this.currentGroupEvents.find((e=>e.type===Number(this.activeEventTab)))?.groups?.flatMap((e=>e.players))||[]},getAllAthletes(){const e=new Map;this.currentGroup.events?.forEach((t=>{t.groups?.forEach((t=>{t.players?.forEach((t=>{t.id&&e.set(t.id,t)}))}))}));const t=Array.from(e.values());return console.log("运动员数据已更新:",t),t},displayGroups(){let e=[...this.groups];if("all"!==this.currentStateFilter){const t=Date.now();e=e.filter((e=>{const s=e.sports?.[0];if(!s)return!1;const i=new Date(s.appStartTime).getTime(),a=new Date(s.appEndTime).getTime(),r=e.sports[e.sports.length-1],n=new Date(r.gameEndTime).getTime();switch(this.currentStateFilter){case"preparing":return i>t;case"enrolling":return i<=t&&a>=t;case"ongoing":return a<t&&n>=t;case"finished":return n<t;default:return!0}}))}return"all"!==this.currentEventType&&(e=e.filter((e=>String(e.eventType)===this.currentEventType))),"all"!==this.currentSystemFilter&&(e=e.filter((e=>String(e.compSystem)===this.currentSystemFilter))),"all"!==this.currentGenderFilter&&(e=e.filter((e=>{switch(this.currentGenderFilter){case"male":return!0===e.gender;case"female":return!1===e.gender;case"unlimited":return null===e.gender;default:return!0}}))),e},stateFilterText(){return this.stateFilterMap[this.currentStateFilter]},timeSortText(){return this.timeSortMap[this.currentTimeSort]},eventTypeText(){return this.eventTypeMap[this.currentEventType]},subEventTypeText(){const e="all"===this.currentEventType?"all":`${this.currentEventType}-${this.currentSubEventType}`;return this.subEventTypeMap[e]||"全部"}},created(){const e=JSON.parse(localStorage.getItem("userInfo")||"{}"),t=e.powerDegree||[];this.isEditMode=t.includes(5),this.currentStateFilter=t.includes(5)?"all":"enrolling"},methods:{emptyGroup(){const e=Date.now(),t=e+864e5;return{isEditMode:!1,id:null,name:"",system:2,signupCount:0,players:[],sports:[{type:1,compTime:null,appTime:[e,t],groups:null,players:[],finished:!1,promotionType:"fixed",promotionQuota:8,venue:""},{type:3,compTime:null,groups:null,players:[],finished:!1,venue:""}]}},toggleGroup(e){if(!e)return;const t=String(e);this.activeGroupId=this.activeGroupId===t?null:t},openEditDialog(e){try{if(!e||!e.sports?.[0]?.mainSpId)return void this.$message.warning("无效的赛组数据");this.currentGroup={id:e.id,name:e.name,compSystem:e.compSystem,sports:JSON.parse(JSON.stringify(e.sports)),eventType:e.eventType,subEventType:e.subEventType,size:e.size,gender:e.gender},this.showEditDialog=!0}catch(t){console.error("Error in openEditDialog:",t),this.$message.error("打开编辑对话框失败")}},async saveGroup(){try{await this.fetchSports(),this.showEditDialog=!1}catch(e){console.error("Error refreshing sports list:",e),this.$message.error("刷新数据失败")}},async deleteGroup(e){try{const t=e.sports[0].mainSpId;if(!t)return void this.$message.error("获取赛组ID失败");const s=await(0,V.A)({url:"/deleteSport",method:"get",params:{mainSpId:t}});if(1===s.code){const t=this.groups.findIndex((t=>t.id===e.id));this.groups.splice(t,1),this.$message.success("删除成功")}}catch(t){console.error("删除赛组失败:",t),this.$message.error("删除赛组失败")}},handleTimeChange(){this.currentGroup.events?.[0]&&this.$set(this.currentGroup.events[0],"appTime",[this.formData.appTimeStart,this.formData.appTimeEnd])},handleSystemChange(e){const t=[],s=this.currentGroup.events||[],i=[this.formData.appTimeStart,this.formData.appTimeEnd],a=e=>s.find((t=>t.type===e));if(e>=2){const e=a(1);t.push({type:1,compTime:e?.compTime||null,appTime:i[0]&&i[1]?i:[Date.now(),Date.now()+864e5],groups:e?.groups||null,players:e?.players||[],finished:e?.finished||!1,promotionType:e?.promotionType||this.formData.preliminaryPromotionType,promotionQuota:e?.promotionQuota||this.formData.preliminaryPromotionQuota,venue:e?.venue||this.formData.preliminaryVenue})}if(3===e){const e=a(2);t.push({type:2,compTime:e?.compTime||null,groups:e?.groups||null,players:e?.players||[],finished:e?.finished||!1,promotionType:e?.promotionType||this.formData.semifinalPromotionType,promotionQuota:e?.promotionQuota||this.formData.semifinalPromotionQuota,venue:e?.venue||this.formData.semifinalVenue})}const r=a(3);t.push({type:3,compTime:r?.compTime||null,appTime:1===e?i:null,groups:r?.groups||null,players:r?.players||[],finished:r?.finished||!1,venue:r?.venue||this.formData.finalVenue}),this.$set(this.currentGroup,"events",t)},handleAppTimeChange(e){if(e){const t=this.currentGroup.events[0];t&&this.$set(t,"appTime",e)}},resetForm(){this.$refs.groupForm?.resetFields(),this.formData={name:"",system:2,appTimeStart:"",appTimeEnd:"",events:[],preliminaryPromotionType:"fixed",preliminaryPromotionQuota:8,semifinalPromotionType:"fixed",semifinalPromotionQuota:4,preliminaryAthletePerGroup:4,semifinalAthletePerGroup:4,finalAthletePerGroup:4,preliminaryVenue:"",semifinalVenue:"",finalVenue:""},this.currentGroup=this.emptyGroup()},handleCreate(){this.currentGroup=this.emptyGroup(),this.showEditDialog=!0},getEventTypeName(e){const t={1:"预赛",2:"半决赛",3:"决赛"};return t[e]||"未知赛段"},addGroup(e){this.formData.events[e].groups||this.$set(this.formData.events[e],"groups",[]);const t={id:`temp_${Date.now()}`,name:`第${this.formData.events[e].groups.length+1}组`,compTime:null,players:[]};this.formData.events[e].groups.push(t),this.activeGroupsEdit.push(`${e}-${this.formData.events[e].groups.length-1}`)},removeGroup(e,t){this.$confirm("确定要删除该分组吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.formData.events[e].groups.splice(t,1),this.activeGroupsEdit=this.activeGroupsEdit.filter((s=>s!==`${e}-${t}`))})).catch((()=>{}))},openGroupManageDialog(e){this.currentGroup=JSON.parse(JSON.stringify({...e,players:e.players||[]})),this.currentGroupEvents=this.currentGroup.events||[],this.showGroupManageDialog=!0},addNewGroup(e){e.groups||this.$set(e,"groups",[]),e.groups.push({id:`temp_${Date.now()}`,name:"新分组",compTime:null,players:[]})},editGroupMembers(e){this.currentGroup=e,this.showMemberDialog=!0},deleteGroupFromEvent(e,t){e.groups.splice(t,1)},assignMembers(){const e=this.currentGroupEvents.find((e=>e.type===Number(this.activeEventTab))),t=e.groups.find((e=>e.id===this.currentGroup.id));this.selectedUnassigned.forEach((e=>{const s=this.currentGroup.players.find((t=>t.id===e));t.players.push(s)})),this.selectedUnassigned=[]},unassignMembers(){const e=this.currentGroupEvents.find((e=>e.type===Number(this.activeEventTab))),t=e.groups.find((e=>e.id===this.currentGroup.id));this.selectedAssigned.forEach((e=>{const s=t.players.findIndex((t=>t.id===e));t.players.splice(s,1)})),this.selectedAssigned=[]},async openGroupManagement(e){if(!e||"object"!==typeof e)return void this.$message.warning("无效的赛组数据");const t=(new Date).getTime(),s=new Date(e.appEndTime).getTime();t<s+6e5?await this.$confirm("当前项目尚未完成报名，暂未自动分组，请于报名结束十分钟后再进行分组管理。","提示",{confirmButtonText:"知道了",showCancelButton:!1,type:"warning"}):(this.currentPhase={name:e.name||"",type:e.compSystem||1,appEndTime:e.appEndTime},this.currentGroup=e,this.showGroupManageDialog=!0)},handleGroupsSave(e){const t=this.groups.findIndex((e=>e.id===this.currentGroup.id));if(t>-1){const s={...this.groups[t]};s.events=e,this.$set(this.groups,t,s)}},showConfig(){this.configDialogVisible=!0},saveConfig(){this.configDialogVisible=!1,this.$message.success("保存成功")},addVenue(){this.showAddVenue=!0,this.$nextTick((()=>{this.$refs.newVenueInput.focus()}))},handleAddVenue(){this.newVenue&&(this.venues.includes(this.newVenue)||this.venues.push(this.newVenue),this.newVenue=""),this.showAddVenue=!1},handleDeleteVenue(e){this.$confirm("确定要删除该场地吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{this.venues.splice(e,1)})).catch((()=>{}))},handleAutoGroup(e){this.$message.success((1===e?"预赛":2===e?"半决赛":"决赛")+"自动分组成功")},async fetchSports(){this.loading=!0;try{const e=await(0,V.A)({url:"/getSports",method:"get"});1===e.code&&(this.groups=e.data.map((e=>({...e,id:e.id||`group_${Date.now()}_${Math.random()}`}))),this.filterGroups())}catch(e){this.$message.error("获取运动项目数据失败")}finally{this.loading=!1}},handleFilterChange(){this.filterGroups()},filterGroups(){const e=Date.now();this.filteredGroups=this.groups.filter((t=>{const s=t.sports?.[0];if(!s)return!1;const i=new Date(s.appStartTime).getTime(),a=t.sports[t.sports.length-1],r=new Date(a.gameEndTime).getTime(),n=new Date(s.appEndTime).getTime();switch(this.currentFilter){case"preparing":return i>e;case"enrolling":return i<=e&&n>=e;case"ongoing":return n<e&&r>=e;case"finished":return r<e;default:return!0}}))},handleStateFilter(e){this.currentStateFilter=e},handleTimeSort(e){this.currentTimeSort=e},handleEventTypeFilter(e){this.currentEventType=e,this.currentSubEventType="all"},handleSubEventFilter(e){this.currentSubEventType=e},handleSystemFilter(e){this.currentSystemFilter=e},handleGenderFilter(e){this.currentGenderFilter=e},checkMobile(){this.isMobile=window.innerWidth<=768},async fetchScoreRules(){try{const e=await(0,V.A)({url:"/getJudgeRules",method:"get"});1===e.code&&(this.scoreRules=e.data.map((e=>({...e,units:e.units.replace(/^\[|\]$/g,"").split(","),mappings:"string"===typeof e.mappings?new Map(Object.entries(JSON.parse(e.mappings))):new Map(Object.entries(e.mappings)),isRankMode:!0===e.isRankMode||"1"===e.isRankMode||1===e.isRankMode}))))}catch(e){console.error("获取评分规则失败:",e),this.$message.error("获取评分规则失败")}}},mounted(){this.fetchSports(),this.checkMobile(),window.addEventListener("resize",this.checkMobile),this.fetchScoreRules()},beforeDestroy(){window.removeEventListener("resize",this.checkMobile)}},at=it,rt=(0,d.A)(at,Te,De,!1,null,"33b4eb15",null),nt=rt.exports,ot=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"judge-management"},[t("div",{staticClass:"action-bar"},[t("div",{staticClass:"filter-container"},[t("FilterDropdown",{attrs:{options:e.filterOptions.status,label:"状态","default-value":e.defaultStateFilter},on:{change:e.handleStateFilter},model:{value:e.currentStateFilter,callback:function(t){e.currentStateFilter=t},expression:"currentStateFilter"}}),t("FilterDropdown",{attrs:{options:e.filterOptions.time,label:"时间","default-value":"none"},on:{change:e.handleTimeSort},model:{value:e.currentTimeSort,callback:function(t){e.currentTimeSort=t},expression:"currentTimeSort"}}),t("FilterDropdown",{attrs:{options:e.filterOptions.compType,label:"赛型","default-value":"all"},on:{change:e.handleCompTypeFilter},model:{value:e.currentCompType,callback:function(t){e.currentCompType=t},expression:"currentCompType"}}),e.canModifyRule?t("el-button",{staticClass:"rule-config-btn",attrs:{type:"primary"},on:{click:e.showRuleManagement}},[t("i",{staticClass:"el-icon-setting"}),e._v(" 配置规则 ")]):e._e()],1)]),t("transition-group",{staticClass:"competition-list",class:{"has-active":e.activeCompetitionId},attrs:{name:"card-list",tag:"div"}},[e._l(e.filteredCompetitions,(function(s){return t("judge-competition-card",{key:s.spId,attrs:{"competition-data":s,"is-active":e.activeCompetitionId===s.spId,"is-edit-mode":e.isEditMode,"score-rules":e.scoreRules,"available-judges":e.availableJudges,"loading-judges":e.loadingJudges},on:{toggle:e.toggleCompetition,"score-change":e.handleScoreChange,"rule-create":e.showRuleManagement,"rule-select":e.handleRuleSelect,"fetch-judges":e.fetchAvailableJudges}})})),0===e.filteredCompetitions.length?t("el-empty",{key:"empty",attrs:{description:e.emptyTipText}}):e._e()],2),t("score-rule-dialog",{attrs:{visible:e.ruleDialogVisible,"edit-data":e.currentRule,"use-global-mask":!1},on:{"update:visible":function(t){e.ruleDialogVisible=t},save:e.handleRuleSave,close:e.handleRuleDialogClose}}),t("responsive-dialog",{attrs:{title:"评分规则管理",visible:e.ruleManageVisible,width:"900px","use-global-mask":!0},on:{"update:visible":function(t){e.ruleManageVisible=t}}},[t("div",{staticClass:"rules-container"},[t("div",{staticClass:"rules-header"},[t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.showRuleDialog()}}},[e._v("添加规则")])],1),t("el-table",{staticClass:"mapping-table",staticStyle:{width:"100%"},attrs:{data:e.scoreRules,border:""}},[t("el-table-column",{attrs:{prop:"name",label:"规则名称"}}),t("el-table-column",{attrs:{label:"计量单位"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.units.join(", "))+" ")]}}])}),t("el-table-column",{attrs:{label:"映射数量"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(Object.keys(t.row.mappings).length)+" ")]}}])}),t("el-table-column",{attrs:{label:"使用中",width:"100"},scopedSlots:e._u([{key:"default",fn:function(s){return[e.isRuleInUse(s.row.rid)?t("el-tag",{attrs:{type:"success",size:"small"}},[e._v("是")]):t("el-tag",{attrs:{type:"info",size:"small"}},[e._v("否")])]}}])}),t("el-table-column",{attrs:{label:"操作",width:"200"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(t){return e.editRule(s.row)}}},[e._v("编辑")]),t("el-button",{attrs:{type:"danger",size:"small"},on:{click:function(t){return e.deleteRule(s.row)}}},[e._v("删除")])]}}])})],1)],1)])],1)},lt=[],ct=function(){var e=this,t=e._self._c;return t("div",{staticClass:"competition-card",class:{"is-active":e.isActive}},[t("div",{staticClass:"card-header",on:{click:e.handleToggle}},[t("div",{staticClass:"competition-info"},[t("div",{staticClass:"title-row"},[t("h3",[e._v(e._s(e.title))]),t("span",{staticClass:"comp-type"},[e._v(e._s(e.getCompTypeText(e.competition.compType)))])]),t("div",{staticClass:"time-info"},[t("i",{staticClass:"el-icon-time"}),t("span",[e._v("比赛时间: "+e._s(e.formatTime(e.competition.gameStartTime)))])])]),t("div",{staticClass:"status-tags"},[t("el-tag",{attrs:{type:e.getStatusType(e.competition.status),size:"small"}},[e._v(e._s(e.getStatusText(e.competition.status)))]),e.competition.venue?t("el-tag",{attrs:{type:"info",size:"small"}},[e._v(e._s(e.competition.venue))]):e._e()],1)]),t("div",{directives:[{name:"show",rawName:"v-show",value:e.isActive,expression:"isActive"}],staticClass:"card-content"},[e.canModifyRule?t("div",{staticClass:"rule-select"},[t("el-select",{attrs:{placeholder:"选择评分规则",filterable:""},on:{change:e.handleRuleChange},model:{value:e.selectedRuleId,callback:function(t){e.selectedRuleId=t},expression:"selectedRuleId"}},[e._l(e.scoreRules,(function(e){return t("el-option",{key:e.rid,attrs:{label:`${e.name} (${e.units.join(",")})`,value:e.rid}})})),t("el-divider"),t("el-option",{attrs:{value:"new"}},[t("div",{on:{click:e.handleAddRule}},[t("i",{staticClass:"el-icon-plus"}),e._v(" 添加新规则 ")])])],2)],1):e._e(),e.canModifyRule&&e.competition.status<2?t("div",{staticClass:"status-alert"},[t("el-alert",{attrs:{type:"warning",closable:!1,"show-icon":""}},[e._v(" 比赛尚未开始评分阶段 ")])],1):e._e(),e.groups.length>0?t("div",{staticClass:"groups-tabs"},[e.judgeGroup?t("div",{staticClass:"judges-section"},[e._m(0),t("div",{staticClass:"judges-list"},[e._l(e.judgeGroup.players,(function(s){return t("div",{key:s.uid,staticClass:"judge-item",class:{"is-current":s.uid===e.currentUid}},[t("el-avatar",{attrs:{size:32,src:s.head}},[e._v(" "+e._s(s.name.charAt(0))+" ")]),t("span",{staticClass:"judge-name"},[e._v(e._s(s.name))]),s.uid===e.currentUid?t("el-tag",{attrs:{size:"mini",type:"warning"}},[e._v("我")]):e._e()],1)})),e.canAssignJudges?t("div",{staticClass:"judge-item assign-btn",on:{click:e.showAssignJudge}},[t("el-avatar",{attrs:{size:32,icon:"el-icon-plus"}}),t("span",{staticClass:"judge-name"},[e._v("分配裁判")])],1):e._e()],2)]):e._e(),e.judgeGroup?t("el-divider"):e._e(),e.currentUserInfo?t("div",{staticClass:"athlete-item current-athlete"},[t("div",{staticClass:"athlete-info"},[t("el-avatar",{attrs:{size:40,src:e.currentUserInfo.head||null}},[e._v(" "+e._s(e.currentUserInfo.name.charAt(0))+" ")]),t("div",{staticClass:"details"},[t("div",{staticClass:"name"},[e._v(" "+e._s(e.currentUserInfo.name)+" "),t("el-tag",{staticClass:"group-tag",attrs:{size:"mini",type:"primary"}},[e._v(" "+e._s(e.currentUserInfo.groupName)+" ")])],1),t("div",{staticClass:"meta"},[t("span",[e._v("编号："+e._s(e.currentUserInfo.number))]),t("span",[e._v("班级："+e._s(e.currentUserInfo.pClass))])])])],1),t("div",{staticClass:"score-area"},[e.isEditMode&&!e.currentUserInfo.score?[t("multi-unit-input",{attrs:{units:e.currentRule.units},on:{enter:function(t){return e.handleEnter(e.currentUserInfo)},"tab-last":function(t){return e.submitScore(e.currentUserInfo)}},model:{value:e.scoreInputs[e.currentUserInfo.pid],callback:function(t){e.$set(e.scoreInputs,e.currentUserInfo.pid,t)},expression:"scoreInputs[currentUserInfo.pid]"}})]:[t("div",{staticClass:"score-display"},[t("span",{staticClass:"score"},[e._v(e._s(e.formatScore(e.currentUserInfo.score)))]),e.currentUserInfo.degree?t("span",{staticClass:"points"},[e._v(e._s(e.currentUserInfo.degree)+"分")]):e._e()]),e.isEditMode&&e.currentUserInfo.score?t("el-button",{attrs:{type:"text",size:"small"},on:{click:function(t){return e.enableEdit(e.currentUserInfo)}}},[e._v(" 修改 ")]):e._e()]],2)]):e._e(),e.currentUserInfo?t("el-divider",{staticClass:"thin-divider"}):e._e(),t("div",{staticClass:"tabs-container"},[t("el-tabs",{on:{"tab-click":e.handleGroupChange},model:{value:e.activeGroupIndex,callback:function(t){e.activeGroupIndex=t},expression:"activeGroupIndex"}},e._l(e.athleteGroups,(function(s,i){return t("el-tab-pane",{key:s.gid||i,attrs:{label:s.name,name:String(i)}},[t("div",{staticClass:"athletes-list"},e._l(e.sortedAthletes,(function(s){return t("div",{key:s.pid,staticClass:"athlete-item",class:{"is-current":s.pid===e.pid||s.uid===e.currentUid,"has-score":s.score}},[t("div",{staticClass:"athlete-info"},[t("el-avatar",{attrs:{size:40,src:s.head}},[e._v(" "+e._s(s.name.charAt(0))+" ")]),t("div",{staticClass:"details"},[t("div",{staticClass:"name"},[e._v(" "+e._s(s.name)+" "),s.number?t("el-tag",{attrs:{size:"mini",type:"info"}},[e._v(" #"+e._s(s.number)+" ")]):e._e(),s.uid===e.currentUid?t("el-tag",{attrs:{size:"mini",type:"warning"}},[e._v(" 我 ")]):e._e()],1),t("div",{staticClass:"meta"},[t("span",[e._v("团体："+e._s(s.pclass))])])])],1),t("div",{staticClass:"score-area"},[e.isEditMode&&!s.score?[t("multi-unit-input",{attrs:{units:e.currentRule.units},on:{enter:function(t){return e.handleEnter(s)},"tab-last":function(t){return e.submitScore(s)}},model:{value:e.scoreInputs[s.pid],callback:function(t){e.$set(e.scoreInputs,s.pid,t)},expression:"scoreInputs[athlete.pid]"}})]:[t("div",{staticClass:"score-display"},[t("span",{staticClass:"score"},[e._v(e._s(e.formatScore(s.score)))]),s.degree?t("span",{staticClass:"points"},[e._v(e._s(s.degree)+"分")]):e._e()]),e.isEditMode&&s.score?t("el-button",{attrs:{type:"text",size:"small"},on:{click:function(t){return e.enableEdit(s)}}},[e._v(" 修改 ")]):e._e()]],2)])})),0)])})),1)],1)],1):t("el-empty",{attrs:{description:"暂无分组数据"}})],1),t("assign-judge-dialog",{attrs:{visible:e.assignDialogVisible,judges:e.availableJudges,loading:e.loadingJudges,"current-judges":e.judgeGroup?.players||[]},on:{"update:visible":function(t){e.assignDialogVisible=t},confirm:e.handleAssignJudges}})],1)},dt=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"header-section"},[t("h4",[e._v("裁判组")])])}],ut=s(1981),pt=function(){var e=this,t=e._self._c;return t("div",{staticClass:"multi-unit-input"},[t("div",{staticClass:"input-container"},e._l(e.units,(function(s,i){return t("div",{key:`unit-${s}-${i}`,staticClass:"input-group"},[t("div",{staticClass:"input-wrapper"},[t("span",{directives:[{name:"show",rawName:"v-show",value:e.localValue[i],expression:"localValue[index]"}],staticClass:"unit-label"},[e._v(e._s(s))]),t("input",{class:{"is-focused":e.focusedIndex===i},attrs:{type:"number",placeholder:s},domProps:{value:e.localValue[i]},on:{input:function(t){return e.handleInputChange(t,i)},keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleEnter.apply(null,arguments)},blur:e.handleBlur,focus:function(t){return e.handleFocus(i)}}})]),i<e.units.length-1?t("div",{staticClass:"separator"},[e._v(":")]):e._e()])})),0),e.duplicateError?t("div",{staticClass:"error-tip"},[e._v(" "+e._s(e.duplicateError)+" ")]):e._e()])},mt=[],ht={name:"MultiUnitInput",props:{value:{type:Array,default:()=>[]},units:{type:Array,required:!0}},data(){return{localValue:[],focusedIndex:-1,duplicateError:"",blurredInputs:new Set,submitDebounceTimer:null}},watch:{units:{immediate:!0,handler(e){const t=e.filter(((t,s)=>t&&e.indexOf(t)!==s));t.length>0?(this.duplicateError=`单位"${t[0]}"重复使用`,this.$emit("error",this.duplicateError)):(this.duplicateError="",this.$emit("error",""))}},value:{immediate:!0,handler(e){this.localValue=[...e],this.localValue.length<this.units.length&&(this.localValue=this.localValue.concat(Array(this.units.length-this.localValue.length).fill("")))}}},methods:{handleInputChange(e,t){const s=[...this.localValue];s[t]=e.target.value,this.$emit("input",s)},handleTab(e){e===this.units.length-1&&this.$emit("tab-last")},handleFocus(e){this.focusedIndex=e,this.blurredInputs.delete(e)},handleEnter(){clearTimeout(this.submitDebounceTimer),this.submitDebounceTimer=setTimeout((()=>{this.validate()&&(this.$emit("enter"),this.blurredInputs.clear())}),200)},handleBlur(){this.blurredInputs.add(this.focusedIndex),this.focusedIndex=-1,this.blurredInputs.size===this.units.length&&(clearTimeout(this.submitDebounceTimer),this.submitDebounceTimer=setTimeout((()=>{this.validate()&&this.$emit("enter"),this.blurredInputs.clear()}),200));const e=this.localValue.map((e=>e||"0"));this.$emit("input",e)},validate(){const e=1===this.units.length,t=this.localValue.every((t=>{const s=Number(t);return!(!t||isNaN(s))&&(e?!isNaN(parseFloat(t)):Number.isInteger(s)&&s>=0)}));return t&&(this.localValue=this.localValue.map((e=>e||"0")),this.$emit("input",this.localValue)),t}},beforeDestroy(){clearTimeout(this.submitDebounceTimer)}},gt=ht,ft=(0,d.A)(gt,pt,mt,!1,null,"03c0bd48",null),vt=ft.exports,yt=function(){var e=this,t=e._self._c;return t("responsive-dialog",{attrs:{visible:e.dialogVisible,title:"分配裁判"},on:{"update:visible":function(t){e.dialogVisible=t},close:e.handleClose,confirm:e.handleConfirm}},[t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"judge-list"},[e.error?t("div",{staticClass:"error-message"},[t("i",{staticClass:"el-icon-warning"}),t("span",[e._v(e._s(e.error))])]):e._e(),e.loading&&!e.judges.length?t("el-alert",{attrs:{type:"info",closable:!1,title:"正在加载可用裁判..."}}):e.loading||e.judges.length?e._e():t("el-alert",{attrs:{type:"warning",closable:!1,title:"暂无可用裁判"}}),t("el-checkbox-group",{model:{value:e.selectedJudges,callback:function(t){e.selectedJudges=t},expression:"selectedJudges"}},e._l(e.judges,(function(s){return t("div",{key:s.uid,staticClass:"judge-item"},[t("el-checkbox",{attrs:{label:s.uid}},[t("div",{staticClass:"judge-info"},[t("el-avatar",{attrs:{size:32,src:s.head}},[e._v(e._s(s.name.charAt(0)))]),t("span",{staticClass:"judge-name"},[e._v(e._s(s.name))])],1)])],1)})),0)],1)])},bt=[],wt={name:"AssignJudgeDialog",components:{ResponsiveDialog:F.A},props:{visible:Boolean,judges:{type:Array,default:()=>[]},currentJudges:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1}},data(){return{selectedJudges:[],error:""}},computed:{dialogVisible:{get(){return this.visible},set(e){this.$emit("update:visible",e)}}},watch:{visible(e){e&&(this.error="",this.selectedJudges=this.currentJudges.map((e=>e.uid)))}},methods:{handleClose(){this.$emit("update:visible",!1)},handleConfirm(){0!==this.selectedJudges.length?this.$emit("confirm",this.selectedJudges):this.error="请至少选择一名裁判"}}},St=wt,Ct=(0,d.A)(St,yt,bt,!1,null,"88d0d540",null),Tt=Ct.exports,Dt={name:"JudgeCompetitionCard",components:{MultiUnitInput:vt,AssignJudgeDialog:Tt},props:{competitionData:{type:Object,required:!0},isActive:Boolean,pid:{type:Number,required:!1},scoreRules:{type:Array,default:()=>[]},availableJudges:{type:Array,default:()=>[]},loadingJudges:{type:Boolean,default:!1}},data(){return{groups:[],activeGroupIndex:"0",selectedRuleId:null,scoreInputs:{},competition:this.competitionData,isSubmitting:!1,currentUid:null,userInfo:JSON.parse(localStorage.getItem("userInfo")||"{}"),assignDialogVisible:!1}},computed:{canModifyRule(){return this.judgeGroup?.players?.some((e=>e.uid===this.currentUid))},isEditMode(){return this.canModifyRule&&3===this.competition.status},currentRule(){const e=this.selectedRuleId||this.competition.rid;return this.scoreRules.find((t=>t.rid===e))||{units:[]}},currentUserInfo(){for(const e of this.groups){const t=e.players?.find((e=>e.pid===this.pid));if(t)return{...t,groupName:e.name}}return null},sortedAthletes(){const e=this.athleteGroups[this.activeGroupIndex];return e?.players?.length?e.players:[]},judgeGroup(){return this.groups.find((e=>0===e.gid))||{players:[]}},athleteGroups(){return this.groups.filter((e=>0!==e.gid&&Array.isArray(e.players)))},title(){return(0,he.z)(this.competition)},canAssignJudges(){const e=JSON.parse(localStorage.getItem("userInfo")||"{}");return e.powerDegree?.includes(5)}},watch:{competitionData:{immediate:!0,handler(e){this.competition=e,this.selectedRuleId=e.rid,this.isActive&&this.fetchGroups()}},isActive:{immediate:!1,handler(e){e&&this.fetchGroups()}},groups:{immediate:!0,handler(e){e?.length>0&&(this.activeGroupIndex="0")}}},methods:{handleToggle(){console.log("卡片点击:",this.competition.spId),this.$emit("toggle",this.competition.spId)},formatTime(e){return e?(0,ut.Y)(e,"MM-DD HH:mm"):"待定"},getStatusType(e){const t={1:"info",2:"warning",3:"primary",4:"success",5:"info"};return t[e]||"info"},getStatusText(e){const t={1:"报名中",2:"分配中",3:"待评分",4:"已评分",5:3===this.competition.compType?"已结束":"已晋级"};return t[e]||"未知状态"},async fetchGroups(){console.log("获取分组数据:",this.competition.spId);try{const e=await(0,V.A)({url:"/getJudgementGroups",method:"get",params:{spId:this.competition.spId}});1===e.code&&(this.groups=Array.isArray(e.data)?e.data:[])}catch(e){console.error("获取分组数据失败:",e),this.$message.error("获取分组数据失败")}},handleGroupChange(e){this.activeGroupIndex=e.name},enableEdit(e){const t="string"===typeof e.score?JSON.parse(e.score.replace(/=/g,":").replace(/([^:,\s{}]+)/g,'"$1"')):e.score,s=this.currentRule.units,i=s.map((e=>t[e]||""));this.$set(this.scoreInputs,e.pid,i),this.$set(e,"score",null)},canJudge(){const e=(new Date).getTime(),t=new Date(this.competition.gameStartTime).getTime();return e>=t},handleTab(e,t){t===this.currentRule.units.length-1&&this.submitScore(e)},handleEnter(e){this.submitScore(e)},formatScore(e){if(!e)return"暂无成绩";if("string"===typeof e)try{const t=e.replace(/[{}]/g,"").split(",");return t.map((e=>{const[t,s]=e.split("=");return`${s}${t}`})).join("")}catch(t){return console.error("分数格式化失败:",t),"格式错误"}return Object.entries(e).map((([e,t])=>`${t}${e}`)).join("")},validateScore(e){return!(!this.currentRule||!e)&&e.every((e=>!!e&&!isNaN(Number(e))))},async submitScore(e){if(!this.isSubmitting){this.isSubmitting=!0;try{if(!this.canJudge())return void this.$message.warning("比赛尚未开始,暂不能评分");const t=this.scoreInputs[e.pid];if(!this.validateScore(t))return void this.$message.error("请输入有效的成绩");const s={};this.currentRule.units.forEach(((e,i)=>{s[e]=t[i]||"0"}));const i=this.calculateDegree(s);e.score=s,e.degree=i,await this.$emit("score-change",{spId:this.competition.spId,pid:e.pid,score:s,degree:i}),this.$delete(this.scoreInputs,e.pid);const a=this.groups[this.activeGroupIndex].players,r=a.findIndex((t=>t.pid===e.pid));r<a.length-1&&this.$nextTick((()=>{const e=a[r+1];e.score||this.$set(this.scoreInputs,e.pid,Array(this.currentRule.units.length).fill("0"))}))}catch(t){e.score=null,e.degree=null,console.error("提交成绩失败:",t),this.$message.error("提交成绩失败")}finally{this.isSubmitting=!1}}},calculateDegree(e){const t=this.scoreRules.find((e=>e.rid===this.selectedRuleId));if(!t||!t.mappings)return null;const s=Object.values(e).join(":"),i=t.mappings.get(s);if(void 0!==i)return i;const a=this.parseScore(s),r=Array.from(t.mappings.entries()).map((([e,t])=>({score:this.parseScore(e),points:t})));if(!t.isRankMode){const e=r.sort(((e,t)=>{for(let s=0;s<e.score.length;s++)if(e.score[s]!==t.score[s])return Number(e.score[s])-Number(t.score[s]);return 0}));for(let t=0;t<e.length;t++){const s=e[t],i=this.compareScores(a,s.score);if(i<=0)return s.points}return e[e.length-1].points}{const e=Number(a[0]),t=r.sort(((e,t)=>Number(e.score[0])-Number(t.score[0])));if(e<=Number(t[0].score[0]))return t[0].points;if(e>=Number(t[t.length-1].score[0]))return t[t.length-1].points}},parseScore(e){return e.split(":").map(Number)},compareScores(e,t){for(let s=0;s<e.length;s++)if(e[s]!==t[s])return e[s]-e[s];return 0},handleAddRule(){this.$emit("rule-create")},getCompTypeText(e){console.log("比赛类型原始值:",e);const t={1:"预赛",2:"半决赛",3:"决赛"},s=Number(e);return t[s]||"未知赛段"},handleRuleChange(e){if("new"===e)return this.$emit("rule-create"),void this.$nextTick((()=>{this.selectedRuleId=this.competition.rid}));e&&e!==this.competition.rid&&this.$emit("rule-select",this.competition.spId,e)},showAssignJudge(){this.$emit("fetch-judges"),this.assignDialogVisible=!0},async handleAssignJudges(e){try{const t=new URLSearchParams;t.append("spId",this.competition.spId),e.forEach((e=>{t.append("judgeUid",e)}));const s=await(0,V.A)({url:"/assignJudges",method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:t});1===s.code&&(this.$message.success("分配裁判成功"),await this.fetchGroups(),this.assignDialogVisible=!1)}catch(t){this.$message.error("分配裁判失败")}}},mounted(){this.currentUid=this.userInfo.uid}},_t=Dt,Et=(0,d.A)(_t,ct,dt,!1,null,"24f56d9e",null),kt=Et.exports,xt=function(){var e=this,t=e._self._c;return t("responsive-dialog",{attrs:{visible:e.visible,title:e.title,width:"800px"},on:{close:e.handleCancel,confirm:e.handleSave}},[t("div",{staticClass:"rule-form"},[t("el-form",{ref:"ruleForm",attrs:{model:e.ruleForm,"label-width":"100px"}},[t("el-form-item",{attrs:{label:"规则名称"}},[t("el-input",{attrs:{placeholder:"请输入规则名称"},model:{value:e.ruleForm.name,callback:function(t){e.$set(e.ruleForm,"name",t)},expression:"ruleForm.name"}})],1),t("el-form-item",{attrs:{label:"单位"}},[t("div",{staticClass:"units-row"},[e._l(e.ruleForm.units,(function(s,i){return t("div",{key:i,staticClass:"unit-item"},[t("unit-select",{attrs:{options:e.commonUnits,placeholder:"选择单位","show-delete":i>0},on:{input:e.checkUnitDuplicates,delete:function(t){return e.removeUnit(i)}},model:{value:e.ruleForm.units[i],callback:function(t){e.$set(e.ruleForm.units,i,t)},expression:"ruleForm.units[index]"}}),i<e.ruleForm.units.length-1?t("span",{staticClass:"unit-separator"},[e._v(":")]):e._e()],1)})),e.ruleForm.units.length<5?t("button",{staticClass:"unit-item add-unit-btn",attrs:{type:"button"},on:{click:e.addUnit}},[t("i",{staticClass:"el-icon-plus"}),t("span",[e._v("添加单位")])]):e._e()],2),e.unitError?t("div",{staticClass:"error-message"},[e._v(e._s(e.unitError))]):e._e()]),t("div",{staticClass:"mappings-section"},[t("div",{staticClass:"section-header"},[t("h3",[e._v("分数映射")]),t("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.addMapping}},[e._v("添加映射")])],1),t("el-table",{staticClass:"mapping-table",staticStyle:{width:"100%"},attrs:{data:e.mappingsList,border:""}},[t("el-table-column",{scopedSlots:e._u([{key:"default",fn:function(s){return[t("div",{staticClass:"score-cell"},[e.isRankMode?[t("multi-unit-input",{attrs:{units:["名"]},on:{enter:function(t){return e.validateMapping(s.$index)},"tab-last":function(t){return e.validateMapping(s.$index)},error:e.handleMappingError},model:{value:s.row.scoreValues,callback:function(t){e.$set(s.row,"scoreValues",t)},expression:"scope.row.scoreValues"}})]:[t("multi-unit-input",{attrs:{units:e.ruleForm.units},on:{enter:function(t){return e.validateMapping(s.$index)},"tab-last":function(t){return e.validateMapping(s.$index)},error:e.handleMappingError},model:{value:s.row.scoreValues,callback:function(t){e.$set(s.row,"scoreValues",t)},expression:"scope.row.scoreValues"}})]],2)]}}])},[t("template",{slot:"header"},[t("div",{staticClass:"header-with-checkbox"},[t("span",[e._v("成绩/排名")]),t("label",{staticClass:"custom-checkbox"},[t("input",{attrs:{type:"checkbox"},domProps:{checked:e.isRankMode},on:{change:e.toggleRankMode}}),t("span",{staticClass:"box-outer"},[t("span",{staticClass:"box-inner"},[e._v("✓")])]),t("span",{staticClass:"label"},[e._v("根据排名赋分")])])])])],2),t("el-table-column",{attrs:{label:"分数",width:"120"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("el-input",{staticClass:"points-input",attrs:{type:"number"},on:{change:function(t){return e.validateMapping(s.$index)}},model:{value:s.row.points,callback:function(t){e.$set(s.row,"points",e._n(t))},expression:"scope.row.points"}})]}}])}),t("el-table-column",{attrs:{label:"操作",width:"80",align:"center"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("el-button",{attrs:{type:"danger",icon:"el-icon-delete",circle:"",size:"mini"},on:{click:function(t){return e.removeMapping(s.$index)}}})]}}])})],1)],1)],1)],1)])},It=[],$t=function(){var e=this,t=e._self._c;return t("div",{staticClass:"unit-select",class:{"is-focused":e.isOpen}},[t("div",{staticClass:"input-wrapper"},[t("input",{directives:[{name:"model",rawName:"v-model",value:e.inputValue,expression:"inputValue"}],ref:"input",attrs:{type:"text",maxlength:"4",placeholder:e.placeholder},domProps:{value:e.inputValue},on:{focus:e.handleFocus,blur:e.handleBlur,input:[function(t){t.target.composing||(e.inputValue=t.target.value)},e.handleInput]}}),e.showDelete?[t("i",{staticClass:"el-icon-delete delete-icon",on:{click:function(t){return t.stopPropagation(),e.handleDelete.apply(null,arguments)}}})]:[t("i",{staticClass:"expand-icon",class:{"is-open":e.isOpen}})]],2),t("transition",{attrs:{name:"dropdown"}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.isOpen,expression:"isOpen"}],staticClass:"dropdown"},[t("div",{staticClass:"dropdown-content custom-scrollbar"},e._l(e.mergedOptions,(function(s){return t("div",{key:s,staticClass:"option",class:{"is-active":s===e.inputValue},on:{mousedown:function(t){return t.preventDefault(),e.selectOption(s)}}},[e._v(" "+e._s(s)+" ")])})),0)])])],1)},Ft=[],Pt={name:"UnitSelect",props:{value:{type:String,default:""},options:{type:Array,default:()=>[]},placeholder:{type:String,default:"请选择"},showDelete:{type:Boolean,default:!1}},data(){return{inputValue:this.value,isOpen:!1}},computed:{mergedOptions(){const e=this.inputValue.trim(),t=[...this.options];return e&&!t.includes(e)&&t.push(e),t.filter((e=>e.toLowerCase().includes(this.inputValue.toLowerCase())))}},watch:{value(e){this.inputValue=e}},methods:{handleFocus(){this.isOpen=!0},handleBlur(){setTimeout((()=>{this.isOpen=!1}),200)},handleInput(){this.$emit("input",this.inputValue),this.isOpen=!0},selectOption(e){this.inputValue=e,this.$emit("input",e),this.isOpen=!1},handleDelete(){this.$emit("delete")}}},At=Pt,Mt=(0,d.A)(At,$t,Ft,!1,null,"9122bae8",null),Rt=Mt.exports,Nt={name:"ScoreRuleDialog",components:{ResponsiveDialog:F.A,MultiUnitInput:vt,UnitSelect:Rt},props:{visible:Boolean,editData:{type:Object,default:()=>({})}},data(){return{title:"评分规则",ruleForm:{name:"",units:[""],mappings:new Map},mappingsList:[],rules:{},commonUnits:["米","分","秒","毫秒"],unitError:"",hasError:!1,isRankMode:!1,validationError:""}},watch:{visible(e){e&&(this.editData?.rid?this.initEditData():(this.ruleForm={name:"",units:[""],mappings:new Map},this.mappingsList=[],this.hasError=!1,this.unitError=""))},"ruleForm.units":{deep:!0,handler(){this.updateUnitsDisplay()}}},methods:{initEditData(){if(this.editData&&this.editData.rid)if(this.ruleForm={name:this.editData.name,units:[...this.editData.units]},this.isRankMode=this.editData.isRankMode,this.mappingsList=[],this.editData.mappings instanceof Map)this.editData.mappings.forEach(((e,t)=>{this.mappingsList.push({scoreValues:t.split(":"),points:Number(e)})}));else{let e={};e="string"===typeof this.editData.mappings?JSON.parse(this.editData.mappings):this.editData.mappings,Object.entries(e).forEach((([e,t])=>{this.mappingsList.push({scoreValues:e.split(":"),points:Number(t)})}))}},addMapping(){this.mappingsList.push({scoreValues:Array(this.ruleForm.units.length).fill(""),points:null,rank:null})},removeMapping(e){this.mappingsList.splice(e,1)},validateMapping(){return!0},async handleSave(){try{const e={};this.mappingsList.forEach((({scoreValues:t,points:s})=>{if(null!==s&&void 0!==s)if(this.isRankMode){const i=t[0];i&&""!==i.trim()&&(e[i]=s)}else t.every((e=>null!==e&&void 0!==e&&""!==e))&&(e[t.join(":")]=s)}));const t=new URLSearchParams;t.append("name",this.ruleForm.name),t.append("units",`[${this.ruleForm.units.join(",")}]`),t.append("mappings",JSON.stringify(e)),t.append("isRankMode",this.isRankMode?"1":"0"),this.editData?.rid&&t.append("rid",this.editData.rid);const s=await(0,V.A)({url:"/saveJudgeRule",method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:t});1===s.code&&(this.$message.success("保存成功"),this.$emit("save"),this.handleCancel())}catch(e){console.error("保存失败:",e),this.$message.error("保存失败")}},handleCancel(){this.$refs.ruleForm.resetFields(),this.mappingsList=[],this.$emit("update:visible",!1)},addUnit(){this.ruleForm.units.length<5&&this.ruleForm.units.push("")},removeUnit(e){this.ruleForm.units.splice(e,1),this.checkUnitDuplicates()},checkUnitDuplicates(){const e=this.ruleForm.units,t=e.filter(((t,s)=>t&&e.indexOf(t)!==s));t.length>0?(this.unitError=`单位"${t[0]}"重复使用`,this.hasError=!0):(this.unitError="",this.hasError=!1)},handleMappingError(){},updateUnitsDisplay(){this.$nextTick((()=>{const e=document.querySelectorAll(".el-select__input");e.forEach((e=>{e.addEventListener("input",(function(){this.select()}))}))}))},handleRankChange(e,t){this.mappingsList[t].scoreValues=[`${e}`],this.validateMapping(t)},toggleRankMode(e){this.isRankMode=e.target?.checked??e,this.mappingsList=this.mappingsList.map((e=>({...e,scoreValues:this.isRankMode?[e.scoreValues[0]||""]:e._originalValues||Array(this.ruleForm.units.length).fill("")}))),this.validationError="",this.$forceUpdate()},handleRankModeChange(){this.mappingsList.forEach((e=>{e.rank=null,e.scoreValues=Array(this.ruleForm.units.length).fill("")}))}}},Lt=Nt,Ot=(0,d.A)(Lt,xt,It,!1,null,"1e0c867e",null),Vt=Ot.exports,Gt={name:"JudgeManagement",components:{JudgeCompetitionCard:kt,ResponsiveDialog:F.A,ScoreRuleDialog:Vt,FilterDropdown:st.A},props:{isEditMode:{type:Boolean,default:!0}},data(){const e=JSON.parse(localStorage.getItem("userInfo")||"{}"),t=e.powerDegree?.includes(5);return{loading:!1,activeCompetitionId:null,competitions:[],scoreRules:[],currentFilter:"pending",ruleDialogVisible:!1,ruleManageVisible:!1,currentRule:null,currentStateFilter:e.powerDegree?.includes(5)?"all":"pending",currentTimeSort:"none",currentCompType:"all",filterOptions:{status:[{value:"all",label:"全部"},{value:"notStarted",label:"未开始"},{value:"pending",label:"待评分"},{value:"scored",label:"已评分"}],time:[{value:"none",label:"默认"},{value:"asc",label:"升序"},{value:"desc",label:"降序"}],compType:[{value:"all",label:"全部"},{value:"1",label:"预赛"},{value:"2",label:"半决赛"},{value:"3",label:"决赛"}]},defaultStateFilter:t?"all":"pending",availableJudges:[],loadingJudges:!1,assignDialogVisible:!1}},computed:{canModifyRule(){const e=JSON.parse(localStorage.getItem("userInfo")||"{}");return e.powerDegree?.includes(3)||e.powerDegree?.includes(5)},filteredCompetitions(){let e=[...this.competitions];return"all"!==this.currentStateFilter&&(e=e.filter((e=>{switch(this.currentStateFilter){case"notStarted":return 1===e.status||2===e.status;case"pending":return 3===e.status;case"scored":return 4===e.status||5===e.status;default:return!0}}))),"all"!==this.currentCompType&&(e=e.filter((e=>String(e.compType)===this.currentCompType))),"none"!==this.currentTimeSort&&e.sort(((e,t)=>{const s=new Date(e.gameStartTime).getTime(),i=new Date(t.gameStartTime).getTime();return"asc"===this.currentTimeSort?s-i:i-s})),e},emptyTipText(){const e={notStarted:"暂无报名中的比赛",assigning:"暂无分配中的比赛",pending:"暂无待评分的比赛",scored:"暂无已评分的比赛",finished:"暂无已完成的比赛",all:"暂无比赛数据"};return e[this.currentStateFilter]||e.all}},methods:{async fetchCompetitions(){this.loading=!0;try{const e=await(0,V.A)({url:"/getJudgements",method:"get"});1===e.code&&(this.competitions=e.data)}catch(e){this.$message.error("获取比赛数据失败")}finally{this.loading=!1}},async fetchScoreRules(){try{const e=await(0,V.A)({url:"/getJudgeRules",method:"get"});1===e.code&&(this.scoreRules=e.data.map((e=>({...e,units:e.units.replace(/^\[|\]$/g,"").split(","),mappings:"string"===typeof e.mappings?new Map(Object.entries(JSON.parse(e.mappings))):new Map(Object.entries(e.mappings)),isRankMode:!0===e.isRankMode||"1"===e.isRankMode||1===e.isRankMode}))))}catch(e){console.error("解析评分规则失败:",e),this.$message.error("获取评分规则失败")}},toggleCompetition(e){console.log("切换展开状态:",e),this.activeCompetitionId=this.activeCompetitionId===e?null:e},async handleScoreChange({spId:e,pid:t,score:s,degree:i}){try{const a=await(0,V.A)({url:"/submitScore",method:"post",data:{spId:e,pid:t,score:s,degree:i}});1===a.code&&(this.$message.success("评分成功"),await this.fetchCompetitions())}catch(a){this.$message.error("评分失败")}},showRuleManagement(){this.ruleManageVisible=!0},showRuleDialog(e=null){this.currentRule=e,this.ruleDialogVisible=!0},handleRuleDialogClose(){this.ruleDialogVisible=!1,this.ruleManageVisible=!0},handleRuleCreate(){this.showRuleDialog()},editRule(e){this.showRuleDialog(e)},async deleteRule(e){if(this.isRuleInUse(e.rid))this.$message.warning("该规则正在使用中，无法删除");else try{await this.$confirm("确定要删除该评分规则吗？","提示",{type:"warning"});const t=new URLSearchParams;t.append("rid",e.rid);const s=await(0,V.A)({url:"/deleteJudgeRule",method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:t});1===s.code&&(this.$message.success("删除成功"),await this.fetchScoreRules())}catch(t){"cancel"!==t&&this.$message.error("删除失败")}},async handleRuleSave(){await this.fetchScoreRules(),this.ruleDialogVisible=!1,this.ruleManageVisible=!0},async handleRuleSelect(e,t){try{const s=new URLSearchParams;s.append("spId",e),s.append("rid",t);const i=await(0,V.A)({url:"/updateCompetitionRule",method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:s});if(1===i.code){this.$message.success("规则更新成功");const s=this.competitions.find((t=>t.spId===e));s&&(s.rid=t)}}catch(s){this.$message.error("规则更新失败")}},handleFilterChange(){console.log("切换筛选:",this.currentFilter)},handleStateFilter(e){this.currentStateFilter=e},handleTimeSort(e){this.currentTimeSort=e},handleCompTypeFilter(e){this.currentCompType=e},isRuleInUse(e){return this.competitions.some((t=>t.rid===e))},async fetchAvailableJudges(){this.loadingJudges=!0;try{const e=await(0,V.A)({url:"/getAvailableJudges",method:"get"});1===e.code?this.availableJudges=(e.data||[]).map((e=>({uid:e.uid,name:e.name,head:e.head||""}))):this.availableJudges=[]}catch(e){console.error("获取可用裁判失败:",e),this.availableJudges=[]}finally{this.loadingJudges=!1}}},mounted(){this.fetchCompetitions(),this.fetchScoreRules(),this.fetchAvailableJudges()}},zt=Gt,Ut=(0,d.A)(zt,ot,lt,!1,null,"38b92c68",null),jt=Ut.exports,Jt=function(){var e=this,t=e._self._c;return t("div",{staticClass:"registration-record"},[t("div",{staticClass:"filter-section"},[t("el-card",[t("div",{staticClass:"filter-header"},[t("h3",[e._v("筛选条件")]),t("el-button",{attrs:{type:"text"},on:{click:e.resetFilters}},[e._v("重置筛选")])],1),t("div",{staticClass:"filters"},[t("el-row",{attrs:{gutter:20}},[t("el-col",{attrs:{xs:24,sm:12,md:8,lg:6}},[t("el-input",{attrs:{placeholder:"搜索运动员姓名/学号",clearable:"","prefix-icon":"el-icon-search"},on:{input:e.handleFilter},model:{value:e.filters.keyword,callback:function(t){e.$set(e.filters,"keyword",t)},expression:"filters.keyword"}})],1),t("el-col",{attrs:{xs:24,sm:12,md:8,lg:6}},[t("el-select",{attrs:{placeholder:"比赛项目",clearable:""},on:{change:e.handleFilter},model:{value:e.filters.event,callback:function(t){e.$set(e.filters,"event",t)},expression:"filters.event"}},e._l(e.eventGroups,(function(s){return t("el-option-group",{key:s.label,attrs:{label:s.label}},e._l(s.options,(function(e){return t("el-option",{key:e.sp_id,attrs:{label:e.name,value:e.sp_id}})})),1)})),1)],1),t("el-col",{attrs:{xs:24,sm:12,md:8,lg:6}},[t("el-select",{attrs:{placeholder:"比赛阶段",clearable:""},on:{change:e.handleFilter},model:{value:e.filters.phase,callback:function(t){e.$set(e.filters,"phase",t)},expression:"filters.phase"}},[t("el-option",{attrs:{label:"预赛",value:"preliminary"}}),t("el-option",{attrs:{label:"半决赛",value:"semifinal"}}),t("el-option",{attrs:{label:"决赛",value:"final"}})],1)],1),t("el-col",{attrs:{xs:24,sm:12,md:8,lg:6}},[t("el-select",{attrs:{placeholder:"成绩状态",clearable:""},on:{change:e.handleFilter},model:{value:e.filters.hasScore,callback:function(t){e.$set(e.filters,"hasScore",t)},expression:"filters.hasScore"}},[t("el-option",{attrs:{label:"已有成绩",value:"true"}}),t("el-option",{attrs:{label:"暂无成绩",value:"false"}})],1)],1)],1)],1)])],1),t("div",{staticClass:"table-section"},[t("el-card",[t("div",{staticClass:"table-header"},[t("div",{staticClass:"statistics"},[t("span",[e._v("共 "+e._s(e.filteredData.length)+" 条记录")]),t("el-divider",{attrs:{direction:"vertical"}}),t("span",[e._v("已录入成绩 "+e._s(e.scoreCount)+" 条")])],1),t("div",{staticClass:"actions"},[t("el-button",{attrs:{type:"primary",icon:"el-icon-download"},on:{click:e.exportToExcel}},[e._v("导出Excel")])],1)]),t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{width:"100%"},attrs:{data:e.pagedData,stripe:"",border:"","default-sort":{prop:"timestamp",order:"descending"}},on:{"sort-change":e.handleSortChange}},[t("el-table-column",{attrs:{prop:"timestamp",label:"报名时间",width:"180",sortable:"custom","sort-orders":["ascending","descending"]},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.formatTime(t.row.timestamp))+" ")]}}])}),t("el-table-column",{attrs:{prop:"studentId",label:"学号",width:"120"}}),t("el-table-column",{attrs:{prop:"name",label:"姓名",width:"100"}}),t("el-table-column",{attrs:{prop:"school",label:"学校",width:"180"}}),t("el-table-column",{attrs:{prop:"eventName",label:"比赛项目","min-width":"150"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("el-tag",{attrs:{type:e.getEventTagType(s.row.eventPhase)}},[e._v(" "+e._s(s.row.eventName)+"（"+e._s(e.getPhaseText(s.row.eventPhase))+"） ")])]}}])}),t("el-table-column",{attrs:{prop:"score",label:"成绩",width:"120"},scopedSlots:e._u([{key:"default",fn:function(s){return[s.row.score?[t("span",{staticClass:"success-score"},[e._v(" "+e._s(e.formatScore(s.row.score))+" "),t("span",{staticClass:"point-text"},[e._v("("+e._s(s.row.point||"-")+"分)")])])]:t("el-tag",{attrs:{type:"info",size:"small"}},[e._v("暂无成绩")])]}}])}),t("el-table-column",{attrs:{prop:"rank",label:"排名",width:"100"},scopedSlots:e._u([{key:"default",fn:function(s){return[s.row.rank?[t("el-tag",{attrs:{type:e.getRankTagType(s.row.rank),size:"medium"}},[e._v(" 第"+e._s(s.row.rank)+"名 ")])]:t("span",[e._v("-")])]}}])})],1),t("div",{staticClass:"pagination"},[t("el-pagination",{attrs:{"current-page":e.currentPage,"page-sizes":[10,20,50,100],"page-size":e.pageSize,layout:"total, sizes, prev, pager, next, jumper",total:e.filteredData.length},on:{"size-change":e.handleSizeChange,"current-change":e.handleCurrentChange}})],1)],1)],1)])},qt=[];function Bt(){const e=[{sp_id:"SP001",name:"100米短跑",type:"track"},{sp_id:"SP002",name:"200米短跑",type:"track"},{sp_id:"SP003",name:"400米短跑",type:"track"},{sp_id:"SP004",name:"跳高",type:"field"},{sp_id:"SP005",name:"跳远",type:"field"},{sp_id:"SP006",name:"铅球",type:"field"}],t=["清华大学","北京大学","浙江大学","复旦大学","南京大学","中国人民大学"],s=["preliminary","semifinal","final"],i=[];for(let a=0;a<200;a++){const r=e[Math.floor(Math.random()*e.length)],n=s[Math.floor(Math.random()*s.length)],o=Math.random()>.3;i.push({id:a+1,timestamp:Date.now()-Math.floor(7*Math.random()*24*60*60*1e3),studentId:`2024${String(Math.floor(1e4*Math.random())).padStart(4,"0")}`,name:`学生${a+1}`,school:t[Math.floor(Math.random()*t.length)],eventName:r.name,eventType:r.type,sp_id:r.sp_id,eventPhase:n,score:o?"track"===r.type?(10+5*Math.random()).toFixed(2):(4+4*Math.random()).toFixed(2):null,point:o?Math.floor(30*Math.random())+70:null,rank:o?Math.floor(20*Math.random())+1:null})}return i}var Wt={name:"RegistrationRecord",data(){return{records:Bt(),filters:{keyword:"",event:"",phase:"",hasScore:""},currentPage:1,pageSize:20,loading:!1,sortBy:{prop:"timestamp",order:"descending"}}},computed:{eventGroups(){const e={track:{label:"田赛项目",options:[]},field:{label:"径赛项目",options:[]}},t=new Map(this.records.map((e=>[e.sp_id,{sp_id:e.sp_id,name:e.eventName,type:e.eventType}])));return t.forEach((t=>{const s={sp_id:t.sp_id,value:t.sp_id,label:t.name,name:t.name};"track"===t.type?e.track.options.push(s):e.field.options.push(s)})),Object.values(e)},filteredData(){return this.records.filter((e=>{if(this.filters.keyword&&!e.name.includes(this.filters.keyword)&&!e.studentId.includes(this.filters.keyword))return!1;if(this.filters.event&&e.sp_id!==this.filters.event)return!1;if(this.filters.phase&&e.eventPhase!==this.filters.phase)return!1;if(""!==this.filters.hasScore){const t=null!==e.score;return t===("true"===this.filters.hasScore)}return!0})).sort(((e,t)=>{const{prop:s,order:i}=this.sortBy;return"ascending"===i?e[s]>t[s]?1:-1:e[s]<t[s]?1:-1}))},pagedData(){const e=(this.currentPage-1)*this.pageSize;return this.filteredData.slice(e,e+this.pageSize)},scoreCount(){return this.filteredData.filter((e=>null!==e.score)).length}},methods:{handleFilter(){this.currentPage=1},resetFilters(){this.filters={keyword:"",event:"",phase:"",hasScore:""},this.handleFilter()},handleSortChange({prop:e,order:t}){this.sortBy=t?{prop:e,order:t}:{prop:"timestamp",order:"descending"}},handleSizeChange(e){this.pageSize=e,this.currentPage=1},handleCurrentChange(e){this.currentPage=e},formatTime(e){return new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},formatScore(e){return`${e}${e>60?"秒":"米"}`},getEventTagType(e){const t={preliminary:"info",semifinal:"warning",final:"success"};return t[e]||"info"},getPhaseText(e){const t={preliminary:"预赛",semifinal:"半决赛",final:"决赛"};return t[e]||e},getRankTagType(e){return e<=3?"success":e<=8?"warning":"info"},exportToExcel(){this.$message.success("导出成功！")}}},Ht=Wt,Qt=(0,d.A)(Ht,Jt,qt,!1,null,"402d2924",null),Yt=Qt.exports,Zt=function(){var e=this,t=e._self._c;return t("div",{staticClass:"schedule-management"},[t("div",{staticClass:"filter-bar"},[t("div",{staticClass:"filter-container"},["browse"===e.viewMode?[t("el-select",{staticClass:"date-select",attrs:{placeholder:"选择日期",size:"small"},model:{value:e.recentFilters.date,callback:function(t){e.$set(e.recentFilters,"date",t)},expression:"recentFilters.date"}},e._l(e.recentDates,(function(s){return t("el-option",{key:s.value,attrs:{label:s.label,value:s.value}},[e._v(" "+e._s(s.label)+" "),s.value===e.today?t("small",[e._v("("+e._s(e.formatDate(s.value))+")")]):e._e()])})),1),t("el-select",{staticClass:"status-select",attrs:{multiple:"",placeholder:"比赛状态",size:"small","popper-class":"status-select-dropdown"},model:{value:e.recentFilters.status,callback:function(t){e.$set(e.recentFilters,"status",t)},expression:"recentFilters.status"}},[t("el-option",{attrs:{label:"进行中",value:"ongoing"}},[t("span",{staticStyle:{"font-size":"16px"}},[e._v("进行中")])]),t("el-option",{attrs:{label:"已结束",value:"completed"}},[t("span",{staticStyle:{"font-size":"16px"}},[e._v("已结束")])]),t("el-option",{attrs:{label:"未开始",value:"pending"}},[t("span",{staticStyle:{"font-size":"16px"}},[e._v("未开始")])])],1)]:[t("FilterDropdown",{attrs:{options:e.dateOptions,label:"日期",placeholder:"选择日期",size:"small","hide-label":e.isMobile},model:{value:e.listViewFilters.date,callback:function(t){e.$set(e.listViewFilters,"date",t)},expression:"listViewFilters.date"}}),t("FilterDropdown",{attrs:{options:e.filterOptions.timeOfDay,label:"时间段",placeholder:"选择时间段",size:"small","hide-label":e.isMobile},model:{value:e.listViewFilters.timeOfDay,callback:function(t){e.$set(e.listViewFilters,"timeOfDay",t)},expression:"listViewFilters.timeOfDay"}}),t("FilterDropdown",{attrs:{options:e.filterOptions.compType,label:"赛型",placeholder:"选择赛型",size:"small","hide-label":e.isMobile},model:{value:e.listViewFilters.compType,callback:function(t){e.$set(e.listViewFilters,"compType",t)},expression:"listViewFilters.compType"}}),t("FilterDropdown",{attrs:{options:e.filterOptions.eventType,label:"类型",placeholder:"选择类型",size:"small","hide-label":e.isMobile},model:{value:e.listViewFilters.eventType,callback:function(t){e.$set(e.listViewFilters,"eventType",t)},expression:"listViewFilters.eventType"}})]],2),t("div",{staticClass:"view-switcher"},[t("el-button-group",{attrs:{size:"small"}},[t("el-button",{attrs:{type:"browse"===e.viewMode?"primary":"",icon:"el-icon-view",circle:""},on:{click:function(t){e.viewMode="browse"}}}),t("el-button",{attrs:{type:"list"===e.viewMode?"primary":"",icon:"el-icon-menu",circle:""},on:{click:function(t){e.viewMode="list"}}})],1)],1)]),t("div",{directives:[{name:"show",rawName:"v-show",value:"browse"===e.viewMode,expression:"viewMode === 'browse'"}],staticClass:"browse-view"},[t("div",{staticClass:"timeline-container"},[0===e.filteredRecentEvents.length?t("div",{staticClass:"empty-state"},[t("i",{staticClass:"el-icon-date"}),t("p",[e._v("当前没有比赛")])]):t("el-timeline",e._l(e.filteredRecentEvents,(function(s,i){return t("el-timeline-item",{key:`${s.id}-${i}`,attrs:{timestamp:e.formatTimeRange(s),type:e.getTimelineItemType(s.status),color:e.getTimelineItemColor(s.status),placement:"top"}},[t("el-card",{staticClass:"timeline-card",class:e.getStatusClass(s.status)},[t("div",{staticClass:"event-header"},[t("h3",{staticClass:"event-title"},[e._v(e._s(s.eventName))]),t("div",{staticClass:"event-meta"},[t("span",{staticClass:"status-text"},[e._v(e._s(e.getStatusText(s.status)))])])]),t("div",{staticClass:"event-info"},[t("span",{staticClass:"venue"},[t("i",{staticClass:"el-icon-location"}),e._v(" "+e._s(s.venue)+" ")])])])],1)})),1)],1)]),t("div",{directives:[{name:"show",rawName:"v-show",value:"list"===e.viewMode,expression:"viewMode === 'list'"}],staticClass:"list-view"},[t("div",{staticClass:"total-count"},[e._v("共 "+e._s(e.filterListViewData().length)+" 条赛程")]),e.isMobile?t("div",{staticClass:"mobile-list"},e._l(e.filterListViewData(),(function(s){return t("div",{key:s.id,staticClass:"mobile-list-item",on:{click:function(t){return e.editEvent(s)}}},[t("div",{staticClass:"event-content"},[t("div",{staticClass:"name-and-meta"},[t("span",{staticClass:"event-name"},[e._v(e._s(s.eventName))]),t("div",{staticClass:"meta-container"},[t("span",{staticClass:"event-date"},[e._v(e._s(e.formatDate(s.date)))]),t("span",{staticClass:"event-time"},[e._v(e._s(s.startTime)+" - "+e._s(s.endTime))])])])])])})),0):t("el-table",{staticStyle:{width:"100%"},attrs:{data:e.filterListViewData(),border:""}},[t("el-table-column",{attrs:{prop:"date",label:"日期",width:"120"},scopedSlots:e._u([{key:"default",fn:function(s){return[e.isEditMode&&e.editingEvent?.id===s.row.id?[t("el-date-picker",{attrs:{type:"date",placeholder:"选择日期","value-format":"yyyy-MM-dd"},model:{value:e.editingEvent.date,callback:function(t){e.$set(e.editingEvent,"date",t)},expression:"editingEvent.date"}})]:t("span",[e._v(e._s(e.formatDate(s.row.date)))])]}}],null,!1,3763772087)}),t("el-table-column",{attrs:{label:"时间段",width:"240"},scopedSlots:e._u([{key:"default",fn:function(s){return[e.isEditMode&&e.editingEvent?.id===s.row.id?[t("el-time-select",{staticStyle:{width:"110px"},attrs:{"picker-options":{start:"08:00",step:"00:30",end:"20:00"},placeholder:"开始时间",size:"mini"},on:{change:e.handleTimeChange},model:{value:e.editingEvent.startTime,callback:function(t){e.$set(e.editingEvent,"startTime",t)},expression:"editingEvent.startTime"}}),t("span",{staticStyle:{margin:"0 8px"}},[e._v("至")]),t("el-time-select",{staticStyle:{width:"110px"},attrs:{"picker-options":{start:"08:00",step:"00:30",end:"20:00",minTime:e.editingEvent.startTime},placeholder:"结束时间",size:"mini"},on:{change:e.handleTimeChange},model:{value:e.editingEvent.endTime,callback:function(t){e.$set(e.editingEvent,"endTime",t)},expression:"editingEvent.endTime"}})]:t("span",[e._v(e._s(s.row.startTime)+" - "+e._s(s.row.endTime))])]}}],null,!1,860511535)}),t("el-table-column",{attrs:{prop:"eventName",label:"比赛项目"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.eventName)+" ")]}}],null,!1,4018739030)}),t("el-table-column",{attrs:{prop:"compType",label:"赛型",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.getPhaseText(t.row.compType))+" ")]}}],null,!1,3345180113)}),t("el-table-column",{attrs:{prop:"eventType",label:"类型",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(1===t.row.eventType?"径赛":"田赛")+" ")]}}],null,!1,2621920660)}),t("el-table-column",{attrs:{prop:"venue",label:"比赛场地",width:"150"},scopedSlots:e._u([{key:"default",fn:function(s){return[e.isEditMode&&e.editingEvent?.id===s.row.id?[t("el-select",{attrs:{placeholder:"选择场地"},model:{value:e.editingEvent.venue,callback:function(t){e.$set(e.editingEvent,"venue",t)},expression:"editingEvent.venue"}},e._l(e.venues,(function(e){return t("el-option",{key:e,attrs:{label:e,value:e}})})),1)]:t("span",[e._v(e._s(s.row.venue))])]}}],null,!1,4253533404)}),t("el-table-column",{attrs:{prop:"status",label:"状态",width:"100"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("el-tag",{attrs:{type:e.getStatusTagType(s.row.status)}},[e._v(" "+e._s(e.getStatusText(s.row.status))+" ")])]}}],null,!1,1140510399)}),e.isEditMode?t("el-table-column",{attrs:{label:"操作",width:"150"},scopedSlots:e._u([{key:"default",fn:function(s){return[e.editingEvent?.id===s.row.id?[t("el-button",{attrs:{size:"mini",type:"success"},on:{click:e.saveEvent}},[e._v("保存")]),t("el-button",{attrs:{size:"mini",type:"info"},on:{click:e.cancelEdit}},[e._v("取消")])]:t("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(t){return e.editEvent(s.row)}}},[e._v(" 编辑 ")])]}}],null,!1,2411650260)}):e._e()],1)],1),t("responsive-dialog",{attrs:{visible:e.showEditDialog,title:"调整比赛时间",width:"500px"},on:{"update:visible":function(t){e.showEditDialog=t},confirm:e.saveEvent,cancel:e.cancelEdit}},[e.editingEvent?t("el-form",{attrs:{model:e.editingEvent,"label-width":"100px"}},[t("el-form-item",{attrs:{label:"比赛项目"}},[t("span",[e._v(e._s(e.editingEvent.eventName))])]),t("el-form-item",{attrs:{label:"日期"}},[t("el-date-picker",{attrs:{type:"date","value-format":"yyyy-MM-dd"},model:{value:e.editingEvent.date,callback:function(t){e.$set(e.editingEvent,"date",t)},expression:"editingEvent.date"}})],1),t("el-form-item",{attrs:{label:"开始时间"}},[t("el-time-picker",{attrs:{placeholder:"选择时间","value-format":"HH:mm"},model:{value:e.editingEvent.startTime,callback:function(t){e.$set(e.editingEvent,"startTime",t)},expression:"editingEvent.startTime"}})],1),t("el-form-item",{attrs:{label:"结束时间"}},[t("el-time-picker",{attrs:{placeholder:"选择时间","value-format":"HH:mm"},model:{value:e.editingEvent.endTime,callback:function(t){e.$set(e.editingEvent,"endTime",t)},expression:"editingEvent.endTime"}})],1),t("el-form-item",{attrs:{label:"比赛场地"}},[t("el-select",{attrs:{placeholder:"选择场地"},model:{value:e.editingEvent.venue,callback:function(t){e.$set(e.editingEvent,"venue",t)},expression:"editingEvent.venue"}},e._l(e.venues,(function(e){return t("el-option",{key:e,attrs:{label:e,value:e}})})),1)],1)],1):e._e()],1)],1)},Xt=[];function Kt(){return(0,V.A)({url:"/getSchedules",method:"get"})}function es(e){const t={spId:e.spId,gameStartTime:e.startTime,gameEndTime:e.endTime,venue:e.venue};return(0,V.A)({url:"/updateSchedule",method:"post",data:t,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:[function(e){let t="";for(let s in e)t+=encodeURIComponent(s)+"="+encodeURIComponent(e[s])+"&";return t}]})}var ts={name:"ScheduleManagement",components:{ResponsiveDialog:F.A,FilterDropdown:st.A},data(){return{isEditMode:!1,viewMode:"browse",scheduleData:[],loading:!1,venues:["主田径场","副田径场","室内体育馆","训练场"],currentWeek:(new Date).toISOString().split("T")[0],editingEvent:null,showEditDialog:!1,timeSlots:Array.from({length:13},((e,t)=>({time:`${(8+t).toString().padStart(2,"0")}:00`}))),recentFilters:{date:(new Date).toISOString().split("T")[0],status:["pending","ongoing","completed"]},today:(new Date).toISOString().split("T")[0],isMobile:window.innerWidth<=768,timeTableData:Array.from({length:13},((e,t)=>({time:`${(8+t).toString().padStart(2,"0")}:00`}))),weekStartDate:null,lastFetchTime:0,fetchInterval:3e5,listViewFilters:{date:"all",timeOfDay:"all",compType:"all",eventType:"all"},filterOptions:{timeOfDay:[{value:"all",label:"全部"},{value:"morning",label:"上午"},{value:"afternoon",label:"下午"}],compType:[{value:"all",label:"全部"},{value:1,label:"预赛"},{value:2,label:"半决赛"},{value:3,label:"决赛"}],eventType:[{value:"all",label:"全部"},{value:1,label:"径赛"},{value:2,label:"田赛"}]},recentDates:[]}},computed:{filteredRecentEvents(){if(!this.scheduleData)return[];const e=this.scheduleData.filter((e=>{const t=e.date===this.recentFilters.date,s=this.recentFilters.status.includes(e.status);return t&&s}));return this.sortByStartTime(e)},formatDateRange(){if(!this.currentWeek)return"";const e=new Date(this.currentWeek),t=new Date(this.currentWeek);return t.setDate(t.getDate()+6),`${e.getMonth()+1}月${e.getDate()}日 - ${t.getMonth()+1}月${t.getDate()}日`},dateOptions(){const e=[{value:"all",label:"全部"}],t=new Map;this.scheduleData.forEach((e=>{t.has(e.date)||t.set(e.date,{value:e.date,label:this.formatDate(e.date)})}));const s=Array.from(t.values()).sort(((e,t)=>new Date(e.value)-new Date(t.value)));return[...e,...s]}},methods:{processScheduleData(e){return e.map((e=>({id:e.spId,spId:e.spId,date:e.gameStartTime?.split("T")[0],startTime:e.gameStartTime?.split("T")[1]?.split("+")[0]?.slice(0,5),endTime:e.gameEndTime?.split("T")[1]?.split("+")[0]?.slice(0,5),name:e.name||"未命名比赛",eventName:(0,he.z)(e),eventType:e.eventType,compType:Number(e.compType)||1,venue:e.venue||"待定",status:this.calculateStatus(e.gameStartTime,e.gameEndTime),gender:e.gender})))},calculateStatus(e,t){const s=(new Date).getTime(),i=new Date(e).getTime(),a=new Date(t).getTime();return s<i?"pending":s>a?"completed":"ongoing"},async fetchScheduleData(){const e=Date.now();if(e-this.lastFetchTime<this.fetchInterval&&this.scheduleData.length>0)this.updateCurrentView();else try{this.loading=!0;const t=await Kt();if(1!==t.code||!Array.isArray(t.data))throw new Error(t.message||"数据格式错误");this.scheduleData=this.processScheduleData(t.data),this.lastFetchTime=e,this.updateCurrentView()}catch(t){this.$message.error("获取赛程数据失败: "+t.message)}finally{this.loading=!1}},updateCurrentView(){if("browse"===this.viewMode){const e=new Date,t=new Date(e);t.setDate(e.getDate()+2),this.filteredScheduleData=this.scheduleData.filter((s=>{const i=new Date(s.date),a=i>=e&&i<=t,r=this.recentFilters.status.includes(s.status);return a&&r}))}else this.filteredScheduleData=this.scheduleData},async saveEvent(){if(this.editingEvent.spId)try{const e=new Date(this.editingEvent.date),[t,s]=this.editingEvent.startTime.split(":"),i=new Date(e);i.setHours(parseInt(t),parseInt(s),0);const[a,r]=this.editingEvent.endTime.split(":"),n=new Date(e);n.setHours(parseInt(a),parseInt(r),0);const o={spId:this.editingEvent.spId,startTime:i.toISOString(),endTime:n.toISOString(),venue:this.editingEvent.venue},l=await es(o);1===l.code&&(this.$message.success("保存成功"),await this.fetchScheduleData())}catch(e){this.$message.error("保存失败")}finally{this.cancelEdit()}},handleWeekChange(e){this.currentWeek=e,this.weekStartDate=new Date(e)},previousWeek(){const e=new Date(this.currentWeek);e.setDate(e.getDate()-7),this.currentWeek=e.toISOString().split("T")[0]},nextWeek(){const e=new Date(this.currentWeek);e.setDate(e.getDate()+7),this.currentWeek=e.toISOString().split("T")[0]},getDayLabel(e){const t=new Date(this.currentWeek);return t.setDate(t.getDate()+e-1),`${t.getMonth()+1}月${t.getDate()}日`},getScheduleEvent(e,t){const s=new Date(this.currentWeek);s.setDate(s.getDate()+t-1);const i=s.toISOString().split("T")[0];return this.scheduleData.filter((t=>t.date===i&&this.timeOverlaps(e,t.startTime,t.endTime)))},timeOverlaps(e,t,s){const i=parseInt(e.split(":")[0]),a=parseInt(t.split(":")[0]),r=parseInt(s.split(":")[0]);return i>=a&&i<r},handleTimeChange(){this.editingEvent.startTime&&this.editingEvent.endTime&&this.saveEvent()},editEvent(e){this.editingEvent=JSON.parse(JSON.stringify({...e,startTime:e.startTime||"08:00",endTime:e.endTime||"09:00"})),(this.isMobile||"list"!==this.viewMode)&&(this.showEditDialog=!0)},cancelEdit(){this.editingEvent=null,this.showEditDialog=!1},formatDate(e){if(!e)return"";const t=new Date(e);return`${t.getMonth()+1}月${t.getDate()}日`},getEventTagType(e){return"track"===e?"primary":"success"},getPhaseTagType(e){const t={preliminary:"info",semifinal:"warning",final:"danger"};return t[e]||"info"},getStatusTagType(e){const t={pending:"info",ongoing:"warning",completed:"success"};return t[e]||"info"},getStatusText(e){const t={pending:"未开始",ongoing:"进行中",completed:"已结束"};return t[e]||e},getPhaseText(e){return{1:"预赛",2:"半决赛",3:"决赛"}[e]||"未知"},formatTimeRange(e){return`${e.startTime} - ${e.endTime}`},getTimelineItemType(e){const t={pending:"info",ongoing:"warning",completed:"success"};return t[e]||"info"},getTimelineItemColor(e){const t={pending:"#909399",ongoing:"#E6A23C",completed:"#67C23A"};return t[e]||"#909399"},getStatusClass(e){return{"status-ongoing":"ongoing"===e,"status-completed":"completed"===e,"status-pending":"pending"===e}},checkDevice(){this.isMobile=window.innerWidth<=768},getRecentDates(){if(!this.scheduleData||!this.scheduleData.length)return[{value:this.today,label:"今天"}];const e=new Date;e.setHours(0,0,0,0);const t=new Date(e);t.setDate(t.getDate()+1);const s=new Date(e);s.setDate(s.getDate()-1);const i=new Map;return this.scheduleData.forEach((a=>{if(!a.date)return;const r=new Date(a.date);r.setHours(0,0,0,0);const n=a.date;if(!i.has(n)){let o;o=r.getTime()===e.getTime()?"今天":r.getTime()===t.getTime()?"明天":r.getTime()===s.getTime()?"昨天":`${r.getMonth()+1}月${r.getDate()}日`,i.set(n,{value:a.date,label:o})}})),Array.from(i.values()).sort(((e,t)=>new Date(e.value)-new Date(t.value)))},filterListViewData(){if(!this.scheduleData)return[];const e=this.scheduleData.filter((e=>{if("all"!==this.listViewFilters.date&&e.date!==this.listViewFilters.date)return!1;if("all"!==this.listViewFilters.timeOfDay){const t=parseInt(e.startTime?.split(":")[0]||"0");if("morning"===this.listViewFilters.timeOfDay&&t>=12)return!1;if("afternoon"===this.listViewFilters.timeOfDay&&t<12)return!1}return("all"===this.listViewFilters.compType||e.compType===this.listViewFilters.compType)&&("all"===this.listViewFilters.eventType||e.eventType===this.listViewFilters.eventType)}));return this.sortByStartTime(e)},sortByStartTime(e){return[...e].sort(((e,t)=>{const s=new Date(`${e.date} ${e.startTime}`).getTime(),i=new Date(`${t.date} ${t.startTime}`).getTime();return s-i}))},getClosestDate(e){const t=new Date;let s=e[0],i=1/0;return e.forEach((e=>{const a=Math.abs(new Date(e.value)-t);a<i&&(i=a,s=e)})),s.value}},async created(){await this.fetchScheduleData(),this.recentDates=this.getRecentDates(),this.recentDates.length>0&&(this.recentFilters.date=this.getClosestDate(this.recentDates)),this.handleWeekChange(this.currentWeek),this.refreshTimer=setInterval((()=>{this.fetchScheduleData()}),this.fetchInterval);const e=JSON.parse(localStorage.getItem("userInfo")||"{}"),t=e.powerDegree||[];this.isEditMode=t.includes(5)},watch:{viewMode:{handler(){this.updateCurrentView()},immediate:!0},"recentFilters.date"(){"browse"===this.viewMode&&this.updateCurrentView()},"recentFilters.status"(){"browse"===this.viewMode&&this.updateCurrentView()},currentWeek(){this.updateCurrentView()},listViewFilters:{handler(){"list"===this.viewMode&&this.updateCurrentView()},deep:!0}},beforeDestroy(){this.refreshTimer&&clearInterval(this.refreshTimer)}},ss=ts,is=(0,d.A)(ss,Zt,Xt,!1,null,"7251e8b3",null),as=is.exports,rs=function(){var e=this,t=e._self._c;return t("div",{staticClass:"system-settings"},[t("h2",[e._v("系统设置")]),t("el-divider",{attrs:{"content-position":"left"}},[e._v("后端服务器设置")]),t("url-setting")],1)},ns=[],os=function(){var e=this,t=e._self._c;return t("div",{staticClass:"url-setting"},[t("el-form",{ref:"form",attrs:{model:e.form,"label-width":"120px"}},[t("el-form-item",{attrs:{label:"后端地址",prop:"baseURL"}},[t("el-input",{attrs:{placeholder:"例如: http://localhost:8080"},model:{value:e.form.baseURL,callback:function(t){e.$set(e.form,"baseURL",t)},expression:"form.baseURL"}},[t("el-button",{attrs:{slot:"append"},on:{click:e.testConnection},slot:"append"},[e._v("测试连接")])],1)],1),t("el-form-item",[t("el-button",{attrs:{type:"primary"},on:{click:e.handleSave}},[e._v("保存")])],1)],1)],1)},ls=[],cs=s(4335),ds={name:"UrlSetting",data(){return{form:{baseURL:localStorage.getItem("baseURL")||"http://http://8.140.62.7:8080"}}},methods:{async testConnection(){try{const e=await cs.A.get(`${this.form.baseURL}/ping`);200===e.status&&this.$message.success("连接成功")}catch(e){this.$message.error("连接失败")}},async handleSave(){try{localStorage.setItem("baseURL",this.form.baseURL),this.$message.success("保存成功")}catch(e){this.$message.error("保存失败"),console.error("保存失败:",e)}}}},us=ds,ps=(0,d.A)(us,os,ls,!1,null,"14373951",null),ms=ps.exports,hs={name:"SystemSettings",components:{UrlSetting:ms}},gs=hs,fs=(0,d.A)(gs,rs,ns,!1,null,"31808592",null),vs=fs.exports,ys=function(){var e=this,t=e._self._c;return t("div",{staticClass:"login-register"},[t("div",{staticClass:"form-container"},[t("h2",[e._v(e._s(e.isLogin?"登录":"注册"))]),e.isLogin?t("el-form",{ref:"loginForm",attrs:{model:e.loginForm,rules:e.loginRules,"label-width":"0"}},[e.loginError?t("div",{staticClass:"error-message"},[t("i",{staticClass:"el-icon-warning"}),t("span",[e._v(e._s(e.loginError))])]):e._e(),t("el-form-item",{attrs:{prop:"username"}},[t("el-input",{attrs:{"prefix-icon":"el-icon-user",placeholder:"用户名"},model:{value:e.loginForm.username,callback:function(t){e.$set(e.loginForm,"username",t)},expression:"loginForm.username"}})],1),t("el-form-item",{attrs:{prop:"password"}},[t("el-input",{attrs:{"prefix-icon":"el-icon-lock",type:"password",placeholder:"密码"},model:{value:e.loginForm.password,callback:function(t){e.$set(e.loginForm,"password",t)},expression:"loginForm.password"}})],1),t("el-form-item",{attrs:{prop:"captcha"}},[t("div",{staticClass:"captcha-container"},[t("el-input",{attrs:{placeholder:"请输入验证码"},model:{value:e.loginForm.captcha,callback:function(t){e.$set(e.loginForm,"captcha",t)},expression:"loginForm.captcha"}}),t("img",{staticClass:"captcha-img",attrs:{src:e.captchaUrl,alt:"验证码: "+e.captchaText},on:{click:e.refreshCaptcha}})],1)]),t("el-form-item",[t("el-button",{staticClass:"submit-btn",attrs:{type:"primary"},on:{click:e.handleLogin}},[e._v("登录")])],1)],1):t("el-form",{ref:"registerForm",attrs:{model:e.registerForm,rules:e.registerRules,"label-width":"0"}},[e.registerError?t("div",{staticClass:"error-message"},[t("i",{staticClass:"el-icon-warning"}),t("span",[e._v(e._s(e.registerError))])]):e._e(),t("el-form-item",{attrs:{prop:"name"}},[t("el-input",{attrs:{"prefix-icon":"el-icon-user",placeholder:"用户名"},model:{value:e.registerForm.name,callback:function(t){e.$set(e.registerForm,"name",t)},expression:"registerForm.name"}})],1),t("el-form-item",{attrs:{prop:"password"}},[t("el-input",{attrs:{"prefix-icon":"el-icon-lock",type:"password",placeholder:"密码"},model:{value:e.registerForm.password,callback:function(t){e.$set(e.registerForm,"password",t)},expression:"registerForm.password"}})],1),t("el-form-item",{attrs:{prop:"confirmPassword"}},[t("el-input",{attrs:{"prefix-icon":"el-icon-lock",type:"password",placeholder:"确认密码"},model:{value:e.registerForm.confirmPassword,callback:function(t){e.$set(e.registerForm,"confirmPassword",t)},expression:"registerForm.confirmPassword"}})],1),e.isLogin?e._e():t("div",{staticClass:"join-org"},[t("el-checkbox",{model:{value:e.registerForm.wantJoin,callback:function(t){e.$set(e.registerForm,"wantJoin",t)},expression:"registerForm.wantJoin"}},[e._v(" 加入团体 ")])],1),e.registerForm.wantJoin&&!e.isLogin?t("el-form-item",{attrs:{prop:"userType"}},[t("el-checkbox-group",{model:{value:e.registerForm.userType,callback:function(t){e.$set(e.registerForm,"userType",t)},expression:"registerForm.userType"}},[t("el-checkbox",{attrs:{label:2}},[e._v("团体负责人")]),t("el-checkbox",{attrs:{label:3}},[e._v("裁判")]),t("el-checkbox",{attrs:{label:4}},[e._v("运动员")]),t("el-checkbox",{attrs:{label:5}},[e._v("运动会操办者")])],1)],1):e._e(),e.registerForm.wantJoin?t("el-form-item",{attrs:{prop:"inviteCode"}},[t("el-input",{attrs:{"prefix-icon":"el-icon-key",placeholder:"请输入邀请码"},model:{value:e.registerForm.inviteCode,callback:function(t){e.$set(e.registerForm,"inviteCode",t)},expression:"registerForm.inviteCode"}})],1):e._e(),t("el-form-item",{attrs:{prop:"captcha"}},[t("div",{staticClass:"captcha-container"},[t("el-input",{attrs:{placeholder:"请输入验证码"},model:{value:e.registerForm.captcha,callback:function(t){e.$set(e.registerForm,"captcha",t)},expression:"registerForm.captcha"}}),t("img",{staticClass:"captcha-img",attrs:{src:e.captchaUrl,alt:"验证码: "+e.captchaText},on:{click:e.refreshCaptcha}})],1)]),t("el-form-item",[t("el-button",{staticClass:"submit-btn",attrs:{type:"primary"},on:{click:e.handleRegister}},[e._v("注册")])],1)],1),t("div",{staticClass:"switch-form"},[t("span",{on:{click:e.toggleForm}},[e._v(" "+e._s(e.isLogin?"没有账号？立即注册":"已有账号？立即登录")+" ")])])],1)])},bs=[],ws=s(3603),Ss={name:"LoginRegister",components:{},data(){const e=(e,t,s)=>{""===t?s(new Error("请输入密码")):t.length<6?s(new Error("密码不能少于6个字符")):(""!==this.registerForm.confirmPassword&&this.$refs.registerForm.validateField("confirmPassword"),s())},t=(e,t,s)=>{""===t?s(new Error("请再次输入密码")):t!==this.registerForm.password?s(new Error("两次输入密码不一致!")):s()};return{isLogin:!0,captchaUrl:"",captchaText:"",loginForm:{username:"",password:"",captcha:""},registerForm:{name:"",password:"",confirmPassword:"",userType:[],wantJoin:!1,inviteCode:"",captcha:""},loginRules:{username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码不能少于6个字符",trigger:"blur"}],captcha:[{required:!0,message:"请输入验证码",trigger:"blur"},{len:4,message:"验证码长度为4位",trigger:"blur"}]},registerRules:{name:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],password:[{required:!0,validator:e,trigger:"blur"}],confirmPassword:[{required:!0,validator:t,trigger:"blur"}],userType:[{type:"array",required:!0,message:"请至少选择一种身份",trigger:"change",validator:(e,t,s)=>{!this.registerForm.wantJoin||t&&0!==t.length?s():s(new Error("请至少选择一种身份"))}}],inviteCode:[{required:!0,message:"请输入邀请码",trigger:"blur",validator:(e,t,s)=>{this.registerForm.wantJoin&&!t?s(new Error("请输入邀请码")):s()}}],captcha:[{required:!0,message:"请输入验证码",trigger:"blur"},{len:4,message:"验证码长度为4位",trigger:"blur"}]},loginError:"",registerError:""}},watch:{"registerForm.wantJoin"(e){e||(this.registerForm.userType=[],this.registerForm.inviteCode="")}},methods:{generateCaptcha(){const e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";let t="";for(let s=0;s<4;s++)t+=e[Math.floor(Math.random()*e.length)];return t},drawCaptcha(){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=120,e.height=40,t.fillStyle="#f5f7fa",t.fillRect(0,0,e.width,e.height),this.captchaText=this.generateCaptcha(),t.font="bold 24px Arial",t.fillStyle="#666",t.textBaseline="middle";for(let s=0;s<this.captchaText.length;s++){const e=20+25*s,i=20,a=this.captchaText[s],r=.3*(Math.random()-.5);t.save(),t.translate(e,i),t.rotate(r),t.fillText(a,0,0),t.restore()}for(let s=0;s<3;s++)t.strokeStyle=`rgba(${255*Math.random()},${255*Math.random()},${255*Math.random()},0.3)`,t.beginPath(),t.moveTo(Math.random()*e.width,Math.random()*e.height),t.lineTo(Math.random()*e.width,Math.random()*e.height),t.stroke();for(let s=0;s<30;s++)t.fillStyle=`rgba(${255*Math.random()},${255*Math.random()},${255*Math.random()},0.3)`,t.beginPath(),t.arc(Math.random()*e.width,Math.random()*e.height,1,0,2*Math.PI),t.fill();return e.toDataURL()},refreshCaptcha(){this.captchaUrl=this.drawCaptcha()},toggleForm(){this.isLogin=!this.isLogin,this.$nextTick((()=>{this.refreshCaptcha()}))},async handleLogin(){this.loginError="";try{const e=await this.$refs.loginForm.validate();if(e){if(this.loginForm.captcha.toLowerCase()!==this.captchaText.toLowerCase())return this.loginError="验证码错误",void this.refreshCaptcha();const e=new URLSearchParams;e.append("username",this.loginForm.username),e.append("password",this.loginForm.password);const t=await(0,V.A)({url:"/login",method:"post",data:e});if(1===t.code){const[e,s]=t.data;(0,ws.YQ)(e,s),this.$message.success("登录成功"),this.$router.push("/")}else"NO_EXIST_USER"===t.message?this.loginError="用户名或密码错误":this.loginError=t.msg||"登录失败",this.refreshCaptcha()}}catch(e){console.error("登录失败:",e),this.loginError="登录失败，请稍后重试",this.refreshCaptcha()}},async handleRegister(){this.registerError="";try{const e=await this.$refs.registerForm.validate();if(e){if(this.registerForm.captcha.toLowerCase()!==this.captchaText.toLowerCase())return this.registerError="验证码错误",void this.refreshCaptcha();const e=new URLSearchParams;e.append("name",this.registerForm.name),e.append("password",this.registerForm.password);const t=Array.isArray(this.registerForm.userType)?this.registerForm.userType:[];t.forEach((t=>{e.append("userType",t)})),e.append("joinOrganization",this.registerForm.wantJoin),this.registerForm.wantJoin&&e.append("inviteCode",this.registerForm.inviteCode);const s=await(0,V.A)({url:"/register",method:"post",data:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(1===s.code)this.$message.success(s.data||"注册成功"),this.isLogin=!0;else{switch(s.message){case"INVALID_CODE":this.registerError=s.data;break;case"NAME_DUPLICATE":this.registerError=s.data;break;default:this.registerError=s.data}this.refreshCaptcha()}}}catch(e){console.error("注册失败:",e),this.registerError="注册失败，请稍后重试",this.refreshCaptcha()}}},mounted(){this.refreshCaptcha()},created(){const e=new URLSearchParams(window.location.search),t=e.get("error");t&&(this.loginError=decodeURIComponent(t),this.isLogin=!0)}},Cs=Ss,Ts=(0,d.A)(Cs,ys,bs,!1,null,"5770dca8",null),Ds=Ts.exports,_s=function(){var e=this,t=e._self._c;return t("div",{staticClass:"sport-meeting-settings"},[t("div",{staticClass:"settings-container"},[t("div",{staticClass:"content-wrapper"},[t("el-row",{staticClass:"top-row",attrs:{gutter:20}},[t("el-col",{attrs:{xs:24,sm:24,md:8}},[t("div",{staticClass:"section"},[t("h3",{staticClass:"section-title"},[e._v("基本信息配置")]),t("el-form",{ref:"basicForm",staticClass:"basic-form",attrs:{model:e.basicForm,rules:e.basicRules,"label-width":"120px"}},[t("el-form-item",{attrs:{label:"运动会名称",prop:"name"}},[t("el-input",{model:{value:e.basicForm.name,callback:function(t){e.$set(e.basicForm,"name",t)},expression:"basicForm.name"}})],1),t("el-form-item",{staticClass:"cover-form-item",attrs:{label:"运动会封面",prop:"cover"}},[t("div",{staticStyle:{"margin-top":"12px","margin-left":"32px"}},[t("image-uploader",{attrs:{imageUrl:e.coverPreview,file:e.basicForm.coverFile},on:{"update:imageUrl":function(t){e.coverPreview=t},"update:image-url":function(t){e.coverPreview=t},"update:file":function(t){return e.$set(e.basicForm,"coverFile",t)}}})],1)]),t("el-form-item",[t("el-button",{attrs:{type:"primary"},on:{click:e.handleBasicSave}},[e._v("保存")])],1)],1)],1)]),t("el-col",{attrs:{xs:24,sm:24,md:16}},[t("div",{staticClass:"section"},[t("h3",{staticClass:"section-title"},[e._v("时间配置")]),t("el-form",{ref:"timeForm",attrs:{model:e.timeForm,rules:e.timeRules,"label-width":"120px"}},[t("el-form-item",{staticClass:"time-range",attrs:{label:"运动会时间",required:""}},[t("div",{staticClass:"time-inputs"},[t("el-form-item",{staticClass:"time-input-item",attrs:{prop:"startTime"}},[t("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"datetime",placeholder:"开始时间","value-format":"timestamp","default-value":new Date},model:{value:e.timeForm.startTime,callback:function(t){e.$set(e.timeForm,"startTime",t)},expression:"timeForm.startTime"}})],1),t("el-form-item",{staticClass:"time-input-item",attrs:{prop:"endTime"}},[t("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"datetime",placeholder:"结束时间","value-format":"timestamp","default-value":new Date},model:{value:e.timeForm.endTime,callback:function(t){e.$set(e.timeForm,"endTime",t)},expression:"timeForm.endTime"}})],1)],1)]),t("el-form-item",{staticClass:"time-range",attrs:{label:"上午比赛时间",required:""}},[t("div",{staticClass:"time-inputs"},[t("el-form-item",{staticClass:"time-input-item",attrs:{prop:"amStartTime"}},[t("el-time-picker",{staticStyle:{width:"100%"},attrs:{placeholder:"开始时间","value-format":"HH:mm:ss","default-value":new Date},model:{value:e.timeForm.amStartTime,callback:function(t){e.$set(e.timeForm,"amStartTime",t)},expression:"timeForm.amStartTime"}})],1),t("el-form-item",{staticClass:"time-input-item",attrs:{prop:"amEndTime"}},[t("el-time-picker",{staticStyle:{width:"100%"},attrs:{placeholder:"结束时间","value-format":"HH:mm:ss","default-value":new Date},model:{value:e.timeForm.amEndTime,callback:function(t){e.$set(e.timeForm,"amEndTime",t)},expression:"timeForm.amEndTime"}})],1)],1)]),t("el-form-item",{staticClass:"time-range",attrs:{label:"下午比赛时间",required:""}},[t("div",{staticClass:"time-inputs"},[t("el-form-item",{staticClass:"time-input-item",attrs:{prop:"pmStartTime"}},[t("el-time-picker",{staticStyle:{width:"100%"},attrs:{placeholder:"开始时间","value-format":"HH:mm:ss","default-value":new Date},model:{value:e.timeForm.pmStartTime,callback:function(t){e.$set(e.timeForm,"pmStartTime",t)},expression:"timeForm.pmStartTime"}})],1),t("el-form-item",{staticClass:"time-input-item",attrs:{prop:"pmEndTime"}},[t("el-time-picker",{staticStyle:{width:"100%"},attrs:{placeholder:"结束时间","value-format":"HH:mm:ss","default-value":new Date},model:{value:e.timeForm.pmEndTime,callback:function(t){e.$set(e.timeForm,"pmEndTime",t)},expression:"timeForm.pmEndTime"}})],1)],1)]),t("el-form-item",{attrs:{label:"报名截止时间",required:"",prop:"registrationDeadline"}},[t("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"datetime",placeholder:"选择报名截止时间","value-format":"timestamp","default-value":new Date},model:{value:e.timeForm.registrationDeadline,callback:function(t){e.$set(e.timeForm,"registrationDeadline",t)},expression:"timeForm.registrationDeadline"}}),t("div",{staticClass:"time-tip"},[e._v("注意：报名截止时间是自动编排、自动分组、自动编号的时间点确认")])],1),t("el-form-item",[t("el-button",{attrs:{type:"primary"},on:{click:e.handleTimeSave}},[e._v("保存")])],1)],1)],1)])],1),t("div",{staticClass:"section",staticStyle:{"margin-bottom":"20px"}},[t("h3",{staticClass:"section-title"},[e._v("进行阶段")]),t("div",{staticClass:"lifecycle-track"},[e._l(e.stages,(function(s,i){return t("div",{key:i,staticClass:"status-point",class:{active:e.meetingInfo.status>=i+1,current:e.meetingInfo.status===i+1,clickable:i+1!==3},on:{click:function(t){i+1!==3&&e.showStageInfo(i+1)}}},[t("div",{staticClass:"point"}),t("div",{staticClass:"label"},[e._v(e._s(s.label))])])})),t("div",{staticClass:"progress-line",style:{width:e.progressWidth}})],2)]),t("div",{staticClass:"section"},[t("h3",{staticClass:"section-title"},[e._v("职员配置")]),t("el-tabs",{model:{value:e.activeTab,callback:function(t){e.activeTab=t},expression:"activeTab"}},[t("el-tab-pane",{attrs:{label:"职员管理",name:"staff"}},[t("div",{staticClass:"action-bar"},[t("el-button",{attrs:{type:"primary"},on:{click:e.showAddStaffDialog}},[e._v("添加职员")])],1),t("el-table",{attrs:{data:e.staffList,border:""},on:{"row-click":e.handleStaffRowClick}},[t("el-table-column",{attrs:{prop:"username",label:"用户名",width:"150"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("div",{staticClass:"clickable-cell"},[e._v(e._s(s.row.username))])]}}])}),t("el-table-column",{attrs:{label:"职位"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("div",{staticClass:"clickable-cell"},e._l(s.row.userType,(function(s){return t("el-tag",{key:s,staticClass:"user-type-tag",attrs:{type:e.getTypeTag(s)}},[e._v(" "+e._s(e.getTypeLabel(s))+" ")])})),1)]}}])}),t("el-table-column",{attrs:{label:"操作",width:"100",align:"right"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("div",{staticClass:"operation-buttons",on:{click:function(e){e.stopPropagation()}}},[s.row.isEditing?[t("el-button",{attrs:{size:"mini",type:"success"},on:{click:function(t){return e.saveStaffEdit(s.row)}}},[e._v("保存")]),t("el-button",{attrs:{size:"mini",type:"info"},on:{click:function(t){return e.cancelStaffEdit(s.row)}}},[e._v("取消")])]:[t("el-button",{staticClass:"delete-btn",attrs:{size:"mini",type:"text"},on:{click:function(t){return e.handleDeleteStaff(s.row)}}},[t("i",{staticClass:"el-icon-close"})]),t("el-button",{staticClass:"edit-btn",attrs:{size:"mini",type:"text"},on:{click:function(t){return e.handleEditStaff(s.row)}}},[t("i",{staticClass:"el-icon-edit"})])]],2)]}}])})],1)],1),t("el-tab-pane",{attrs:{label:"邀请码管理",name:"invites"}},[t("div",{staticClass:"action-bar"},[t("el-button",{attrs:{type:"primary"},on:{click:e.showAddInviteDialog}},[e._v("添加邀请码")])],1),t("el-table",{attrs:{data:e.inviteList,border:""}},[t("el-table-column",{attrs:{prop:"code",label:"邀请码",width:"100"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("div",{staticClass:"clickable-cell",on:{click:function(t){return e.handleEditInvite(s.row)}}},[e._v(" "+e._s(s.row.code)+" ")])]}}])}),t("el-table-column",{attrs:{label:"可用职位"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("div",{staticClass:"clickable-cell",on:{click:function(t){return e.handleEditInvite(s.row)}}},e._l(s.row.userType,(function(s){return t("el-tag",{key:s,staticClass:"user-type-tag",attrs:{type:e.getTypeTag(s)}},[e._v(" "+e._s(e.getTypeLabel(s))+" ")])})),1)]}}])}),t("el-table-column",{attrs:{prop:"expireTime",label:"有效期至"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("div",{staticClass:"clickable-cell",on:{click:function(t){return e.handleEditInvite(s.row)}}},[e._v(" "+e._s(e.formatTime(s.row.expireTime))+" ")])]}}])}),t("el-table-column",{attrs:{label:"操作",width:"80",align:"right"},scopedSlots:e._u([{key:"default",fn:function(s){return[t("el-button",{staticClass:"delete-btn",attrs:{size:"mini",type:"text",icon:"el-icon-close",circle:""},on:{click:function(t){return t.stopPropagation(),e.handleDeleteInvite(s.row)}}}),t("el-button",{staticClass:"edit-btn",attrs:{size:"mini",type:"text",icon:"el-icon-edit",circle:""},on:{click:function(t){return t.stopPropagation(),e.handleEditInvite(s.row)}}})]}}])})],1)],1)],1)],1),t("div",{staticClass:"danger-zone"},[t("h3",{staticClass:"section-title"},[e._v("危险操作")]),t("el-button",{attrs:{type:"danger",plain:""},on:{click:function(t){e.showDeleteDialog=!0}}},[e._v(" 删除运动会 ")])],1),t("responsive-dialog",{attrs:{visible:e.showDeleteDialog,title:"删除运动会",width:"400px","hide-default-footer":!0},on:{"update:visible":function(t){e.showDeleteDialog=t}},scopedSlots:e._u([{key:"footer",fn:function(){return[t("div",{staticClass:"custom-footer"},[t("el-button",{attrs:{type:"danger"},on:{click:e.handleDelete}},[e._v("删除")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){e.showDeleteDialog=!1}}},[e._v("取消")])],1)]},proxy:!0}])},[t("div",{staticClass:"delete-warning"},[e._v(" 您确定要删除当前运动会？ "),t("p",{staticClass:"warning-detail"},[e._v(" 当前运动会的所有职员、比赛项目及规则、团体都会被删除，这是一个不可逆的操作！ ")])])]),t("responsive-dialog",{attrs:{visible:e.staffDialog.visible,title:e.staffDialog.title,width:"500px"},on:{"update:visible":function(t){return e.$set(e.staffDialog,"visible",t)},confirm:e.handleStaffConfirm,cancel:function(t){e.staffDialog.visible=!1}}},[t("el-form",{ref:"staffForm",attrs:{model:e.staffForm,rules:e.staffRules,"label-width":"100px"}},[e.staffDialog.isEdit?e._e():[t("el-radio-group",{staticClass:"add-type-radio",staticStyle:{"margin-bottom":"20px"},model:{value:e.staffForm.addType,callback:function(t){e.$set(e.staffForm,"addType",t)},expression:"staffForm.addType"}},[t("el-radio",{attrs:{label:1}},[e._v("分配账号")]),t("el-radio",{attrs:{label:2}},[e._v("自主注册")])],1),1===e.staffForm.addType?[t("el-form-item",{attrs:{label:"用户名",prop:"username"}},[t("el-input",{model:{value:e.staffForm.username,callback:function(t){e.$set(e.staffForm,"username",t)},expression:"staffForm.username"}})],1),t("el-form-item",{attrs:{label:"密码",prop:"password"}},[t("el-input",{attrs:{type:"password"},model:{value:e.staffForm.password,callback:function(t){e.$set(e.staffForm,"password",t)},expression:"staffForm.password"}})],1)]:e._e(),2===e.staffForm.addType?[t("el-form-item",{attrs:{label:"邀请码",prop:"inviteCode"}},[t("el-input",{model:{value:e.staffForm.inviteCode,callback:function(t){e.$set(e.staffForm,"inviteCode",t)},expression:"staffForm.inviteCode"}},[t("el-button",{attrs:{slot:"append"},on:{click:e.generateInviteCode},slot:"append"},[e._v("生成")])],1)],1),t("el-form-item",{attrs:{label:"有效期至",prop:"expireTime"}},[t("el-date-picker",{attrs:{type:"datetime",placeholder:"选择有效期","value-format":"timestamp","picker-options":{disabledDate(e){return e.getTime()<Date.now()-864e5}}},model:{value:e.staffForm.expireTime,callback:function(t){e.$set(e.staffForm,"expireTime",t)},expression:"staffForm.expireTime"}})],1)]:e._e()],t("el-form-item",{attrs:{label:"职位",prop:"userType"}},[t("el-checkbox-group",{model:{value:e.staffForm.userType,callback:function(t){e.$set(e.staffForm,"userType",t)},expression:"staffForm.userType"}},[t("el-checkbox",{attrs:{label:1}},[e._v("用户")]),t("el-checkbox",{attrs:{label:2}},[e._v("团体负责人")]),t("el-checkbox",{attrs:{label:3}},[e._v("裁判")]),t("el-checkbox",{attrs:{label:4}},[e._v("运动员")]),t("el-checkbox",{attrs:{label:5}},[e._v("运动会操办者")])],1)],1),e.staffDialog.isEdit&&e.staffForm.code?t("el-form-item",{attrs:{label:"截止日期",prop:"expireTime"}},[t("el-date-picker",{attrs:{type:"datetime",placeholder:"选择截止日期","value-format":"timestamp","picker-options":{disabledDate(e){return e.getTime()<Date.now()-864e5}}},model:{value:e.staffForm.expireTime,callback:function(t){e.$set(e.staffForm,"expireTime",t)},expression:"staffForm.expireTime"}})],1):e._e(),e.staffForm.error?t("div",{staticClass:"error-tip"},[e._v(e._s(e.staffForm.error))]):e._e()],2)],1),t("responsive-dialog",{attrs:{title:e.currentStage?.label||"状态信息",width:"500px",hideDefaultFooter:!0,visible:e.dialogVisible},on:{"update:visible":function(t){e.dialogVisible=t}},model:{value:e.dialogVisible,callback:function(t){e.dialogVisible=t},expression:"dialogVisible"}},[t("div",{staticClass:"stage-info"},[t("p",[e._v(e._s(e.currentStage?.description||""))])])])],1)])])},Es=[],ks=s(4353),xs=s.n(ks),Is={name:"SportMeetingSettings",components:{ResponsiveDialog:F.A,ImageUploader:P.A},data(){return{meetingInfo:{status:1,startTime:"",endTime:"",registrationDeadline:""},dialogVisible:!1,currentStage:null,stages:[{label:"报名中",status:1,description:"报名中状态将不会自动排赛、自动分组、自动晋级等，仅支持各种管理查询操作。"},{label:"进行中",status:2,description:"• 报名截至时将会自动完成赛程编排、预赛（或决赛制的预赛）分组\n• 该状态将持续统计更新运动员成绩，并且持续自动为完成评分的比赛晋级处理"},{label:"已结束",status:3,description:"所有比赛已结束，可以查看统计数据和成绩报告。"}],activeTab:"staff",isSchoolMode:!0,staffList:[],inviteList:[],staffDialog:{visible:!1,title:"",isEdit:!1},uploadUrl:{NODE_ENV:"production",BASE_URL:"/"}.VUE_APP_BASE_API+"/uploadCover",staffForm:{addType:1,username:"",password:"",inviteCode:"",expireTime:"",userType:[],uid:"",error:""},staffRules:{username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}],inviteCode:[{required:!0,message:"请输入邀请码",trigger:"blur"},{pattern:/^[a-zA-Z0-9_]+$/,message:"仅允许字母、数字和下划线",trigger:"blur"}],expireTime:[{required:!0,message:"请选择有效期",trigger:"change"}],userType:[{required:!0,message:"请选择至少一个职位",trigger:"change"}]},basicForm:{name:"",cover:"",coverFile:null},coverPreview:"",timeForm:{startTime:"",endTime:"",amStartTime:"",amEndTime:"",pmStartTime:"",pmEndTime:"",registrationDeadline:""},basicRules:{name:[{required:!0,message:"请输入运动会名称",trigger:"blur"}]},timeRules:{startTime:[{required:!0,message:"请选择开始时间",trigger:"change"}],endTime:[{required:!0,message:"请选择结束时间",trigger:"change"}],amStartTime:[{required:!0,message:"请选择时间",trigger:"change"}],amEndTime:[{required:!0,message:"请选择时间",trigger:"change"}],pmStartTime:[{required:!0,message:"请选择时间",trigger:"change"}],pmEndTime:[{required:!0,message:"请选择时间",trigger:"change"}],registrationDeadline:[{required:!0,message:"请选择报名截止时间",trigger:"change"}]},showDeleteDialog:!1}},computed:{progressWidth(){const e=this.meetingInfo?.status||0;return e<=1?"0%":2===e?"50%":"100%"}},methods:{getTypeTag(e){const t={1:"",2:"success",3:"warning"};return t[e]||"info"},getTypeLabel(e){const t={1:"用户",2:"团体负责人",3:"裁判",4:"运动员",5:"运动会操办者"};return t[e]||"未知职位"},formatTime(e){if(!e)return"";const t="string"===typeof e?new Date(e):new Date(Number(e));return xs()(t).format("YYYY-MM-DD HH:mm:ss")},generateInviteCode(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_";let t="";for(let s=0;s<8;s++)t+=e.charAt(Math.floor(Math.random()*e.length));this.staffForm.inviteCode=t},showAddStaffDialog(){this.staffDialog.title="添加职员",this.staffDialog.isEdit=!1,this.staffDialog.visible=!0,this.staffForm={addType:1,username:"",password:"",inviteCode:"",expireTime:"",userType:[],error:""}},showAddInviteDialog(){this.staffDialog.title="添加邀请码",this.staffDialog.isEdit=!1,this.staffDialog.visible=!0,this.staffForm={addType:2,username:"",password:"",inviteCode:"",expireTime:"",userType:[],error:""},this.generateInviteCode()},async handleStaffConfirm(){try{if(this.staffForm.error="",await this.$refs.staffForm.validate(),this.staffDialog.isEdit)if(this.staffForm.code){const e=await(0,V.A)({url:"/updateInviteCodePower",method:"put",data:{code:this.staffForm.code,userType:this.staffForm.userType}});1===e.code&&(this.$message.success("修改成功"),this.staffDialog.visible=!1,this.fetchInviteList())}else{const e=await(0,V.A)({url:"/updateUserPower",method:"put",data:{uid:this.staffForm.uid,userType:this.staffForm.userType}});1===e.code&&(this.$message.success("修改成功"),this.staffDialog.visible=!1,this.fetchStaffList())}else if(1===this.staffForm.addType){const e=new FormData;e.append("name",this.staffForm.username),e.append("password",this.staffForm.password),e.append("powerDegree",JSON.stringify(this.staffForm.userType));const t=await(0,V.A)({url:"/register",method:"post",data:e});1===t.code&&(this.$message.success("添加成功"),this.staffDialog.visible=!1,this.fetchStaffList())}else{const e={code:this.staffForm.inviteCode,userType:this.staffForm.userType,expireTime:new Date(this.staffForm.expireTime).toISOString()},t=await(0,V.A)({url:"/createInviteCode",method:"post",data:e});1===t.code?(this.$message.success("邀请码创建成功"),this.staffDialog.visible=!1,this.fetchInviteList()):0===t.code&&"DUPLICATED_CODE"===t.message&&(this.staffForm.error="该邀请码已存在，请重新生成或手动输入")}}catch(e){console.error("操作失败:",e)}},async handleBasicSave(){try{await this.$refs.basicForm.validate();const e=new FormData;e.append("name",this.basicForm.name),this.basicForm.coverFile&&e.append("cover",this.basicForm.coverFile);const t=await(0,V.A)({url:"/updateMeetingBasic",method:"put",data:e,headers:{"Content-Type":"multipart/form-data"}});1===t.code&&(this.$message.success("保存成功"),t.data&&t.data.coverUrl&&(this.basicForm.cover=t.data.coverUrl))}catch(e){console.error("保存失败:",e)}},async handleTimeSave(){try{await this.$refs.timeForm.validate();const e={startTime:new Date(this.timeForm.startTime).toISOString(),endTime:new Date(this.timeForm.endTime).toISOString(),amStartTime:this.timeForm.amStartTime,amEndTime:this.timeForm.amEndTime,pmStartTime:this.timeForm.pmStartTime,pmEndTime:this.timeForm.pmEndTime,registrationDeadline:new Date(this.timeForm.registrationDeadline).toISOString()},t=await(0,V.A)({url:"/updateMeetingTime",method:"put",data:e});1===t.code&&this.$message.success("保存成功")}catch(e){console.error("保存失败:",e)}},async fetchMeetingInfo(){try{const e=await(0,V.A)({url:"/getMeetingInfo",method:"get"});if(1===e.code){const t=e.data;this.meetingInfo={status:t.status,startTime:t.startTime,endTime:t.endTime,registrationDeadline:t.registrationDeadline},this.basicForm.name=t.name,this.basicForm.cover=t.img;const s=new Date(t.startTime),i=new Date(t.endTime),a=new Date(t.registrationDeadline);this.timeForm={startTime:s.getTime(),endTime:i.getTime(),amStartTime:t.amStartTime,amEndTime:t.amEndTime,pmStartTime:t.pmStartTime,pmEndTime:t.pmEndTime,registrationDeadline:a.getTime()}}}catch(e){console.error("获取运动会信息失败:",e),this.$message.error("获取运动会信息失败")}},async handleEditStaff(e){this.staffDialog.title="编辑职员",this.staffDialog.isEdit=!0,this.staffDialog.visible=!0,this.staffForm={username:e.username,userType:e.userType,uid:e.uid}},async handleEditInvite(e){this.staffDialog.title="编辑邀请码",this.staffDialog.isEdit=!0,this.staffDialog.visible=!0,this.staffForm={...e}},async handleDeleteStaff(e){try{await this.$confirm("确定要删除该职员吗（删除职员后，职员账号仍然存在，但不具有当前运动会的任何身份）？");const t=await(0,V.A)({url:`/deleteStaff/${e.uid}`,method:"delete"});1===t.code&&(this.$message.success("删除成功"),this.fetchStaffList())}catch(t){"cancel"!==t&&console.error("删除失败:",t)}},async handleDeleteInvite(e){try{await this.$confirm("确定要删除该邀请码吗？");const t=await(0,V.A)({url:`/deleteInviteCode/${e.code}`,method:"delete"});1===t.code&&(this.$message.success("删除成功"),this.fetchInviteList())}catch(t){"cancel"!==t&&console.error("删除失败:",t)}},async fetchStaffList(){try{const e=await(0,V.A)({url:"/getStaffList",method:"get"});1===e.code&&(this.staffList=e.data.map((e=>({uid:e.uid,username:e.name,userType:JSON.parse(e.powerDegree||"[]")}))))}catch(e){console.error("获取职员列表失败:",e)}},async fetchInviteList(){try{const e=await(0,V.A)({url:"/getInviteCodes",method:"get"});1===e.code&&(this.inviteList=e.data)}catch(e){console.error("获取邀请码列表失败:",e)}},handleCoverSuccess(e){1===e.code?this.basicForm.cover=e.data.url:this.$message.error("上传失败")},beforeCoverUpload(e){if(!e.type.startsWith("image/"))return this.$message.error("请上传图片格式的文件!"),!1;const t=new FileReader;return t.onload=e=>{this.coverPreview=e.target.result,this.$forceUpdate()},t.readAsDataURL(e),this.basicForm.coverFile=e,!1},handleRowClick(e){"staff"===this.activeTab&&(e.isEditing=!e.isEditing,e.isEditing||this.fetchStaffList())},saveStaffEdit(e){this.handleEditStaff(e)},cancelStaffEdit(e){e.isEditing=!1,this.fetchStaffList()},async handleDelete(){try{const e=await(0,V.A)({url:"/deleteMeeting",method:"delete"});1===e.code&&(this.$message.success("删除成功"),this.$router.push("/sport-meetings"))}catch(e){console.error("删除失败:",e),this.$message.error(e.message||"删除失败")}finally{this.showDeleteDialog=!1}},showStageInfo(e){const t=this.stages.find((t=>t.status===e));t&&(this.currentStage=t,this.dialogVisible=!0)},formatTimeInfo(e){return e?e.replace("{{ registrationDeadline }}",this.formatDateTime(this.meetingInfo?.registrationDeadline)).replace("{{ startTime }}",this.formatDateTime(this.meetingInfo?.startTime)).replace("{{ endTime }}",this.formatDateTime(this.meetingInfo?.endTime)):""},formatDateTime(e){if(!e)return"";const t=new Date(e);return t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},handleStaffRowClick(e){this.handleEditStaff(e)}},mounted(){this.fetchMeetingInfo(),this.fetchStaffList(),this.fetchInviteList(),this.basicForm.cover&&(this.coverPreview=this.basicForm.cover)},watch:{"basicForm.cover":{handler(e){e&&!this.coverPreview&&(this.coverPreview=e)},immediate:!0}}},$s=Is,Fs=(0,d.A)($s,_s,Es,!1,null,"5a3fd474",null),Ps=Fs.exports,As=function(){var e=this,t=e._self._c;return t("div",{staticClass:"user-profile"},[e.isSubRoute?t("router-view"):[t("el-card",{staticClass:"profile-card"},[t("div",{staticClass:"profile-header"},[t("div",{staticClass:"left-section"},[t("div",{staticClass:"avatar-wrapper",on:{click:e.handleAvatarClick}},[t("el-avatar",{attrs:{size:80,src:e.userInfo.head}},[e._v(" "+e._s(e.userInfo.name?.charAt(0)||"游")+" ")]),e.isLoggedIn?e._e():t("div",{staticClass:"login-tip"},[e._v("点击登录")])],1),t("div",{staticClass:"info-wrapper"},[t("div",{staticClass:"name-line"},[t("h2",[e._v(e._s(e.userInfo.name||"未登录"))]),t("div",{staticClass:"roles",class:{"wrap-roles":e.userRoles.length>=3}},e._l(e.userRoles,(function(s){return t("el-tag",{key:s.id,attrs:{type:s.type,size:"small"}},[e._v(" "+e._s(s.label)+" ")])})),1)]),t("br"),e.isLoggedIn?t("el-button",{staticClass:"logout-btn",attrs:{type:"text"},on:{click:e.handleLogout}},[e._v(" 退出登录 ")]):e._e()],1)]),t("div",{staticClass:"right-actions"},[t("el-button",{staticClass:"settings-btn",attrs:{type:"text"},on:{click:function(t){return e.$router.push("/system-settings")}}},[t("i",{staticClass:"el-icon-setting"})]),t("br")],1)]),t("div",{staticClass:"current-meeting"},[t("div",{staticClass:"meeting-label"},[e._v("当前运动会")]),t("el-select",{attrs:{placeholder:"暂未选择"},on:{change:e.handleMeetingChange},model:{value:e.currentSmId,callback:function(t){e.currentSmId=t},expression:"currentSmId"}},[e._l(e.followedMeetings,(function(e){return t("el-option",{key:e.smId,attrs:{label:e.name,value:e.smId}})})),t("el-divider"),t("el-option",{attrs:{value:"more"}},[t("div",{staticClass:"join-more",on:{click:e.goToSportMeetings}},[t("i",{staticClass:"el-icon-plus"}),e._v(" "+e._s(e.followedMeetings.length?"加入更多运动会":"加入运动会")+" ")])])],2)],1)]),t("el-tabs",{staticClass:"profile-tabs",model:{value:e.activeTab,callback:function(t){e.activeTab=t},expression:"activeTab"}},[t("el-tab-pane",{attrs:{label:"我的团体",name:"schools"}},[e.isLoggedIn?t("div",{staticClass:"schools-list"},e._l(e.mySchools,(function(s){return t("school-card",{key:s.scId,attrs:{"school-data":{id:s.scId,name:s.name,slogan:s.slogan,image:s.img,detail:s},"is-active":e.activeSchoolId===s.scId,"is-edit-mode":e.hasManagePermission,"sport-events":e.availableSports,loading:e.schoolLoading,"max-players":e.configForm.maxPlayers,"max-events":e.configForm.maxEvents,"level-config":e.configForm.levelConfig},on:{"update:loading":function(t){e.schoolLoading=t},toggle:e.toggleSchool}})})),1):t("div",{staticClass:"empty-state"},[t("el-empty",[t("template",{slot:"description"},[t("p",[e._v("登录后可加入团体")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.$router.push("/login")}}},[e._v(" 去登录 ")])],1)],2)],1)]),t("el-tab-pane",{attrs:{label:"我的项目",name:"events"}},[e.isLoggedIn?t("div",[e._l(e.userInfo.mySports,(function(s){return t("judge-competition-card",{key:s.spId,attrs:{"competition-data":s,"is-active":e.activeEventId===s.spId,pid:e.userInfo.pid,"is-edit-mode":!1,"score-rules":[]},on:{toggle:e.toggleEvent}})})),e.userInfo.mySports?.length?e._e():t("el-empty",{attrs:{description:"暂无参赛项目"}})],2):t("div",{staticClass:"empty-state"},[t("el-empty",[t("template",{slot:"description"},[t("p",[e._v("登录后可报名参赛")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.$router.push("/login")}}},[e._v(" 去登录 ")])],1)],2)],1)])],1)]],2)},Ms=[],Rs={name:"UserProfile",components:{SchoolCard:ye,JudgeCompetitionCard:kt},data(){return{userInfo:{name:"",head:"",powerDegree:[],joinedSportMeetings:[],smId:null,judgeEvents:[],mySports:[]},defaultAvatar:"/default-avatar.jpg",activeTab:"schools",isLoggedIn:!!localStorage.getItem("token"),currentSmId:null,allMeetings:[],allMeetingsLoaded:!1,mySchools:[],activeSchoolId:null,schoolLoading:!1,activeEventId:null,availableSports:[],configForm:{maxPlayers:7,maxEvents:3,levelConfig:[]}}},computed:{userRoles(){if(!this.isLoggedIn)return[{id:"guest",label:"访客",type:"info"}];const e={1:{label:"用户",type:""},2:{label:"团体负责人",type:"success"},3:{label:"裁判",type:"warning"},4:{label:"运动员",type:"info"},5:{label:"运动会操办人",type:"danger"}},t=Array.isArray(this.userInfo.powerDegree)?[...new Set(this.userInfo.powerDegree)]:this.userInfo.powerDegree?[this.userInfo.powerDegree]:[];return t.map((t=>({id:`role_${t}`,...e[t]})))},hasFollowedMeetings(){return this.allMeetingsLoaded&&(this.isLoggedIn?(this.userInfo.joinedSportMeetings||[]).length>0:JSON.parse(localStorage.getItem("smIds")||"[]").length>0)},followedMeetings(){if(!this.allMeetingsLoaded)return[];if(this.isLoggedIn)return this.userInfo.joinedSportMeetings||[];const e=JSON.parse(localStorage.getItem("smIds")||"[]"),t=this.allMeetings.filter((t=>e.includes(t.smId)));return t.map((e=>({smId:e.smId,name:e.name})))},currentMeetingName(){const e=this.followedMeetings.find((e=>e.smId===this.currentSmId));return e?e.name:"未选择运动会"},hasManagePermission(){return this.userInfo.powerDegree?.some((e=>[2,5].includes(e)))},groupedEvents(){const e=this.userInfo.mySports||[],t={};return e.forEach((e=>{t[e.mainSpId]||(t[e.mainSpId]={name:e.name,events:[]}),t[e.mainSpId].events.push(e)})),Object.values(t)},userAvatar(){return this.userInfo.head||null},isSubRoute(){return"/user-profile"!==this.$route.path}},methods:{getEventName(e){return`${e.gender?"男子":"女子"}${e.name}`},getCompTypeTag(e){const t={1:"info",2:"warning",3:"success"};return t[e]||""},getCompTypeText(e){const t={1:"预赛",2:"半决赛",3:"决赛"};return t[e]||"未知"},getStatusTag(e){const t={1:"info",2:"warning",3:"success",4:""};return t[e]||""},getStatusText(e){const t={1:"未开始",2:"报名中",3:"进行中",4:"已结束"};return t[e]||"未知"},handleAvatarClick(){this.isLoggedIn||this.$router.push("/login")},async handleMeetingChange(e){if("more"===e)return this.goToSportMeetings(),void this.$nextTick((()=>{this.currentSmId=this.userInfo.smId}));if(e!==this.userInfo.smId)try{const t=new URLSearchParams;t.append("smId",e);const s=await(0,V.A)({url:"/switchCurrentMeeting",method:"post",data:t});1===s.code&&((0,ws.YQ)(s.data[0],s.data[1]),await this.fetchUserInfo(),this.$message.success("切换成功"),this.updateMySchools())}catch(t){console.error("切换运动会失败:",t),this.$message.error("切换运动会失败"),this.$nextTick((()=>{this.currentSmId=this.userInfo.smId}))}},async fetchUserInfo(){if(this.isLoggedIn)try{const e=await(0,V.A)({url:"/getUserInfo",method:"get"});if(1===e.code){const t={...e.data,powerDegree:e.data.powerDegree||[],joinedSportMeetings:e.data.joinedSportMeetings||[],smId:e.data.smId,judgeEvents:e.data.judgeEvents||[],mySports:e.data.mySports||[]};this.userInfo={name:"",head:"",powerDegree:[],joinedSportMeetings:[],smId:null,judgeEvents:[],mySports:[],...t},this.currentSmId=e.data.smId,this.updateMySchools()}}catch(e){console.error("获取用户信息失败:",e),this.$message.error("获取用户信息失败")}},getMeetingName(e){const t=this.allMeetings.find((t=>t.smId===e));return t?t.name:""},async fetchMeetings(){try{const e=await(0,V.A)({url:"/getSportMeetings",method:"get"});if(1===e.code)if(this.allMeetings=e.data,this.allMeetingsLoaded=!0,this.isLoggedIn)await this.fetchUserInfo();else{const e=localStorage.getItem("currentSmId");if(e){const t=Number(e),s=JSON.parse(localStorage.getItem("smIds")||"[]");s.includes(t)&&(this.currentSmId=t)}}}catch(e){console.error("获取运动会列表失败:",e),this.$message.error("获取运动会列表失败")}},updateMySchools(){const e=this.currentSmId;e&&this.userInfo.joinedSchools?this.mySchools=this.userInfo.joinedSchools.filter((t=>t.smId===e)):this.mySchools=[]},formatEventData(e){const t=e.events[e.events.length-1];return{id:e.events[0].mainSpId,name:e.name,currentEvent:{type:t.compType,status:t.status,phase:this.getPhaseText(t.compType),compTime:[t.compStartTime,t.compEndTime],players:[{id:this.userInfo.pid,name:this.userInfo.name,avatar:this.userInfo.head,number:"未分配",class:"未知",score:t.score,points:t.points}]}}},getPhaseText(e){const t={1:"预赛",2:"半决赛",3:"决赛"};return t[e]||"未知阶段"},toggleSchool(e){this.activeSchoolId=this.activeSchoolId===e?null:e},toggleEvent(e){this.activeEventId=this.activeEventId===e?null:e},async fetchAvailableSports(){if(this.isLoggedIn)try{const e=await(0,V.A)({url:"/getAvailableSports",method:"get"});1===e.code&&(this.availableSports=e.data.map((e=>({spId:e.spId,name:e.name,gender:e.gender,status:e.status,compType:e.compType,mainSpId:e.mainSpId}))))}catch(e){console.error("获取运动项目列表失败:",e),this.$message.error("获取运动项目列表失败")}},async fetchConfig(){if(this.isLoggedIn)try{const e=await(0,V.A)({url:"/getDepartmentConfig",method:"get"});if(1===e.code){const t=e.data,s=JSON.parse(t.levelConfig).map((e=>{if(e.isNumeric){const t=e.valueRange.find((e=>"digits"===e[0]));return{...e,digits:t?t[1]:2,valuePairs:[],isExpanded:!1}}return{...e,valuePairs:e.valueRange.map((([e,t])=>({label:e,value:t}))),isExpanded:!1}}));this.configForm={maxPlayers:t.maxPlayers,maxEvents:t.maxEvents,levelConfig:s}}}catch(e){console.error("获取配置失败:",e),this.$message.error("获取配置失败")}},handleLogout(){this.$confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{localStorage.removeItem("userInfo"),localStorage.removeItem("token"),localStorage.removeItem("expireTime"),this.userInfo={name:"",head:"",powerDegree:[],joinedSportMeetings:[],smId:null,judgeEvents:[],mySports:[]},this.isLoggedIn=!1,this.$message.success("已退出登录"),this.$router.push("/login")})).catch((()=>{}))},goToSportMeetings(){this.$router.push("sport-meetings"),this.$nextTick((()=>{this.currentSmId=this.userInfo.smId}))}},watch:{currentSmId:{immediate:!1,handler(e,t){e!==t&&"more"!==e&&this.updateMySchools()}}},async mounted(){await this.fetchConfig(),await this.fetchAvailableSports(),this.fetchMeetings()}},Ns=Rs,Ls=(0,d.A)(Ns,As,Ms,!1,null,"d7d3976a",null),Os=Ls.exports;i["default"].use(D.A);const Vs=[{path:"/",name:"Home",component:()=>s.e(855).then(s.bind(s,3855))},{path:"/login",name:"LoginRegister",component:Ds,meta:{noNav:!0}},{path:"/login-register",redirect:e=>({path:"/login",query:e.query})},{path:"/department-management",component:Ce},{path:"/sports-management",component:nt},{path:"/judge-management",component:jt},{path:"/registration-record",component:Yt},{path:"/check-center",component:()=>s.e(648).then(s.bind(s,648))},{path:"/ai-judge/:spId",name:"AiJudge",component:()=>s.e(762).then(s.bind(s,762)),props:!0,meta:{title:"智能评分",requireJudgeOrAdmin:!0}},{path:"/ai-web",name:"AiWeb",component:()=>s.e(804).then(s.bind(s,9804))},{path:"/schedule-management",component:as},{path:"/system-settings",component:vs},{path:"/sport-meetings",name:"SportMeetings",component:()=>s.e(55).then(s.bind(s,6436))},{path:"/sport-meetings/:id",name:"SportMeetingDetail",component:()=>s.e(996).then(s.bind(s,5996)),props:e=>({fromList:!!e.params.fromList,initialData:e.params.initialData||{}})},{path:"/sport-meetings/:id/settings",name:"SportMeetingSettings",component:Ps,props:!0},{path:"/staff-settings",component:Ps},{path:"/user-profile",name:"UserProfile",component:Os,children:[{path:"sport-meetings",name:"UserSportMeetings",component:()=>s.e(55).then(s.bind(s,6436))}]},{path:"/create-meeting",name:"CreateMeeting",component:()=>s.e(809).then(s.bind(s,2809)),meta:{noNav:!0}}],Gs=new D.A({mode:"history",base:"/",routes:Vs});Gs.beforeEach(((e,t,s)=>{const i=JSON.parse(localStorage.getItem("userInfo")||"{}"),a=e.matched.some((e=>e.meta.requiresAuth));a&&!i.token?s("/login"):"/login"===e.path&&i.token?s("/"):s()})),Gs.onError((e=>{console.error("路由错误:",e),"NavigationDuplicated"!==e.name&&e.message.includes("Avoided redundant navigation")}));const zs=D.A.prototype.push;D.A.prototype.push=function(e){return zs.call(this,e).catch((e=>{if("NavigationDuplicated"!==e.name&&"NavigationAborted"!==e.name)throw e;return Promise.resolve(!1)}))};var Us=Gs,js=s(1052),Js=s.n(js),qs=s(5672),Bs=s.n(qs),Ws={bind(e,t){e.clickOutsideEvent=s=>{e===s.target||e.contains(s.target)||t.value(s)},document.addEventListener("click",e.clickOutsideEvent)},unbind(e){document.removeEventListener("click",e.clickOutsideEvent)}};i["default"].use(Bs()),i["default"].use(Js()),i["default"].directive("click-outside",Ws),i["default"].config.productionTip=!1,new i["default"]({render:e=>e(T),router:Us}).$mount("#app")},9417:function(e,t,s){s.d(t,{A:function(){return c}});var i=function(){var e=this,t=e._self._c;return t("el-upload",{staticClass:"avatar-uploader",attrs:{action:"#","show-file-list":!1,"on-change":e.handlePreview,"before-remove":e.handleRemove,"auto-upload":!1,accept:"image/*"}},[e.imageUrl?t("div",{staticClass:"preview-wrapper"},[t("img",{staticClass:"preview-image",attrs:{src:e.imageUrl}}),t("div",{staticClass:"preview-mask"},[t("i",{staticClass:"el-icon-zoom-in"}),t("i",{staticClass:"el-icon-delete",on:{click:function(t){return t.stopPropagation(),e.clearPreview.apply(null,arguments)}}})])]):t("i",{staticClass:"el-icon-plus avatar-uploader-icon"})])},a=[],r=(s(4603),s(7566),s(8721),{props:{imageUrl:{type:String,default:""}},methods:{handlePreview(e){const t=URL.createObjectURL(e.raw);this.$emit("update:imageUrl",t),this.$emit("update:file",e.raw),this.$once("hook:beforeDestroy",(()=>{URL.revokeObjectURL(t)}))},clearPreview(){URL.revokeObjectURL(this.imageUrl),this.$emit("update:imageUrl",""),this.$emit("update:file",null)},handleRemove(){return this.$confirm("确定移除该图片？","提示",{type:"warning"})}}}),n=r,o=s(1656),l=(0,o.A)(n,i,a,!1,null,"61715978",null),c=l.exports},9586:function(e,t,s){s.d(t,{y:function(){return a},z:function(){return i}});s(8111),s(1701);function i(e){if(!e)return"";let t="";null!==e.gender&&(t=e.gender?"男子":"女子");const s={1:"(预赛)",2:"(半决赛)",3:"(决赛)"}[e.compType]||"";return`${t}${e.name||e.eventName}${s}`}function a(e){if(!e)return"暂无成绩";if("string"===typeof e)try{const t=e.replace(/[{}]/g,"").split(",");return t.map((e=>{const[t,s]=e.split("=");return`${s}${t}`})).join("")}catch(t){return console.error("分数格式化失败:",t),"格式错误"}return Object.entries(e).map((([e,t])=>`${t}${e}`)).join("")}},9947:function(e,t,s){s.d(t,{A:function(){return c}});var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"filter-dropdown",class:{"is-active":e.isOpen,"has-value":e.hasSelected}},[t("div",{staticClass:"filter-trigger",on:{click:e.toggleDropdown}},[e.hideLabel?e._e():t("span",{staticClass:"label"},[e._v(e._s(e.label)+": ")]),t("span",{staticClass:"value",class:{"no-label":e.hideLabel}},[e._v(e._s(e.selectedLabel))]),t("i",{staticClass:"el-icon-arrow-down",class:{"is-reverse":e.isOpen}})]),t("transition",{attrs:{name:"dropdown"}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.isOpen,expression:"isOpen"}],staticClass:"filter-options"},e._l(e.options,(function(s){return t("div",{key:s.value,staticClass:"option-item",class:{"is-selected":s.value===e.value},on:{click:function(t){return e.handleSelect(s.value)}}},[e._v(" "+e._s(s.label)+" ")])})),0)])],1)},a=[],r=(s(8111),s(116),{name:"FilterDropdown",props:{value:{type:[String,Number],required:!0},options:{type:Array,required:!0},label:{type:String,required:!0},defaultValue:{type:[String,Number],default:null},hideLabel:{type:Boolean,default:!1}},data(){return{isOpen:!1,localValue:this.value}},computed:{selectedLabel(){const e=this.options.find((e=>e.value===this.value));return e?e.label:"全部"},hasSelected(){return"all"!==this.value&&"none"!==this.value}},methods:{toggleDropdown(){this.isOpen=!this.isOpen},handleSelect(e){this.$emit("input",e),this.$emit("change",e),this.isOpen=!1},handleClickOutside(e){this.$el.contains(e.target)||(this.isOpen=!1)}},created(){this.defaultValue&&!this.value&&(this.$emit("input",this.defaultValue),this.$emit("change",this.defaultValue))},watch:{value(e){this.localValue=e}},mounted(){document.addEventListener("click",this.handleClickOutside)},beforeDestroy(){document.removeEventListener("click",this.handleClickOutside)}}),n=r,o=s(1656),l=(0,o.A)(n,i,a,!1,null,"19983472",null),c=l.exports}},t={};function s(i){var a=t[i];if(void 0!==a)return a.exports;var r=t[i]={id:i,loaded:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.loaded=!0,r.exports}s.m=e,function(){s.amdO={}}(),function(){var e=[];s.O=function(t,i,a,r){if(!i){var n=1/0;for(d=0;d<e.length;d++){i=e[d][0],a=e[d][1],r=e[d][2];for(var o=!0,l=0;l<i.length;l++)(!1&r||n>=r)&&Object.keys(s.O).every((function(e){return s.O[e](i[l])}))?i.splice(l--,1):(o=!1,r<n&&(n=r));if(o){e.splice(d--,1);var c=a();void 0!==c&&(t=c)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[i,a,r]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){s.f={},s.e=function(e){return Promise.all(Object.keys(s.f).reduce((function(t,i){return s.f[i](e,t),t}),[]))}}(),function(){s.u=function(e){return"js/"+e+"."+{55:"b3d5b2cf",648:"1a5a13a6",762:"d93fe022",804:"152fd6de",809:"18eea420",855:"09c86d8f",996:"48ee0549"}[e]+".js"}}(),function(){s.miniCssF=function(e){return"css/"+e+"."+{55:"497020b0",648:"477dbd72",762:"e442b33a",804:"3e77cea0",809:"c050185d",855:"abb449a5",996:"05bb2072"}[e]+".css"}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={},t="champation-management-system:";s.l=function(i,a,r,n){if(e[i])e[i].push(a);else{var o,l;if(void 0!==r)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var u=c[d];if(u.getAttribute("src")==i||u.getAttribute("data-webpack")==t+r){o=u;break}}o||(l=!0,o=document.createElement("script"),o.charset="utf-8",o.timeout=120,s.nc&&o.setAttribute("nonce",s.nc),o.setAttribute("data-webpack",t+r),o.src=i),e[i]=[a];var p=function(t,s){o.onerror=o.onload=null,clearTimeout(m);var a=e[i];if(delete e[i],o.parentNode&&o.parentNode.removeChild(o),a&&a.forEach((function(e){return e(s)})),t)return t(s)},m=setTimeout(p.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=p.bind(null,o.onerror),o.onload=p.bind(null,o.onload),l&&document.head.appendChild(o)}}}(),function(){s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){s.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){s.p="/"}(),function(){if("undefined"!==typeof document){var e=function(e,t,i,a,r){var n=document.createElement("link");n.rel="stylesheet",n.type="text/css",s.nc&&(n.nonce=s.nc);var o=function(s){if(n.onerror=n.onload=null,"load"===s.type)a();else{var i=s&&s.type,o=s&&s.target&&s.target.href||t,l=new Error("Loading CSS chunk "+e+" failed.\n("+i+": "+o+")");l.name="ChunkLoadError",l.code="CSS_CHUNK_LOAD_FAILED",l.type=i,l.request=o,n.parentNode&&n.parentNode.removeChild(n),r(l)}};return n.onerror=n.onload=o,n.href=t,i?i.parentNode.insertBefore(n,i.nextSibling):document.head.appendChild(n),n},t=function(e,t){for(var s=document.getElementsByTagName("link"),i=0;i<s.length;i++){var a=s[i],r=a.getAttribute("data-href")||a.getAttribute("href");if("stylesheet"===a.rel&&(r===e||r===t))return a}var n=document.getElementsByTagName("style");for(i=0;i<n.length;i++){a=n[i],r=a.getAttribute("data-href");if(r===e||r===t)return a}},i=function(i){return new Promise((function(a,r){var n=s.miniCssF(i),o=s.p+n;if(t(n,o))return a();e(i,o,null,a,r)}))},a={524:0};s.f.miniCss=function(e,t){var s={55:1,648:1,762:1,804:1,809:1,855:1,996:1};a[e]?t.push(a[e]):0!==a[e]&&s[e]&&t.push(a[e]=i(e).then((function(){a[e]=0}),(function(t){throw delete a[e],t})))}}}(),function(){var e={524:0};s.f.j=function(t,i){var a=s.o(e,t)?e[t]:void 0;if(0!==a)if(a)i.push(a[2]);else{var r=new Promise((function(s,i){a=e[t]=[s,i]}));i.push(a[2]=r);var n=s.p+s.u(t),o=new Error,l=function(i){if(s.o(e,t)&&(a=e[t],0!==a&&(e[t]=void 0),a)){var r=i&&("load"===i.type?"missing":i.type),n=i&&i.target&&i.target.src;o.message="Loading chunk "+t+" failed.\n("+r+": "+n+")",o.name="ChunkLoadError",o.type=r,o.request=n,a[1](o)}};s.l(n,l,"chunk-"+t,t)}},s.O.j=function(t){return 0===e[t]};var t=function(t,i){var a,r,n=i[0],o=i[1],l=i[2],c=0;if(n.some((function(t){return 0!==e[t]}))){for(a in o)s.o(o,a)&&(s.m[a]=o[a]);if(l)var d=l(s)}for(t&&t(i);c<n.length;c++)r=n[c],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(d)},i=self["webpackChunkchampation_management_system"]=self["webpackChunkchampation_management_system"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=s.O(void 0,[504],(function(){return s(8778)}));i=s.O(i)})();
//# sourceMappingURL=app.56e65c91.js.map